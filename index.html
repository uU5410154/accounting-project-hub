<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Accounting Tech Project Hub</title>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Outfit', sans-serif; background: #0F172A; color: #E2E8F0; min-height: 100vh; }
    
    /* Login Page */
    .login-page { min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 20px; background: linear-gradient(135deg, #0F172A 0%, #1E293B 100%); }
    .login-container { width: 100%; max-width: 400px; background: #1E293B; border-radius: 20px; padding: 40px 32px; border: 1px solid #334155; box-shadow: 0 20px 60px rgba(0,0,0,0.4); }
    .login-logo { text-align: center; margin-bottom: 32px; }
    .login-logo-icon { font-size: 48px; color: #38BDF8; display: block; margin-bottom: 12px; }
    .login-logo-title { font-size: 28px; font-weight: 700; color: #F1F5F9; }
    .login-logo-subtitle { font-size: 14px; color: #64748B; margin-top: 4px; }
    .login-form { display: flex; flex-direction: column; gap: 20px; }
    .login-input-group { position: relative; }
    .login-input-icon { position: absolute; left: 16px; top: 50%; transform: translateY(-50%); font-size: 18px; color: #64748B; }
    .login-input { width: 100%; padding: 14px 16px 14px 48px; background: #0F172A; border: 2px solid #334155; border-radius: 12px; font-size: 15px; color: #F1F5F9; outline: none; font-family: inherit; transition: border-color 0.2s; }
    .login-input:focus { border-color: #38BDF8; }
    .login-input::placeholder { color: #64748B; }
    .login-btn { width: 100%; padding: 14px; background: #38BDF8; border: none; border-radius: 12px; font-size: 16px; font-weight: 600; color: #0F172A; cursor: pointer; font-family: inherit; transition: all 0.2s; }
    .login-btn:hover { background: #7DD3FC; transform: translateY(-2px); }
    .login-btn:active { transform: translateY(0); }
    .login-error { background: #FEE2E2; color: #DC2626; padding: 12px 16px; border-radius: 10px; font-size: 13px; text-align: center; display: none; }
    .login-error.show { display: block; }
    .login-hint { text-align: center; margin-top: 20px; padding-top: 20px; border-top: 1px solid #334155; }
    .login-hint-text { font-size: 12px; color: #64748B; }
    
    /* User Badge */
    .user-badge { display: flex; align-items: center; gap: 8px; padding: 6px 12px; background: #334155; border-radius: 20px; font-size: 12px; }
    .user-badge-icon { font-size: 16px; }
    .user-badge-name { font-weight: 500; }
    .user-badge-role { color: #38BDF8; font-size: 10px; text-transform: uppercase; }
    .logout-btn { padding: 6px 12px; background: #EF4444; border: none; border-radius: 6px; color: white; font-size: 11px; cursor: pointer; font-family: inherit; }
    .logout-btn:hover { background: #F87171; }
    
    /* Lock Icon */
    .lock-icon { font-size: 12px; margin-left: 4px; color: #F59E0B; }
    .lock-btn { background: #F59E0B !important; }
    .lock-btn:hover { background: #FBBF24 !important; }
    
    /* Sync Status */
    .sync-status { display: flex; align-items: center; gap: 4px; padding: 4px 10px; background: #334155; border-radius: 12px; font-size: 11px; }
    .sync-icon { font-size: 14px; }
    .sync-text { color: #94A3B8; }
    .sync-status.synced { background: #064E3B; }
    .sync-status.synced .sync-text { color: #6EE7B7; }
    .sync-status.syncing { background: #1E3A5F; }
    .sync-status.syncing .sync-icon { animation: spin 1s linear infinite; }
    .sync-status.error { background: #7F1D1D; }
    .sync-status.error .sync-text { color: #FCA5A5; }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    
    /* Success Button */
    .btn-success { background: #10B981 !important; color: white !important; }
    .btn-success:hover { background: #059669 !important; }
    
    /* Config Modal */
    .config-section { background: #0F172A; padding: 16px; border-radius: 12px; margin-bottom: 16px; }
    .config-label { font-size: 12px; color: #64748B; margin-bottom: 8px; display: block; }
    .config-input { width: 100%; padding: 10px 12px; background: #1E293B; border: 1px solid #334155; border-radius: 8px; color: #F1F5F9; font-size: 13px; font-family: monospace; }
    .config-hint { font-size: 11px; color: #64748B; margin-top: 8px; line-height: 1.5; }
    
    /* Navigation */
    .nav { display: flex; align-items: center; justify-content: space-between; padding: 12px 20px; background: #1E293B; border-bottom: 1px solid #334155; position: sticky; top: 0; z-index: 100; flex-wrap: wrap; gap: 10px; }
    .nav-brand { display: flex; align-items: center; gap: 8px; }
    .nav-logo { font-size: 24px; color: #38BDF8; }
    .nav-title { font-size: 18px; font-weight: 600; }
    .nav-links { display: flex; gap: 6px; }
    .nav-link { padding: 8px 14px; background: transparent; border: none; color: #94A3B8; font-size: 13px; font-weight: 500; cursor: pointer; border-radius: 8px; font-family: inherit; text-decoration: none; display: inline-flex; align-items: center; }
    .nav-link:hover { background: #334155; }
    .nav-link.active { background: #334155; color: #F1F5F9; }
    .nav-link.tickets-btn { background: #FACC15; color: #0F172A; font-weight: 600; }
    .nav-link.tickets-btn:hover { background: #FDE047; transform: scale(1.05); }
    .nav-actions { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    .nav-date { font-size: 12px; color: #64748B; display: none; }
    
    /* Main */
    .main { padding: 16px; max-width: 1600px; margin: 0 auto; }
    
    /* Section */
    .section { background: #1E293B; border-radius: 12px; padding: 16px; border: 1px solid #334155; margin-bottom: 16px; }
    .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; flex-wrap: wrap; gap: 10px; }
    .section-title { font-size: 16px; font-weight: 600; color: #F1F5F9; display: flex; align-items: center; gap: 8px; }
    
    /* Buttons */
    .btn { padding: 8px 16px; border: none; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; font-family: inherit; transition: all 0.2s; display: inline-flex; align-items: center; gap: 6px; }
    .btn-primary { background: #38BDF8; color: #0F172A; }
    .btn-primary:hover { background: #7DD3FC; }
    .btn-secondary { background: #334155; color: #E2E8F0; }
    .btn-secondary:hover { background: #475569; }
    .btn-danger { background: #EF4444; color: white; }
    .btn-sm { padding: 6px 10px; font-size: 12px; }
    .btn-icon { width: 32px; height: 32px; padding: 0; display: flex; align-items: center; justify-content: center; font-size: 14px; border-radius: 6px; }
    
    /* Summary Cards */
    .summary-cards { display: flex; gap: 12px; overflow-x: auto; padding-bottom: 8px; -webkit-overflow-scrolling: touch; flex-wrap: wrap; }
    .summary-card { min-width: 100px; padding: 16px; background: #334155; border-radius: 10px; text-align: center; flex-shrink: 0; }
    .summary-card.total { background: #38BDF8; color: #0F172A; }
    .summary-hours { font-size: 24px; font-weight: 700; margin-bottom: 2px; }
    .summary-name { font-size: 11px; opacity: 0.8; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    
    /* Project Pool */
    .pool { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 12px; min-height: 80px; padding: 12px; border: 2px dashed transparent; border-radius: 12px; transition: all 0.2s; }
    .pool.drag-over { border-color: #38BDF8; background: rgba(56, 189, 248, 0.1); }
    .pool-empty { grid-column: 1 / -1; text-align: center; color: #64748B; padding: 30px; background: #0F172A; border-radius: 10px; border: 2px dashed #334155; }
    .pool-project { padding: 16px; background: #334155; border-radius: 10px; cursor: grab; border: 2px solid transparent; transition: all 0.2s; }
    .pool-project:hover { border-color: #38BDF8; transform: translateY(-2px); }
    .pool-project:active { transform: scale(0.98); cursor: grabbing; }
    .pool-project.dragging { opacity: 0.5; transform: scale(0.95); }
    .pool-project-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; gap: 8px; }
    .pool-project-name { font-weight: 600; font-size: 15px; flex: 1; cursor: pointer; }
    .pool-project-name:hover { color: #38BDF8; }
    .pool-project-desc { font-size: 13px; color: #94A3B8; line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; cursor: pointer; }
    .pool-project-desc:hover { color: #CBD5E1; }
    .pool-project-meta { display: flex; gap: 8px; margin-top: 12px; flex-wrap: wrap; }
    .pool-project-date { font-size: 11px; color: #64748B; background: #1E293B; padding: 4px 8px; border-radius: 6px; }
    
    /* Priority Badge */
    .priority { padding: 4px 8px; border-radius: 10px; font-size: 10px; font-weight: 600; text-transform: uppercase; white-space: nowrap; }
    .priority-high { background: #FEE2E2; color: #DC2626; }
    .priority-medium { background: #FEF3C7; color: #D97706; }
    .priority-low { background: #DCFCE7; color: #16A34A; }
    
    /* Team Boards */
    .boards { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 16px; }
    .board { background: #1E293B; border-radius: 12px; padding: 16px; border: 2px solid #334155; border-top-width: 4px; transition: all 0.2s; }
    .board.current-user-board { background: linear-gradient(135deg, #1E293B 0%, #0F172A 100%); border-width: 3px; }
    .board.current-user-board .board-name { color: #38BDF8; }
    .board.drag-over { border-color: #38BDF8; background: #1E3A5F; box-shadow: 0 0 20px rgba(56, 189, 248, 0.3); }
    .board-dropzone { min-height: 60px; border: 2px dashed #475569; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: #64748B; font-size: 12px; margin-top: 12px; transition: all 0.2s; }
    .board-dropzone.drag-over { border-color: #38BDF8; background: rgba(56, 189, 248, 0.1); color: #38BDF8; }
    
    /* Today line */
    .gantt-today-line { position: absolute; top: 0; bottom: 0; width: 2px; background: #EF4444; z-index: 5; pointer-events: none; }
    .gantt-today-line::before { content: ''; position: absolute; top: 0; left: -4px; width: 10px; height: 10px; background: #EF4444; border-radius: 50%; }
    
    /* Portfolio gantt */
    .portfolio-gantt { background: #1E293B; border-radius: 12px; overflow: hidden; }
    .portfolio-project-column { min-width: 200px; max-width: 200px; flex-shrink: 0; position: sticky; left: 0; z-index: 20; background: #1E293B; }
    .portfolio-timeline-column { flex: 1; overflow-x: visible; }
    .portfolio-header-cell { padding: 12px; font-weight: 600; font-size: 12px; color: #94A3B8; border-bottom: 1px solid #334155; border-right: 1px solid #334155; background: #1E293B; height: 72px; box-sizing: border-box; display: flex; align-items: center; justify-content: center; }
    .portfolio-body-rows { }
    .portfolio-row { display: flex; align-items: center; border-bottom: 1px solid #334155; height: 36px; min-height: 36px; box-sizing: border-box; }
    .portfolio-row:last-child { border-bottom: none; }
    .portfolio-row.portfolio-role-row { height: 36px; min-height: 36px; background: #1a2235; }
    .portfolio-project-group { }
    .portfolio-project-group:last-child { }
    .portfolio-project-name { min-width: 200px; max-width: 200px; padding: 8px 12px; font-size: 12px; font-weight: 500; cursor: pointer; display: flex; align-items: center; border-right: 1px solid #334155; border-bottom: 1px solid #334155; background: #1E293B; position: sticky; left: 0; z-index: 10; height: 36px; box-sizing: border-box; }
    .portfolio-project-name:hover { color: #38BDF8; background: #334155; }
    .portfolio-saving-row { cursor: pointer; transition: background 0.15s; }
    .portfolio-saving-row:hover { background: rgba(56,189,248,0.08) !important; }
    .portfolio-role-name { min-width: 200px; max-width: 200px; padding: 4px 12px 4px 20px; font-size: 11px; display: flex; align-items: center; border-right: 1px solid #334155; border-bottom: 1px solid #334155; background: #1a2235; position: sticky; left: 0; z-index: 10; height: 36px; box-sizing: border-box; }
    .portfolio-bar-container { flex: 1; position: relative; height: 36px; display: flex; align-items: center; }
    .portfolio-bar { position: absolute; height: 22px; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 10px; color: white; font-weight: 500; cursor: pointer; transition: all 0.2s; min-width: 40px; top: 50%; transform: translateY(-50%); }
    .portfolio-bar:hover { filter: brightness(1.1); z-index: 5; }
    .portfolio-bar.portfolio-role-bar { height: 18px; font-size: 9px; border-radius: 4px; }
    .portfolio-bar.portfolio-role-bar:hover { filter: brightness(1.1); }
    .board-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
    .board-member { display: flex; align-items: center; gap: 10px; flex: 1; }
    .board-avatar { width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 18px; }
    .board-name { font-weight: 600; font-size: 14px; }
    .board-role { font-size: 12px; color: #64748B; }
    .board-count { font-size: 12px; color: #64748B; margin-bottom: 12px; padding-bottom: 10px; border-bottom: 1px solid #334155; }
    .board-empty { text-align: center; padding: 30px 16px; color: #64748B; border: 2px dashed #334155; border-radius: 8px; font-size: 13px; }
    .board-actions { display: flex; gap: 4px; }
    
    /* Project List in Board */
    .board-projects { display: flex; flex-direction: column; gap: 8px; }
    .board-project-item { padding: 12px; background: #0F172A; border-radius: 8px; cursor: pointer; transition: all 0.2s; border-left: 3px solid transparent; }
    .board-project-item:hover { background: #334155; transform: translateX(2px); }
    .board-project-item:active { transform: scale(0.98); cursor: grabbing; }
    .board-project-item.dragging { opacity: 0.5; }
    .board-project-header { display: flex; justify-content: space-between; align-items: flex-start; gap: 8px; margin-bottom: 6px; }
    .board-project-name { font-weight: 500; font-size: 13px; flex: 1; cursor: pointer; }
    .board-project-name:hover { color: #38BDF8; text-decoration: underline; }
    .board-project-meta { display: flex; gap: 6px; flex-wrap: wrap; align-items: center; }
    .board-project-status { font-size: 10px; color: #64748B; background: #1E293B; padding: 2px 6px; border-radius: 4px; }
    .board-project-role { font-size: 9px; font-weight: 600; color: white; background: #6366F1; padding: 2px 6px; border-radius: 4px; text-transform: uppercase; }
    .board-project-role.role-pm { background: #8B5CF6; }
    .board-project-role.role-dev { background: #EF4444; }
    .board-project-role.role-qa { background: #F59E0B; }
    .board-project-role.role-support { background: #06B6D4; }
    .board-project-role.role-lead { background: #3B82F6; }
    
    /* Modal */
    .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); display: flex; align-items: flex-start; justify-content: center; z-index: 1000; padding: 20px; overflow-y: auto; }
    .modal { background: #1E293B; border-radius: 16px; width: 100%; max-width: 700px; border: 1px solid #334155; overflow: hidden; margin: auto; }
    .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 16px 20px; border-bottom: 1px solid #334155; position: sticky; top: 0; background: #1E293B; z-index: 10; }
    .modal-title { font-size: 16px; font-weight: 600; }
    .modal-close { width: 32px; height: 32px; border-radius: 8px; border: none; background: #334155; color: #94A3B8; font-size: 18px; cursor: pointer; }
    .modal-body { padding: 20px; max-height: 70vh; overflow-y: auto; }
    .modal-footer { padding: 16px 20px; border-top: 1px solid #334155; display: flex; gap: 10px; justify-content: flex-end; flex-wrap: wrap; }
    
    /* Form */
    .form-group { margin-bottom: 16px; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .form-label { display: block; margin-bottom: 6px; font-size: 13px; font-weight: 500; color: #94A3B8; }
    .form-input { width: 100%; padding: 10px 14px; background: #0F172A; border: 1px solid #334155; border-radius: 8px; font-size: 14px; color: #F1F5F9; outline: none; font-family: inherit; }
    .form-input:focus { border-color: #38BDF8; }
    .form-select { width: 100%; padding: 10px 14px; background: #0F172A; border: 1px solid #334155; border-radius: 8px; font-size: 14px; color: #F1F5F9; outline: none; font-family: inherit; }
    .form-textarea { width: 100%; padding: 10px 14px; background: #0F172A; border: 1px solid #334155; border-radius: 8px; font-size: 14px; color: #F1F5F9; outline: none; font-family: inherit; resize: vertical; min-height: 80px; }
    
    /* Rich Content Editor */
    .brief-section { margin-top: 20px; padding-top: 20px; border-top: 1px solid #334155; }
    .brief-section-title { font-size: 14px; font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
    .brief-editor { background: #0F172A; border: 1px solid #334155; border-radius: 10px; overflow: hidden; }
    .brief-toolbar { display: flex; gap: 4px; padding: 8px; border-bottom: 1px solid #334155; flex-wrap: wrap; background: #1E293B; }
    .brief-toolbar-btn { width: 32px; height: 32px; border: none; background: #334155; color: #94A3B8; border-radius: 6px; cursor: pointer; font-size: 14px; display: flex; align-items: center; justify-content: center; }
    .brief-toolbar-btn:hover { background: #475569; color: #F1F5F9; }
    .brief-toolbar-btn.active { background: #38BDF8; color: #0F172A; }
    .brief-content { min-height: 200px; padding: 16px; outline: none; font-size: 14px; line-height: 1.6; color: #E2E8F0; }
    .brief-content:empty::before { content: attr(data-placeholder); color: #64748B; }
    .brief-content img { max-width: 100%; border-radius: 8px; margin: 8px 0; }
    .brief-content a { color: #38BDF8; text-decoration: underline; }
    .brief-content ul, .brief-content ol { margin-left: 20px; margin-bottom: 8px; }
    .brief-content h3 { font-size: 16px; margin: 16px 0 8px 0; }
    .brief-content p { margin-bottom: 8px; }
    
    /* Brief View Mode */
    .brief-view { background: #0F172A; border-radius: 10px; padding: 20px; min-height: 100px; }
    .brief-view img { max-width: 100%; border-radius: 8px; margin: 8px 0; }
    .brief-view a { color: #38BDF8; }
    .brief-view:empty::before { content: 'No brief content yet. Click Edit to add details.'; color: #64748B; font-style: italic; }
    
    /* Image Upload */
    .image-upload-area { border: 2px dashed #334155; border-radius: 8px; padding: 20px; text-align: center; color: #64748B; cursor: pointer; margin-top: 12px; transition: all 0.2s; }
    .image-upload-area:hover { border-color: #38BDF8; background: rgba(56, 189, 248, 0.1); }
    .image-upload-area.dragover { border-color: #38BDF8; background: rgba(56, 189, 248, 0.2); }
    
    /* Project Detail View */
    .detail-header { margin-bottom: 24px; }
    .back-btn { padding: 8px 14px; background: #334155; border: none; border-radius: 8px; color: #94A3B8; font-size: 13px; cursor: pointer; margin-bottom: 16px; font-family: inherit; }
    .detail-title { display: flex; align-items: center; gap: 12px; margin-bottom: 10px; flex-wrap: wrap; }
    .detail-name { font-size: 22px; font-weight: 700; }
    .status-badge { padding: 6px 12px; background: #334155; border-radius: 16px; font-size: 11px; font-weight: 500; cursor: pointer; transition: all 0.2s; }
    .status-badge:hover { background: #475569; transform: scale(1.05); }
    .detail-desc { font-size: 14px; color: #94A3B8; line-height: 1.5; }
    .detail-actions { display: flex; gap: 10px; margin-top: 16px; flex-wrap: wrap; }
    
    /* Tabs */
    .tabs { display: flex; gap: 6px; margin-bottom: 20px; overflow-x: auto; padding-bottom: 8px; border-bottom: 1px solid #334155; }
    .tab { padding: 8px 16px; background: transparent; border: none; color: #64748B; font-size: 13px; font-weight: 500; cursor: pointer; border-radius: 8px; font-family: inherit; white-space: nowrap; }
    .tab:hover { background: #334155; }
    .tab.active { background: #38BDF8; color: #0F172A; }
    
    /* Gantt Chart */
    .gantt { background: #0F172A; border-radius: 10px; overflow: hidden; border: 1px solid #334155; }
    .gantt-controls { display: flex; gap: 8px; padding: 12px; background: #1E293B; border-bottom: 1px solid #334155; align-items: center; flex-wrap: wrap; }
    .gantt-scale-btn { padding: 6px 12px; font-size: 11px; background: #334155; border: none; color: #94A3B8; border-radius: 6px; cursor: pointer; transition: all 0.2s; }
    .gantt-scale-btn:hover { background: #475569; }
    .gantt-scale-btn.active { background: #3B82F6; color: white; }
    .gantt-scroll-container { overflow-x: auto; overflow-y: hidden; -webkit-overflow-scrolling: touch; }
    .gantt-wrapper { display: flex; min-width: max-content; }
    .gantt-task-column { min-width: 250px; max-width: 250px; flex-shrink: 0; position: sticky; left: 0; z-index: 20; background: #1E293B; }
    .gantt-pic-column { min-width: 120px; max-width: 120px; flex-shrink: 0; position: sticky; left: 250px; z-index: 19; background: #1E293B; }
    .gantt-pic-cell { min-width: 120px; max-width: 120px; padding: 4px 6px; font-size: 12px; background: #1E293B; border-right: 1px solid #334155; border-bottom: 1px solid #334155; display: flex; align-items: center; justify-content: center; height: 44px; box-sizing: border-box; }
    .gantt-pic-select { width: 100%; padding: 4px 6px; background: #0F172A; border: 1px solid #334155; border-radius: 4px; color: #E2E8F0; font-size: 11px; cursor: pointer; outline: none; }
    .gantt-pic-select:hover { border-color: #38BDF8; }
    .gantt-pic-select:focus { border-color: #38BDF8; }
    .gantt-status-column { min-width: 100px; max-width: 100px; flex-shrink: 0; position: sticky; left: 370px; z-index: 18; background: #1E293B; }
    .gantt-status-cell { min-width: 100px; max-width: 100px; padding: 4px 6px; font-size: 12px; background: #1E293B; border-right: 1px solid #334155; border-bottom: 1px solid #334155; display: flex; align-items: center; justify-content: center; height: 44px; box-sizing: border-box; position: sticky; left: 370px; z-index: 18; }
    .gantt-status-select { width: 100%; padding: 4px 6px; background: #0F172A; border: 1px solid #334155; border-radius: 4px; color: #E2E8F0; font-size: 10px; cursor: pointer; outline: none; }
    .gantt-status-select:hover { border-color: #38BDF8; }
    .gantt-status-select:focus { border-color: #38BDF8; }
    .gantt-status-select option[value="Not Started"] { background: #4B5563; }
    .gantt-status-select option[value="In-Progress"] { background: #1D4ED8; }
    .gantt-status-select option[value="Stuck"] { background: #B91C1C; }
    .gantt-status-select option[value="Finished"] { background: #059669; }
    .gantt-timeline-column { flex: 1; }
    .gantt-header { display: flex; border-bottom: 1px solid #334155; }
    .gantt-header-months { display: flex; border-bottom: 1px solid #334155; background: #0F172A; }
    .gantt-month-label { padding: 4px 8px; text-align: center; font-size: 11px; font-weight: 600; color: #38BDF8; border-right: 1px solid #334155; height: 26px; box-sizing: border-box; display: flex; align-items: center; justify-content: center; }
    .gantt-task-col { padding: 8px 12px; font-weight: 600; font-size: 12px; color: #64748B; background: #1E293B; border-right: 1px solid #334155; border-bottom: 1px solid #334155; display: flex; justify-content: space-between; align-items: center; height: 44px; box-sizing: border-box; }
    .gantt-task-col-spacer { height: 26px; border-right: 1px solid #334155; border-bottom: 1px solid #334155; background: #1E293B; }
    .gantt-timeline { display: flex; }
    .gantt-date { min-width: 36px; padding: 4px 2px; text-align: center; border-right: 1px solid #334155; box-sizing: border-box; height: 44px; display: flex; flex-direction: column; justify-content: center; }
    .gantt-date.weekend { background: rgba(100,116,139,0.15); }
    .gantt-date.today { background: #7F1D1D !important; }
    .gantt-date.today * { color: #FCA5A5 !important; }
    .gantt-date-day { font-size: 11px; font-weight: 600; }
    .gantt-date-month { font-size: 8px; color: #64748B; }
    .gantt-date-week { font-size: 9px; color: #94A3B8; }
    .gantt-body { max-height: 400px; overflow-y: auto; overflow-x: hidden; }
    .gantt-body-rows { }
    .gantt-row { display: flex; border-bottom: 1px solid #334155; min-height: 44px; }
    .gantt-task-name { min-width: 250px; max-width: 250px; padding: 6px 8px; font-size: 12px; font-weight: 500; background: #1E293B; border-right: 1px solid #334155; border-bottom: 1px solid #334155; display: flex; align-items: center; justify-content: space-between; gap: 4px; position: sticky; left: 0; z-index: 10; height: 44px; box-sizing: border-box; }
    .gantt-task-name[draggable="true"] { cursor: grab; }
    .gantt-task-name[draggable="true"]:active { cursor: grabbing; }
    .gantt-task-name.drag-over { background: #334155; border-top: 2px solid #38BDF8; }
    .gantt-task-name.dragging { opacity: 0.5; background: #0F172A; }
    .gantt-task-drag-handle { cursor: grab; padding: 4px; margin-right: 4px; color: #64748B; font-size: 10px; }
    .gantt-task-drag-handle:hover { color: #38BDF8; }
    .gantt-task-text { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex: 1; cursor: default; position: relative; }
    .gantt-task-text:hover { overflow: visible; }
    .gantt-task-text:hover::after { content: attr(data-full-text); position: absolute; left: 0; bottom: 100%; margin-bottom: 8px; background: #0F172A; color: #F1F5F9; padding: 8px 12px; border-radius: 6px; white-space: nowrap; z-index: 9999; box-shadow: 0 4px 12px rgba(0,0,0,0.3); font-size: 12px; border: 1px solid #334155; max-width: 400px; white-space: normal; word-wrap: break-word; }

    /* Subtask styles */
    .subtask-item { display: flex; align-items: center; gap: 8px; padding: 8px; background: #1E293B; border-radius: 6px; margin-bottom: 6px; transition: background 0.2s, transform 0.2s; }
    .subtask-item[draggable="true"] { cursor: grab; }
    .subtask-item[draggable="true"]:active { cursor: grabbing; }
    .subtask-item.dragging { opacity: 0.5; background: #0F172A; }
    .subtask-item.drag-over { background: #334155; border-top: 2px solid #38BDF8; }
    .subtask-item input[type="checkbox"] { width: 16px; height: 16px; cursor: pointer; accent-color: #38BDF8; flex-shrink: 0; }
    .subtask-item .subtask-drag-handle { cursor: grab; color: #64748B; font-size: 12px; padding: 2px 4px; flex-shrink: 0; }
    .subtask-item .subtask-drag-handle:hover { color: #38BDF8; }
    .subtask-item .subtask-name { flex: 1; font-size: 13px; cursor: text; padding: 2px 4px; border-radius: 4px; min-width: 0; word-break: break-word; }
    .subtask-item .subtask-name:hover { background: rgba(255,255,255,0.05); }
    .subtask-item .subtask-name.completed { text-decoration: line-through; color: #64748B; }
    .subtask-item .subtask-name-input { flex: 1; font-size: 13px; padding: 4px 8px; background: #0F172A; border: 1px solid #3B82F6; border-radius: 4px; color: #F1F5F9; outline: none; }
    .subtask-item .subtask-edit { background: none; border: none; color: #3B82F6; cursor: pointer; font-size: 12px; padding: 2px 6px; flex-shrink: 0; }
    .subtask-item .subtask-edit:hover { background: rgba(59,130,246,0.2); border-radius: 4px; }
    .subtask-item .subtask-delete { background: none; border: none; color: #EF4444; cursor: pointer; font-size: 14px; padding: 2px 6px; flex-shrink: 0; }
    .subtask-item .subtask-delete:hover { background: rgba(239,68,68,0.2); border-radius: 4px; }
    .gantt-task-row-wrapper { display: contents; }
    .subtask-expand { cursor: pointer; color: #64748B; font-size: 10px; margin-right: 4px; transition: transform 0.2s; display: inline-block; }
    .subtask-expand.expanded { transform: rotate(90deg); }
    .subtask-inline-list { min-width: 180px; max-width: 180px; padding: 4px 8px 4px 32px; background: #0F172A; border-right: 1px solid #334155; border-bottom: 1px solid #334155; position: sticky; left: 0; z-index: 10; box-sizing: border-box; }
    .subtask-inline-item { display: flex; align-items: center; gap: 6px; padding: 4px 0; font-size: 11px; color: #94A3B8; }
    .subtask-inline-item input[type="checkbox"] { width: 14px; height: 14px; cursor: pointer; accent-color: #38BDF8; }
    .subtask-inline-item .completed { text-decoration: line-through; color: #64748B; }
    .gantt-task-actions { display: flex; gap: 2px; flex-shrink: 0; }
    .gantt-bar-container { flex: 1; position: relative; height: 44px; display: flex; }
    .gantt-bar-cell { min-width: 36px; border-right: 1px solid #334155; box-sizing: border-box; }
    .gantt-bar-cell.weekend { background: rgba(100,116,139,0.15); }
    
    .gantt-bar { 
      position: absolute; 
      top: 50%; 
      transform: translateY(-50%); 
      height: 28px; 
      border-radius: 6px; 
      cursor: move;
      display: flex; 
      align-items: center; 
      justify-content: center;
      padding: 0 6px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2); 
      user-select: none;
      min-width: 36px;
      touch-action: none;
    }
    .gantt-bar:active { box-shadow: 0 4px 12px rgba(0,0,0,0.4); }
    .gantt-bar-label { font-size: 10px; font-weight: 600; color: white; text-shadow: 0 1px 2px rgba(0,0,0,0.3); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .gantt-bar-handle { position: absolute; top: 0; width: 12px; height: 100%; cursor: ew-resize; z-index: 5; }
    .gantt-bar-handle-left { left: 0; border-radius: 6px 0 0 6px; }
    .gantt-bar-handle-right { right: 0; border-radius: 0 6px 6px 0; }
    .gantt-bar-handle:active { background: rgba(255,255,255,0.2); }
    
    .gantt-tooltip { position: fixed; background: #1E293B; border: 1px solid #38BDF8; border-radius: 8px; padding: 8px 12px; font-size: 11px; z-index: 1000; pointer-events: none; box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
    .gantt-tooltip-dates { color: #38BDF8; font-weight: 600; }
    .gantt-tooltip-duration { color: #94A3B8; margin-top: 2px; }
    
    /* Loading Overlay */
    .loading-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(15, 23, 42, 0.85); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; backdrop-filter: blur(4px); }
    .loading-overlay.hidden { display: none; }
    .loading-spinner { width: 50px; height: 50px; border: 4px solid #334155; border-top-color: #38BDF8; border-radius: 50%; animation: spin 1s linear infinite; }
    .loading-text { margin-top: 16px; color: #94A3B8; font-size: 14px; font-weight: 500; }
    .loading-subtext { margin-top: 4px; color: #64748B; font-size: 12px; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .gantt-empty { padding: 30px; text-align: center; color: #64748B; font-size: 13px; }
    .gantt-hint { text-align: center; padding: 8px; background: #334155; color: #94A3B8; font-size: 11px; border-top: 1px solid #475569; }
    
    /* Details Grid */
    .details-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 16px; }
    .detail-card { background: #0F172A; border-radius: 10px; padding: 20px; border: 1px solid #334155; }
    .detail-card-title { margin: 0 0 16px 0; font-size: 14px; font-weight: 600; }
    .detail-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #334155; }
    .detail-label { color: #64748B; font-size: 13px; }
    .detail-value { font-weight: 600; font-size: 13px; }
    .detail-value.editable { cursor: pointer; padding: 4px 8px; border-radius: 4px; }
    .detail-value.editable:hover { background: #334155; }
    
    /* Progress Circle */
    .progress-circle { position: relative; width: 100px; height: 100px; margin: 0 auto; }
    .progress-svg { width: 100%; height: 100%; transform: rotate(-90deg); }
    .progress-bg { stroke: #334155; }
    .progress-fg { stroke: #38BDF8; stroke-linecap: round; }
    .progress-text { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 20px; font-weight: 700; }
    
    /* Updates */
    .updates-section { max-width: 100%; }
    .add-update { display: flex; gap: 10px; margin-bottom: 16px; flex-wrap: wrap; }
    .add-update .form-input { flex: 1; min-width: 200px; }
    .updates-list { display: flex; flex-direction: column; gap: 10px; }
    .update-item { padding: 14px; background: #0F172A; border-radius: 8px; border: 1px solid #334155; position: relative; }
    .update-item:hover .update-actions { opacity: 1; }
    .update-date { font-size: 11px; color: #64748B; margin-bottom: 4px; }
    .update-text { font-size: 13px; line-height: 1.6; white-space: pre-wrap; word-wrap: break-word; }
    .update-actions { position: absolute; top: 10px; right: 10px; display: flex; gap: 4px; opacity: 0; transition: opacity 0.2s; }
    .no-updates { text-align: center; padding: 30px; color: #64748B; font-size: 13px; }
    
    /* Time Management */
    .member-selector { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 20px; padding-bottom: 16px; border-bottom: 1px solid #334155; }
    .member-tab { padding: 10px 16px; background: #334155; border: none; border-radius: 8px; color: #E2E8F0; font-size: 13px; font-weight: 500; cursor: pointer; font-family: inherit; }
    .member-tab.active { color: white; }
    
    .project-legend { display: flex; align-items: center; gap: 16px; flex-wrap: wrap; margin-bottom: 20px; padding: 12px; background: #0F172A; border-radius: 8px; }
    .legend-label { font-size: 12px; color: #64748B; font-weight: 500; }
    .legend-item { display: flex; align-items: center; gap: 6px; font-size: 12px; }
    .legend-color { width: 12px; height: 12px; border-radius: 4px; }
    .legend-hours { padding: 2px 6px; background: #334155; border-radius: 8px; font-size: 10px; font-weight: 600; }
    
    .week-nav { display: flex; align-items: center; justify-content: center; gap: 16px; margin-bottom: 20px; flex-wrap: wrap; }
    .week-label { font-size: 14px; font-weight: 600; min-width: 180px; text-align: center; }
    
    .calendar-grid { background: #0F172A; border-radius: 10px; overflow: hidden; border: 1px solid #334155; }
    .calendar-header { display: flex; border-bottom: 1px solid #334155; background: #1E293B; }
    .time-col { min-width: 60px; padding: 12px 8px; font-weight: 600; font-size: 11px; color: #64748B; text-align: center; border-right: 1px solid #334155; }
    .day-col { flex: 1; padding: 10px 4px; text-align: center; border-right: 1px solid #334155; min-width: 50px; }
    .day-name { font-size: 10px; color: #64748B; font-weight: 500; }
    .day-date { font-size: 14px; font-weight: 700; margin-top: 2px; }
    .calendar-body { max-height: 450px; overflow-y: auto; }
    .calendar-row { display: flex; border-bottom: 1px solid #334155; }
    .hour-label { min-width: 60px; padding: 12px 8px; font-size: 11px; color: #64748B; text-align: center; border-right: 1px solid #334155; background: #1E293B; }
    .slot-container { flex: 1; border-right: 1px solid #334155; padding: 4px; min-height: 44px; display: flex; align-items: center; justify-content: center; min-width: 50px; }
    .slot-options { display: flex; gap: 2px; flex-wrap: wrap; justify-content: center; }
    .slot-btn { width: 24px; height: 24px; border-radius: 4px; border: 2px solid; background: transparent; color: #94A3B8; font-size: 12px; cursor: pointer; }
    .slot-filled { padding: 4px 6px; border-radius: 4px; font-size: 9px; font-weight: 600; color: white; cursor: pointer; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%; }
    .slot-empty { color: #334155; font-size: 10px; }
    
    /* Toast */
    .toast { position: fixed; bottom: 20px; right: 20px; padding: 12px 20px; background: #10B981; color: white; border-radius: 8px; font-weight: 500; font-size: 13px; z-index: 2000; animation: slideIn 0.3s ease; }
    @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    
    .hidden { display: none !important; }
    
    /* Mobile Responsive */
    @media (min-width: 768px) {
      .nav { padding: 16px 32px; }
      .nav-date { display: block; }
      .main { padding: 24px; }
      .section { padding: 24px; }
      .detail-name { font-size: 28px; }
      .gantt-task-col, .gantt-task-name, .gantt-task-column { min-width: 280px; max-width: 280px; }
      .gantt-pic-column, .gantt-pic-cell { left: 280px; min-width: 130px; max-width: 130px; }
      .gantt-status-column, .gantt-status-cell { left: 410px; }
      .gantt-date, .gantt-bar-cell { min-width: 40px; }
    }
    
    @media (max-width: 767px) {
      .nav { flex-wrap: wrap; gap: 8px; padding: 12px; }
      .nav-brand { order: 1; }
      .nav-links { order: 3; width: 100%; justify-content: center; gap: 4px; }
      .nav-actions { order: 2; flex: 1; justify-content: flex-end; flex-wrap: wrap; gap: 4px; }
      .nav-link { padding: 8px 12px; font-size: 11px; }
      .user-badge { display: none; }
      .sync-status { padding: 4px 8px; }
      .sync-text { display: none; }
      .boards { grid-template-columns: 1fr; }
      .board { padding: 12px; }
      .board-header { flex-wrap: wrap; gap: 8px; }
      .board-actions { width: 100%; justify-content: flex-end; }
      .board-dropzone { min-height: 50px; font-size: 11px; }
      .pool-project { padding: 12px; }
      .pool-project-meta { gap: 4px; }
      .pool-project-date { font-size: 10px; padding: 3px 6px; }
      .portfolio-project-name, .portfolio-project-column, .portfolio-role-name { min-width: 120px; max-width: 120px; font-size: 11px; }
      .portfolio-bar { font-size: 9px; }
      .section-header { flex-direction: column; gap: 8px; align-items: flex-start; }
    }
    
    @media (max-width: 480px) {
      .nav-title { font-size: 14px; }
      .nav-link { padding: 6px 10px; font-size: 11px; }
      .nav-actions .btn { padding: 6px 8px; font-size: 10px; }
      .nav-actions .btn-sm { min-width: auto; }
      #btn-export, #btn-import, #btn-settings, #btn-users { display: none; }
      .btn { padding: 8px 12px; font-size: 12px; }
      .form-row { grid-template-columns: 1fr; }
      .pool { grid-template-columns: 1fr; padding: 8px; }
      .boards { grid-template-columns: 1fr; }
      .detail-actions { flex-direction: column; }
      .detail-actions .btn { width: 100%; justify-content: center; }
      .modal { margin: 10px; border-radius: 12px; max-height: 90vh; }
      .modal-body { padding: 16px; max-height: 60vh; overflow-y: auto; }
      .gantt-task-col, .gantt-task-name, .gantt-task-column { min-width: 120px; max-width: 120px; padding: 6px; font-size: 10px; }
      .gantt-pic-column, .gantt-pic-cell { min-width: 90px; max-width: 90px; left: 120px; }
      .gantt-status-column, .gantt-status-cell { min-width: 80px; max-width: 80px; left: 210px; }
      .gantt-controls { flex-direction: column; align-items: stretch; }
      .gantt-scale-btn { padding: 8px 12px; }
      .gantt-date, .gantt-bar-cell { min-width: 28px; }
      .gantt-bar-label { font-size: 9px; }
      .time-col, .hour-label { min-width: 50px; }
      .board-project-item { padding: 10px; }
      .board-project-name { font-size: 12px; }
      .portfolio-project-name, .portfolio-project-column, .portfolio-role-name { min-width: 100px; max-width: 100px; font-size: 10px; }
      .portfolio-header-cell { padding: 8px; font-size: 10px; }
      .login-container { padding: 24px 16px; margin: 16px; }
      .login-logo-title { font-size: 20px; }
      .summary { grid-template-columns: repeat(2, 1fr); gap: 8px; }
      .summary-card { padding: 12px; }
      .summary-value { font-size: 20px; }
    }
    
    /* Touch-friendly improvements */
    @media (hover: none) and (pointer: coarse) {
      .pool-project, .board-project-item { 
        -webkit-touch-callout: none;
        -webkit-user-select: none;
        user-select: none;
      }
      .btn { min-height: 44px; }
      .nav-link { min-height: 40px; display: flex; align-items: center; }
      .gantt-bar { min-height: 32px; }
      .gantt-bar-handle { width: 16px; }
    }
  </style>
</head>
<body>
  <!-- Login Page (hidden initially to prevent flash) -->
  <div class="login-page hidden" id="login-page">
    <div class="login-container">
      <div class="login-logo">
        <img src="logo.png" alt="CP AXTRA" class="login-logo-img" style="height:60px;margin-bottom:16px;">
        <div class="login-logo-title">Accounting Tech Project Hub</div>
        <div class="login-logo-subtitle">Team Dashboard</div>
      </div>
      <div class="login-form">
        <div class="login-error" id="login-error">Invalid username or password</div>
        <div class="login-input-group">
          <span class="login-input-icon">üë§</span>
          <input type="text" class="login-input" id="login-username" placeholder="Username" autocomplete="username">
        </div>
        <div class="login-input-group">
          <span class="login-input-icon">üîí</span>
          <input type="password" class="login-input" id="login-password" placeholder="Password" autocomplete="current-password">
        </div>
        <button class="login-btn" onclick="handleLogin()">Sign In</button>
        <button type="button" style="background:transparent;border:none;color:#64748B;font-size:13px;cursor:pointer;margin-top:8px;text-decoration:underline;" onclick="openForgotPasswordModal()">Forgot Password?</button>
      </div>
    </div>
  </div>

  <!-- Forgot Password Modal -->
  <div id="modal-forgot-password" class="modal-overlay hidden" onclick="if(event.target===this)closeForgotPasswordModal()">
    <div class="modal" style="max-width:400px;">
      <div class="modal-header">
        <span class="modal-title">üîë Reset Password</span>
        <button class="modal-close" onclick="closeForgotPasswordModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div id="forgot-password-error" style="display:none;background:#7F1D1D;color:#FCA5A5;padding:12px;border-radius:8px;margin-bottom:16px;font-size:13px;"></div>
        <div id="forgot-password-success" style="display:none;background:#064E3B;color:#6EE7B7;padding:12px;border-radius:8px;margin-bottom:16px;font-size:13px;"></div>

        <div class="form-group">
          <label class="form-label">Username</label>
          <input type="text" class="form-input" id="forgot-username" placeholder="Enter your username">
        </div>
        <div class="form-group">
          <label class="form-label">New Password</label>
          <input type="password" class="form-input" id="forgot-new-password" placeholder="Enter new password">
        </div>
        <div class="form-group">
          <label class="form-label">Confirm New Password</label>
          <input type="password" class="form-input" id="forgot-confirm-password" placeholder="Confirm new password">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeForgotPasswordModal()">Cancel</button>
        <button class="btn btn-primary" onclick="resetPassword()">Reset Password</button>
      </div>
    </div>
  </div>

  <!-- Main App (hidden until login) -->
  <div id="app-container" class="hidden">
    <nav class="nav">
      <div class="nav-brand" onclick="showView('dashboard')" style="cursor:pointer;" title="Go to Dashboard">
        <img src="logo.png" alt="Logo" style="height:28px;">
        <span class="nav-title">Project Hub</span>
      </div>
      <div class="nav-links">
        <button class="nav-link active" id="nav-dashboard" onclick="showView('dashboard')">üìã Projects</button>
        <button class="nav-link" id="nav-mytasks" onclick="showView('mytasks')">‚úÖ My Tasks</button>
        <button class="nav-link" id="nav-portfolio" onclick="showView('portfolio')">üìä Portfolio</button>
        <button class="nav-link" id="nav-calendar" onclick="showView('calendar')">üìÖ Schedule</button>
        <a href="https://itservicedesk.lotuss.com/th/admin/dashboard" target="_blank" class="nav-link tickets-btn">üé´ Tickets</a>
      </div>
      <div class="nav-actions">
        <span class="nav-date" id="current-date"></span>
        <div class="user-badge">
          <span class="user-badge-icon" id="user-icon">üë§</span>
          <span class="user-badge-name" id="user-name">User</span>
          <span class="user-badge-role" id="user-role">user</span>
        </div>
        <div class="sync-status" id="sync-status" title="Cloud sync status" onclick="openConfigModal()" style="cursor:pointer;">
          <span class="sync-icon" id="sync-icon">‚òÅÔ∏è</span>
          <span class="sync-text" id="sync-text">Local</span>
        </div>
        <button class="btn btn-success btn-sm" onclick="downloadBackup()" title="Download Backup">üíæ Backup</button>
        <button class="btn btn-secondary btn-sm" onclick="syncNow()" id="btn-sync" title="Sync with Google Sheets">üîÑ</button>
        <button class="btn btn-secondary btn-sm" onclick="openUsersModal()" id="btn-users" title="User Management">üë• Users</button>
        <button class="btn btn-secondary btn-sm" onclick="openConfigModal()" id="btn-settings" title="Settings">‚öôÔ∏è</button>
        <button class="btn btn-secondary btn-sm" onclick="exportData()" id="btn-export" title="Export JSON">üì§</button>
        <button class="btn btn-secondary btn-sm" onclick="document.getElementById('import-file').click()" id="btn-import" title="Import JSON">üì•</button>
        <input type="file" id="import-file" accept=".json" style="display:none" onchange="importData(event)">
        <button class="logout-btn" onclick="handleLogout()">Logout</button>
      </div>
    </nav>

    <main class="main">
      <!-- Dashboard View -->
      <div id="view-dashboard">
        <div class="section">
          <h2 class="section-title">üìä Hours</h2>
          <div class="summary-cards" id="summary-cards"></div>
        </div>
        <div class="section">
          <div class="section-header">
            <h2 class="section-title">üì¶ Project Pool</h2>
            <button class="btn btn-primary btn-sm" onclick="openProjectModal()" id="btn-new-project">+ New Project</button>
          </div>
          <div class="pool" id="project-pool"
               ondragover="handlePoolDragOver(event)"
               ondragleave="handlePoolDragLeave(event)"
               ondrop="handlePoolDrop(event)"></div>
        </div>
        <div class="section">
        <div class="section-header">
          <h2 class="section-title">üë• Team</h2>
          <button class="btn btn-primary btn-sm" id="btn-add-member" onclick="openMemberModal()">+ Add Member</button>
        </div>
        <!-- Role Filter and Search for Team Section -->
        <div id="team-role-filter" style="display:flex;flex-wrap:wrap;gap:12px;margin-bottom:16px;padding:12px;background:#334155;border-radius:8px;align-items:center;">
          <span style="color:#94A3B8;font-size:12px;font-weight:500;">üè∑Ô∏è Filter by Role:</span>
          <label style="display:flex;align-items:center;gap:4px;cursor:pointer;font-size:12px;">
            <input type="checkbox" value="PM" onchange="renderTeamBoards()" checked style="accent-color:#8B5CF6;">
            <span style="background:#8B5CF6;color:white;padding:2px 8px;border-radius:4px;font-size:11px;">PM</span>
          </label>
          <label style="display:flex;align-items:center;gap:4px;cursor:pointer;font-size:12px;">
            <input type="checkbox" value="Dev" onchange="renderTeamBoards()" checked style="accent-color:#EF4444;">
            <span style="background:#EF4444;color:white;padding:2px 8px;border-radius:4px;font-size:11px;">Dev</span>
          </label>
          <label style="display:flex;align-items:center;gap:4px;cursor:pointer;font-size:12px;">
            <input type="checkbox" value="QA" onchange="renderTeamBoards()" checked style="accent-color:#F59E0B;">
            <span style="background:#F59E0B;color:white;padding:2px 8px;border-radius:4px;font-size:11px;">QA</span>
          </label>
          <label style="display:flex;align-items:center;gap:4px;cursor:pointer;font-size:12px;">
            <input type="checkbox" value="Support" onchange="renderTeamBoards()" checked style="accent-color:#06B6D4;">
            <span style="background:#06B6D4;color:white;padding:2px 8px;border-radius:4px;font-size:11px;">Support</span>
          </label>
          <label style="display:flex;align-items:center;gap:4px;cursor:pointer;font-size:12px;">
            <input type="checkbox" value="Lead" onchange="renderTeamBoards()" checked style="accent-color:#3B82F6;">
            <span style="background:#3B82F6;color:white;padding:2px 8px;border-radius:4px;font-size:11px;">Lead</span>
          </label>
          <div style="display:flex;align-items:center;gap:8px;margin-left:auto;">
            <span style="color:#94A3B8;font-size:12px;font-weight:500;">üîç</span>
            <input type="text" id="team-project-search" placeholder="Search projects..." oninput="renderTeamBoards()" style="background:#1E293B;border:1px solid #475569;color:#E2E8F0;padding:6px 12px;border-radius:6px;font-size:12px;min-width:150px;">
          </div>
        </div>
        <div class="boards" id="team-boards"></div>
      </div>
    </div>

    <!-- Project Detail View -->
    <div id="view-project" class="hidden">
      <div class="section">
        <div class="detail-header">
          <button class="back-btn" onclick="showView('dashboard')">‚Üê Back</button>
          <div class="detail-title" id="project-title"></div>
          <p class="detail-desc" id="project-desc"></p>
          <div class="detail-actions" id="project-actions"></div>
        </div>
        <div class="tabs" id="project-tabs"></div>
        <div id="tab-content"></div>
      </div>
    </div>

    <!-- Portfolio View (All Projects Timeline) -->
    <div id="view-portfolio" class="hidden">
      <div class="section">
        <h1 style="font-size: 22px; font-weight: 700; margin: 16px 0;">üìä Portfolio Overview</h1>
        <p style="color:#64748B;margin-bottom:16px;">Aggregated timeline of all projects with role assignments</p>

        <!-- Portfolio Tab Buttons -->
        <div style="display:flex;gap:8px;margin-bottom:20px;">
          <button id="portfolio-tab-timeline" class="gantt-scale-btn active" onclick="switchPortfolioTab('timeline')" style="padding:10px 24px;font-size:14px;">üìÖ Timeline</button>
          <button id="portfolio-tab-saving" class="gantt-scale-btn" onclick="switchPortfolioTab('saving')" style="padding:10px 24px;font-size:14px;">üí∞ Saving</button>
        </div>

        <!-- Timeline Tab Content -->
        <div id="portfolio-timeline-tab">
          <!-- Portfolio BUG-2: Project Status Summary Cards -->
          <div id="portfolio-status-cards" style="display:flex;gap:12px;margin-bottom:16px;flex-wrap:wrap;">
            <!-- Cards will be rendered here by JavaScript -->
          </div>

          <!-- Portfolio SUG-1 & SUG-2: Enhanced Filters (Multi-select Member, Project Name, Status) -->
          <div id="portfolio-filters" style="display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin-bottom:16px;padding:12px;background:#334155;border-radius:8px;">
            <div style="display:flex;flex-direction:column;gap:4px;">
              <span style="color:#94A3B8;font-size:11px;">üë§ Members:</span>
              <select id="portfolio-member-filter" multiple onchange="renderPortfolio()" style="background:#1E293B;border:1px solid #475569;color:#E2E8F0;padding:6px 12px;border-radius:6px;font-size:12px;min-width:150px;max-height:100px;">
                <!-- Options will be populated by JavaScript -->
              </select>
              <span style="font-size:9px;color:#64748B;">Hold Ctrl/Cmd for multi-select</span>
            </div>

            <div style="display:flex;flex-direction:column;gap:4px;">
              <span style="color:#94A3B8;font-size:11px;">üè∑Ô∏è Roles:</span>
              <div id="portfolio-role-filter" style="display:flex;flex-wrap:wrap;gap:6px;background:#1E293B;padding:8px;border-radius:6px;border:1px solid #475569;">
                <label style="display:flex;align-items:center;gap:4px;cursor:pointer;font-size:11px;">
                  <input type="checkbox" value="PM" onchange="renderPortfolio()" checked style="accent-color:#8B5CF6;">
                  <span style="background:#8B5CF6;color:white;padding:1px 6px;border-radius:3px;">PM</span>
                </label>
                <label style="display:flex;align-items:center;gap:4px;cursor:pointer;font-size:11px;">
                  <input type="checkbox" value="Dev" onchange="renderPortfolio()" checked style="accent-color:#EF4444;">
                  <span style="background:#EF4444;color:white;padding:1px 6px;border-radius:3px;">Dev</span>
                </label>
                <label style="display:flex;align-items:center;gap:4px;cursor:pointer;font-size:11px;">
                  <input type="checkbox" value="QA" onchange="renderPortfolio()" checked style="accent-color:#F59E0B;">
                  <span style="background:#F59E0B;color:white;padding:1px 6px;border-radius:3px;">QA</span>
                </label>
                <label style="display:flex;align-items:center;gap:4px;cursor:pointer;font-size:11px;">
                  <input type="checkbox" value="Support" onchange="renderPortfolio()" checked style="accent-color:#06B6D4;">
                  <span style="background:#06B6D4;color:white;padding:1px 6px;border-radius:3px;">Support</span>
                </label>
                <label style="display:flex;align-items:center;gap:4px;cursor:pointer;font-size:11px;">
                  <input type="checkbox" value="Lead" onchange="renderPortfolio()" checked style="accent-color:#3B82F6;">
                  <span style="background:#3B82F6;color:white;padding:1px 6px;border-radius:3px;">Lead</span>
                </label>
              </div>
            </div>

            <div style="display:flex;flex-direction:column;gap:4px;">
              <span style="color:#94A3B8;font-size:11px;">üìã Status:</span>
              <select id="portfolio-status-filter" onchange="renderPortfolio()" style="background:#1E293B;border:1px solid #475569;color:#E2E8F0;padding:6px 12px;border-radius:6px;font-size:12px;">
                <option value="all">All Statuses</option>
                <option value="Not Started">Not Started</option>
                <option value="Planning">Planning</option>
                <option value="In Progress">In Progress</option>
                <option value="On Hold">On Hold</option>
                <option value="Completed">Completed</option>
              </select>
            </div>

            <div style="display:flex;flex-direction:column;gap:4px;">
              <span style="color:#94A3B8;font-size:11px;">üîç Project Name:</span>
              <input type="text" id="portfolio-name-filter" onkeyup="renderPortfolio()" placeholder="Search..." style="background:#1E293B;border:1px solid #475569;color:#E2E8F0;padding:6px 12px;border-radius:6px;font-size:12px;min-width:150px;">
            </div>

            <button onclick="clearPortfolioFilters()" style="background:#475569;border:none;color:#E2E8F0;padding:6px 12px;border-radius:6px;font-size:11px;cursor:pointer;margin-top:16px;">Clear Filters</button>
          </div>
          <div id="portfolio-gantt"></div>
        </div>

        <!-- Saving Tab Content -->
        <div id="portfolio-saving-tab" style="display:none;">
          <div id="portfolio-saving-content"></div>
        </div>
      </div>
    </div>

    <!-- My Tasks View -->
    <div id="view-mytasks" class="hidden">
      <div class="section">
        <button class="back-btn" onclick="showView('dashboard')">‚Üê Back</button>
        <h1 style="font-size: 22px; font-weight: 700; margin: 16px 0;">‚úÖ My Tasks</h1>
        <p style="color:#64748B;margin-bottom:16px;" id="mytasks-subtitle">Your tasks for today</p>

        <!-- Admin User Tabs -->
        <div id="mytasks-user-tabs" style="display:none;margin-bottom:20px;">
          <div style="display:flex;gap:8px;flex-wrap:wrap;"></div>
        </div>

        <!-- Urgency Filter Tabs -->
        <div id="mytasks-urgency-tabs" style="margin-bottom:20px;">
          <div style="display:flex;gap:8px;flex-wrap:wrap;"></div>
        </div>

        <!-- Task Summary Cards -->
        <div id="mytasks-summary" style="display:flex;gap:12px;margin-bottom:20px;flex-wrap:wrap;"></div>

        <!-- Tasks List -->
        <div id="mytasks-list"></div>
      </div>
    </div>

    <!-- Time Management View -->
    <div id="view-calendar" class="hidden">
      <div class="section">
        <button class="back-btn" onclick="showView('dashboard')">‚Üê Back</button>
        <h1 style="font-size: 22px; font-weight: 700; margin: 16px 0;">‚è∞ Schedule & Time Management</h1>
        <p style="color:#64748B;margin-bottom:16px;font-size:13px;">Track project progress and weekly time allocation</p>

        <!-- SCHEDULE IMPROVEMENT: Project Summary Tracking with Status (R=Risk, O=On Track) -->
        <div id="schedule-project-summary" style="background:#334155;padding:16px;border-radius:12px;margin-bottom:20px;">
          <!-- Summary will be rendered here -->
        </div>

        <div style="border-top:1px solid #475569;padding-top:20px;">
          <h2 style="font-size:16px;font-weight:600;margin-bottom:16px;color:#F1F5F9;">üë• Member Time Allocation</h2>
          <div class="member-selector" id="member-selector"></div>
          <div class="project-legend" id="project-legend"></div>
          <div class="week-nav">
            <button class="btn btn-secondary btn-sm" onclick="changeWeek(-1)">‚Üê Prev</button>
            <span class="week-label" id="week-label"></span>
            <button class="btn btn-secondary btn-sm" onclick="changeWeek(1)">Next ‚Üí</button>
          </div>
          <div class="calendar-grid" id="calendar-grid"></div>
        </div>
      </div>
    </div>
  </main>
  </div><!-- end app-container -->

  <!-- Project Modal -->
  <div class="modal-overlay hidden" id="modal-project" onclick="closeModal('project')">
    <div class="modal" onclick="event.stopPropagation()">
      <div class="modal-header">
        <h3 class="modal-title" id="project-modal-title">New Project</h3>
        <button class="modal-close" onclick="closeModal('project')">√ó</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="edit-project-id">
        <div class="form-group">
          <label class="form-label">Project Name *</label>
          <input class="form-input" id="project-name" placeholder="Enter project name">
        </div>
        <div class="form-group">
          <label class="form-label">Short Description</label>
          <textarea class="form-textarea" id="project-desc-input" placeholder="Brief description for card display" style="min-height: 60px;"></textarea>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Priority</label>
            <select class="form-select" id="project-priority">
              <option value="Low">Low</option>
              <option value="Medium" selected>Medium</option>
              <option value="High">High</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Status</label>
            <select class="form-select" id="project-status">
              <option value="Not Started">Not Started</option>
              <option value="Planning">Planning</option>
              <option value="In Progress">In Progress</option>
              <option value="On Hold">On Hold</option>
              <option value="Completed">Completed</option>
            </select>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">User Team</label>
            <div style="display:flex;gap:8px;">
              <select class="form-select" id="project-team" style="flex:1;">
                <option value="">-- Select Team --</option>
              </select>
              <button class="btn btn-secondary btn-sm" type="button" id="add-team-btn" title="Add New Team">+</button>
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">Target Saving Hours/Month</label>
            <input type="number" class="form-input" id="project-saving-hours" placeholder="e.g., 40" min="0">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Actual Saving Hours/Month</label>
            <input type="number" class="form-input" id="project-actual-saving-hours" placeholder="e.g., 35 (for completed projects)" min="0">
          </div>
          <div class="form-group">
            <label class="form-label">Start Date</label>
            <input type="date" class="form-input" id="project-start">
          </div>
          <div class="form-group">
            <label class="form-label">End Date</label>
            <input type="date" class="form-input" id="project-end">
          </div>
        </div>
        
        <!-- Rich Brief Section -->
        <div class="brief-section">
          <div class="brief-section-title">üìù Project Brief (Details, Links, Images)</div>
          <div class="brief-editor">
            <div class="brief-toolbar">
              <button class="brief-toolbar-btn" onclick="execBriefCmd('bold')" title="Bold"><b>B</b></button>
              <button class="brief-toolbar-btn" onclick="execBriefCmd('italic')" title="Italic"><i>I</i></button>
              <button class="brief-toolbar-btn" onclick="execBriefCmd('underline')" title="Underline"><u>U</u></button>
              <button class="brief-toolbar-btn" onclick="execBriefCmd('insertUnorderedList')" title="Bullet List">‚Ä¢</button>
              <button class="brief-toolbar-btn" onclick="execBriefCmd('insertOrderedList')" title="Numbered List">1.</button>
              <button class="brief-toolbar-btn" onclick="insertLink()" title="Insert Link">üîó</button>
              <button class="brief-toolbar-btn" onclick="document.getElementById('brief-image-input').click()" title="Upload Image">üñºÔ∏è</button>
            </div>
            <div class="brief-content" id="brief-content" contenteditable="true" data-placeholder="Add project details, paste images, insert links..."></div>
            <input type="file" id="brief-image-input" accept="image/*" style="display:none" onchange="handleBriefImage(event)">
          </div>
          <div class="image-upload-area" id="image-drop-area">
            üì∑ Drag & drop images here or paste from clipboard (Ctrl+V)
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-danger btn-sm" id="delete-project-btn" onclick="deleteProjectFromModal()" style="margin-right: auto;">üóëÔ∏è Delete</button>
        <button class="btn btn-secondary" onclick="closeModal('project')">Cancel</button>
        <button class="btn btn-primary" onclick="saveProject()">Save Project</button>
      </div>
    </div>
  </div>

  <!-- Task Modal -->
  <div class="modal-overlay hidden" id="modal-task" onclick="closeModal('task')">
    <div class="modal" onclick="event.stopPropagation()">
      <div class="modal-header">
        <h3 class="modal-title" id="task-modal-title">Add Task</h3>
        <button class="modal-close" onclick="closeModal('task')">√ó</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="edit-task-id">
        <div class="form-group">
          <label class="form-label">Task Name *</label>
          <input class="form-input" id="task-name" placeholder="Enter task name">
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Start Date</label>
            <input type="date" class="form-input" id="task-start">
          </div>
          <div class="form-group">
            <label class="form-label">End Date</label>
            <input type="date" class="form-input" id="task-end">
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">PIC (Person In Charge)</label>
          <div style="display:flex;gap:8px;align-items:center;">
            <select class="form-select" id="task-pic" style="flex:1;" onchange="handlePicSelectChange()">
              <option value="">-- Select PIC --</option>
            </select>
            <span style="color:#64748B;font-size:12px;">or</span>
            <input class="form-input" id="task-pic-custom" placeholder="Type custom name..." style="flex:1;">
          </div>
          <div style="font-size:11px;color:#64748B;margin-top:4px;">Select a team member or type a custom name</div>
        </div>
        <div class="form-group">
          <label class="form-label">Progress: <span id="progress-display">0</span>%</label>
          <input type="range" class="form-input" id="task-progress" min="0" max="100" step="5" value="0" oninput="document.getElementById('progress-display').textContent=this.value" style="padding:8px;" disabled>
          <div style="font-size:11px;color:#64748B;margin-top:4px;">Progress is calculated from subtasks</div>
        </div>
        <div class="form-group">
          <label class="form-label">Subtasks</label>
          <div id="subtasks-container" style="margin-bottom:8px;max-height:200px;overflow-y:auto;"></div>
          <div style="display:flex;gap:8px;">
            <input class="form-input" id="new-subtask-name" placeholder="Add a subtask..." style="flex:1;">
            <button class="btn btn-secondary" onclick="addSubtaskToModal()" type="button">+ Add</button>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('task')">Cancel</button>
        <button class="btn btn-primary" onclick="saveTask()">Save Task</button>
      </div>
    </div>
  </div>

  <!-- Member Modal -->
  <div class="modal-overlay hidden" id="modal-member" onclick="closeModal('member')">
    <div class="modal" onclick="event.stopPropagation()">
      <div class="modal-header">
        <h3 class="modal-title" id="member-modal-title">Add Member</h3>
        <button class="modal-close" onclick="closeModal('member')">√ó</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="edit-member-id">
        <div class="form-group">
          <label class="form-label">Name *</label>
          <input class="form-input" id="member-name" placeholder="Enter name">
        </div>
        <div class="form-group">
          <label class="form-label">Role</label>
          <input class="form-input" id="member-role" placeholder="e.g., Developer">
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Avatar</label>
            <select class="form-select" id="member-avatar">
              <option value="üë®‚Äçüíª">üë®‚Äçüíª</option>
              <option value="üë©‚Äçüíª">üë©‚Äçüíª</option>
              <option value="üë®‚Äçüíº">üë®‚Äçüíº</option>
              <option value="üë©‚Äçüíº">üë©‚Äçüíº</option>
              <option value="üë®‚Äçüî¨">üë®‚Äçüî¨</option>
              <option value="üë©‚Äçüî¨">üë©‚Äçüî¨</option>
              <option value="üë®‚Äçüé®">üë®‚Äçüé®</option>
              <option value="üë©‚Äçüé®">üë©‚Äçüé®</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Color</label>
            <input type="color" class="form-input" id="member-color" value="#3B82F6" style="height:44px;padding:4px;">
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('member')">Cancel</button>
        <button class="btn btn-primary" onclick="saveMember()">Save</button>
      </div>
    </div>
  </div>

  <!-- Update Modal -->
  <div class="modal-overlay hidden" id="modal-update" onclick="closeModal('update')">
    <div class="modal" onclick="event.stopPropagation()">
      <div class="modal-header">
        <h3 class="modal-title">Edit Update</h3>
        <button class="modal-close" onclick="closeModal('update')">√ó</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="edit-update-index">
        <div id="update-original-info" style="background:#1E293B;padding:10px 14px;border-radius:8px;margin-bottom:16px;font-size:12px;color:#94A3B8;"></div>
        <div class="form-group">
          <label class="form-label">Update Text *</label>
          <textarea class="form-textarea" id="update-text" placeholder="Enter update..." rows="5" style="min-height:120px;resize:vertical;"></textarea>
          <div style="font-size:11px;color:#64748B;margin-top:4px;">üí° Press Enter for new line</div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('update')">Cancel</button>
        <button class="btn btn-primary" onclick="saveUpdate()">Save</button>
      </div>
    </div>
  </div>

  <!-- Add Team Modal -->
  <div class="modal-overlay hidden" id="modal-team" onclick="closeModal('team')">
    <div class="modal" style="max-width:400px;" onclick="event.stopPropagation()">
      <div class="modal-header">
        <h3 class="modal-title">Add New Team</h3>
        <button class="modal-close" onclick="closeModal('team')">√ó</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">Team Name *</label>
          <input class="form-input" id="new-team-name" placeholder="e.g., Marketing, Sales, Legal...">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('team')">Cancel</button>
        <button class="btn btn-primary" onclick="saveNewTeam()">Add Team</button>
      </div>
    </div>
  </div>

  <!-- Config Modal -->
  <div class="modal-overlay hidden" id="modal-config" onclick="closeModal('config')">
    <div class="modal" style="max-width:500px;" onclick="event.stopPropagation()">
      <div class="modal-header">
        <h3 class="modal-title">‚öôÔ∏è Cloud Sync Status</h3>
        <button class="modal-close" onclick="closeModal('config')">√ó</button>
      </div>
      <div class="modal-body">
        <div class="config-section">
          <label class="config-label">Database</label>
          <div style="padding:12px;background:#064E3B;border-radius:8px;color:#6EE7B7;">
            ‚òÅÔ∏è <b>Google Sheets</b> - Auto-sync enabled
          </div>
        </div>
        <div class="config-section">
          <label class="config-label">Connection Status</label>
          <div id="config-sync-status" style="padding:8px 0;color:#94A3B8;">Checking...</div>
        </div>
        <div class="config-section">
          <label class="config-label">Actions</label>
          <div style="display:flex;gap:8px;flex-wrap:wrap;">
            <button class="btn btn-primary btn-sm" onclick="testConnection()">üîç Test Connection</button>
            <button class="btn btn-secondary btn-sm" onclick="forceLoadFromCloud()">‚¨áÔ∏è Load from Cloud</button>
            <button class="btn btn-success btn-sm" onclick="syncNow()">‚¨ÜÔ∏è Push to Cloud</button>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('config')">Close</button>
      </div>
    </div>
  </div>

  <!-- Quick Assign Modal (Mobile-friendly) -->
  <div class="modal-overlay hidden" id="modal-quickassign" onclick="closeModal('quickassign')">
    <div class="modal" style="max-width:450px;" onclick="event.stopPropagation()">
      <div class="modal-header">
        <h3 class="modal-title">üë• Assign Project</h3>
        <button class="modal-close" onclick="closeModal('quickassign')">√ó</button>
      </div>
      <div class="modal-body" id="quickassign-content">
      </div>
    </div>
  </div>

  <!-- Role Select Modal (for drag & drop) -->
  <div class="modal-overlay hidden" id="modal-roleselect" onclick="closeModal('roleselect')">
    <div class="modal" style="max-width:350px;" onclick="event.stopPropagation()">
      <div class="modal-header">
        <h3 class="modal-title">üè∑Ô∏è Select Role</h3>
        <button class="modal-close" onclick="closeModal('roleselect')">√ó</button>
      </div>
      <div class="modal-body" id="roleselect-content">
      </div>
    </div>
  </div>

  <!-- User Management Modal (Admin Only) -->
  <div class="modal-overlay hidden" id="modal-users" onclick="closeModal('users')">
    <div class="modal" style="max-width:600px;" onclick="event.stopPropagation()">
      <div class="modal-header">
        <h3 class="modal-title">üë• User Management</h3>
        <button class="modal-close" onclick="closeModal('users')">√ó</button>
      </div>
      <div class="modal-body" id="users-content" style="max-height:500px;overflow-y:auto;">
      </div>
    </div>
  </div>

  <!-- Add/Edit User Modal -->
  <div class="modal-overlay hidden" id="modal-user-edit" onclick="closeModal('user-edit')">
    <div class="modal" style="max-width:400px;" onclick="event.stopPropagation()">
      <div class="modal-header">
        <h3 class="modal-title" id="user-edit-title">Add User</h3>
        <button class="modal-close" onclick="closeModal('user-edit')">√ó</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="edit-user-original-username">
        <div class="form-group">
          <label class="form-label">Username *</label>
          <input type="text" class="form-input" id="user-username" placeholder="Enter username (lowercase)">
          <small style="color:#64748B;font-size:10px;">Letters and numbers only, no spaces</small>
        </div>
        <div class="form-group">
          <label class="form-label">Password *</label>
          <input type="text" class="form-input" id="user-password" placeholder="Enter password">
        </div>
        <div class="form-group">
          <label class="form-label">Display Name *</label>
          <input type="text" class="form-input" id="user-displayname" placeholder="e.g., John Doe">
        </div>
        <div class="form-group">
          <label class="form-label">Role</label>
          <select class="form-select" id="user-role">
            <option value="user">User</option>
            <option value="admin">Admin</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Icon</label>
          <select class="form-select" id="user-icon">
            <option value="üë§">üë§ Default</option>
            <option value="üë®‚Äçüíª">üë®‚Äçüíª Developer</option>
            <option value="üë©‚Äçüíª">üë©‚Äçüíª Developer (F)</option>
            <option value="üë®‚Äçüíº">üë®‚Äçüíº Manager</option>
            <option value="üë©‚Äçüíº">üë©‚Äçüíº Manager (F)</option>
            <option value="üë®‚Äçüî¨">üë®‚Äçüî¨ Analyst</option>
            <option value="üë©‚Äçüî¨">üë©‚Äçüî¨ Analyst (F)</option>
            <option value="üë®‚Äçüé®">üë®‚Äçüé® Designer</option>
            <option value="üë©‚Äçüé®">üë©‚Äçüé® Designer (F)</option>
            <option value="üë®‚Äçüîß">üë®‚Äçüîß Engineer</option>
            <option value="üë©‚Äçüîß">üë©‚Äçüîß Engineer (F)</option>
            <option value="üìä">üìä PM</option>
            <option value="üíª">üíª Tech</option>
            <option value="üëë">üëë Admin</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Link to Team Member</label>
          <select class="form-select" id="user-member-link">
            <option value="">-- Not Linked --</option>
          </select>
          <small style="color:#64748B;font-size:10px;">Link to show their card first when logged in</small>
        </div>
        <div class="form-actions">
          <button class="btn btn-secondary" onclick="closeModal('user-edit')">Cancel</button>
          <button class="btn btn-primary" onclick="saveUser()">Save User</button>
        </div>
      </div>
    </div>
  </div>

  <div id="gantt-tooltip" class="gantt-tooltip hidden"></div>
  <div id="toast-container"></div>
  
  <!-- Loading Overlay -->
  <div id="loading-overlay" class="loading-overlay hidden">
    <div class="loading-spinner"></div>
    <div class="loading-text" id="loading-text">Syncing...</div>
    <div class="loading-subtext" id="loading-subtext">Please wait</div>
  </div>

  <script>
    // ==================== AUTHENTICATION ====================
    // Default users (always available, cannot be deleted)
    const DEFAULT_USERS = {
      admin: { password: 'u@U5410154', role: 'admin', name: 'Administrator', icon: 'üëë', memberId: null, isDefault: true },
      user: { password: '123456', role: 'user', name: 'Team Member', icon: 'üë§', memberId: null, isDefault: true },
      boonyanuch: { password: '123456', role: 'admin', name: 'Boonyanuch', icon: 'üëë', memberId: null, isDefault: true }
    };
    
    // Get all users (default + custom from data)
    function getAllUsers() {
      const customUsers = (data && data.users) ? data.users : {};
      return { ...DEFAULT_USERS, ...customUsers };
    }
    
    let currentUser = null;
    
    function handleLogin() {
      const username = document.getElementById('login-username').value.trim().toLowerCase();
      const password = document.getElementById('login-password').value;
      const errorEl = document.getElementById('login-error');

      const allUsers = getAllUsers();
      if (allUsers[username] && allUsers[username].password === password) {
        currentUser = { username, ...allUsers[username] };
        // Use localStorage for persistent login (survives page refresh and new tabs)
        localStorage.setItem('currentUser', JSON.stringify(currentUser));
        errorEl.classList.remove('show');
        showApp();
      } else {
        errorEl.classList.add('show');
        document.getElementById('login-password').value = '';
      }
    }
    
    function handleLogout() {
      currentUser = null;
      // Clear persistent login from localStorage
      localStorage.removeItem('currentUser');
      document.getElementById('login-page').classList.remove('hidden');
      document.getElementById('app-container').classList.add('hidden');
      document.getElementById('login-username').value = '';
      document.getElementById('login-password').value = '';
    }

    function openForgotPasswordModal() {
      document.getElementById('forgot-username').value = '';
      document.getElementById('forgot-new-password').value = '';
      document.getElementById('forgot-confirm-password').value = '';
      document.getElementById('forgot-password-error').style.display = 'none';
      document.getElementById('forgot-password-success').style.display = 'none';
      document.getElementById('modal-forgot-password').classList.remove('hidden');
    }

    function closeForgotPasswordModal() {
      document.getElementById('modal-forgot-password').classList.add('hidden');
    }

    function resetPassword() {
      const username = document.getElementById('forgot-username').value.trim().toLowerCase();
      const newPassword = document.getElementById('forgot-new-password').value;
      const confirmPassword = document.getElementById('forgot-confirm-password').value;
      const errorEl = document.getElementById('forgot-password-error');
      const successEl = document.getElementById('forgot-password-success');

      // Hide previous messages
      errorEl.style.display = 'none';
      successEl.style.display = 'none';

      // Validation
      if (!username) {
        errorEl.textContent = 'Please enter your username';
        errorEl.style.display = 'block';
        return;
      }

      if (!newPassword) {
        errorEl.textContent = 'Please enter a new password';
        errorEl.style.display = 'block';
        return;
      }

      if (newPassword.length < 3) {
        errorEl.textContent = 'Password must be at least 3 characters';
        errorEl.style.display = 'block';
        return;
      }

      if (newPassword !== confirmPassword) {
        errorEl.textContent = 'Passwords do not match';
        errorEl.style.display = 'block';
        return;
      }

      // Check if user exists
      const allUsers = getAllUsers();
      if (!allUsers[username]) {
        errorEl.textContent = 'Username not found';
        errorEl.style.display = 'block';
        return;
      }

      // Check if it's a default user (admin/user)
      if (DEFAULT_USERS[username]) {
        errorEl.textContent = 'Cannot change password for default accounts. Please contact administrator.';
        errorEl.style.display = 'block';
        return;
      }

      // Update password in data.users (data.users is an object keyed by username)
      if (!data.users) data.users = {};
      if (data.users[username]) {
        data.users[username].password = newPassword;
        saveData();

        successEl.textContent = 'Password updated successfully! You can now login with your new password.';
        successEl.style.display = 'block';

        // Clear form fields
        document.getElementById('forgot-new-password').value = '';
        document.getElementById('forgot-confirm-password').value = '';

        // Auto close after 2 seconds
        setTimeout(() => {
          closeForgotPasswordModal();
        }, 2000);
      } else {
        errorEl.textContent = 'User not found in database. Only custom users can reset passwords.';
        errorEl.style.display = 'block';
      }
    }

    function showApp() {
      document.getElementById('login-page').classList.add('hidden');
      document.getElementById('app-container').classList.remove('hidden');
      document.getElementById('user-name').textContent = currentUser.name;
      document.getElementById('user-role').textContent = currentUser.role;
      document.getElementById('user-icon').textContent = currentUser.icon;
      updateUIForRole();
      initApp();
    }
    
    function isAdmin() { return currentUser && currentUser.role === 'admin'; }
    function getCurrentUserMemberId() { return currentUser ? currentUser.memberId : null; }
    
    function updateUIForRole() {
      // Admin-only buttons
      const adminOnlyElements = ['btn-import', 'btn-add-member', 'btn-users'];
      adminOnlyElements.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.style.display = isAdmin() ? '' : 'none';
      });
      
      // Users can create projects but admin can do more
      const newProjectBtn = document.getElementById('btn-new-project');
      if (newProjectBtn) {
        newProjectBtn.style.display = ''; // Show for all users
      }
    }
    
    function canEditProject() { return isAdmin(); }
    function canDeleteProject() { return isAdmin(); }
    function canEditProjectTimeline(project) { 
      if (isAdmin()) return true;
      // Users cannot edit if timeline is locked
      return project && !project.lockedTimeline;
    }
    function canEditTask(task, project) { 
      if (isAdmin()) return true;
      // User can only edit tasks that are not locked and project timeline is not locked
      if (project && project.lockedTimeline) return false;
      return task && !task.locked;
    }
    function canDragTask(task, project) {
      if (isAdmin()) return true;
      if (project && project.lockedTimeline) return false;
      return task && !task.locked;
    }
    function canAddTask(project) {
      if (isAdmin()) return true;
      // Users can add tasks if timeline is not locked
      return project && !project.lockedTimeline;
    }
    function canLockTask() { return isAdmin(); }
    function canEditMember() { return isAdmin(); }
    function canDeleteMember() { return isAdmin(); }
    
    // Check for existing session - rehydrate auth state from localStorage
    function checkSession() {
      const saved = localStorage.getItem('currentUser');
      if (saved) {
        try {
          currentUser = JSON.parse(saved);
          // Validate that user still exists in the system
          const allUsers = getAllUsers();
          if (currentUser.username && allUsers[currentUser.username]) {
            // User exists, rehydrate session
            showApp();
            return;
          } else {
            // User no longer exists, clear invalid session
            localStorage.removeItem('currentUser');
            currentUser = null;
          }
        } catch (e) {
          // Invalid session data, clear it
          localStorage.removeItem('currentUser');
          currentUser = null;
        }
      }
      // No valid session, show login page
      document.getElementById('login-page').classList.remove('hidden');
    }
    
    // Enter key for login
    document.getElementById('login-password').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') handleLogin();
    });
    document.getElementById('login-username').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') document.getElementById('login-password').focus();
    });

    // ==================== CLOUD SYNC (Google Sheets) ====================
    const SHEETS_URL = 'https://script.google.com/macros/s/AKfycbzTdIUieXXMFviwzwhDNCM02ts7ParaB9caLTz-qmAiS2wbaMutElfFrzXye8lynnVrEA/exec';
    let isSyncing = false;
    let lastSyncTime = null;
    
    function updateSyncStatus(status, message) {
      const statusEl = document.getElementById('sync-status');
      const iconEl = document.getElementById('sync-icon');
      const textEl = document.getElementById('sync-text');
      if (!statusEl) return;
      
      statusEl.className = 'sync-status ' + status;
      switch(status) {
        case 'synced':
          iconEl.textContent = '‚òÅÔ∏è';
          textEl.textContent = message || 'Synced';
          break;
        case 'syncing':
          iconEl.textContent = 'üîÑ';
          textEl.textContent = 'Syncing...';
          break;
        case 'error':
          iconEl.textContent = '‚ö†Ô∏è';
          textEl.textContent = message || 'Error';
          break;
        default:
          iconEl.textContent = 'üíæ';
          textEl.textContent = 'Local';
      }
    }
    
    // Base64 encode for URL safety
    function base64Encode(str) {
      return btoa(unescape(encodeURIComponent(str)));
    }
    
    function showLoading(text = 'Syncing...', subtext = 'Please wait') {
      document.getElementById('loading-text').textContent = text;
      document.getElementById('loading-subtext').textContent = subtext;
      document.getElementById('loading-overlay').classList.remove('hidden');
    }
    
    function hideLoading() {
      document.getElementById('loading-overlay').classList.add('hidden');
    }
    
    // Track if cloud sync is available (set to false after first failure to avoid spam)
    let cloudSyncAvailable = true;

    async function syncToCloud(dataToSync, showSpinner = false, forceRetry = false) {
      // Skip cloud sync if already known to be unavailable (unless force retry)
      if (!forceRetry && !cloudSyncAvailable) {
        if (showSpinner) {
          updateSyncStatus('error', 'Offline');
          showToast('Cloud sync unavailable - click sync status to retry');
        }
        return false;
      }

      if (isSyncing) return false;

      isSyncing = true;
      updateSyncStatus('syncing');
      if (showSpinner) showLoading('Syncing to Cloud...', 'Saving your data');

      try {
        const jsonStr = JSON.stringify(dataToSync);
        const base64Data = base64Encode(jsonStr);

        // Use POST method to avoid URL length limits (GET URLs have ~2000 char limit)
        const formData = new FormData();
        formData.append('action', 'save');
        formData.append('data', base64Data);

        const response = await fetch(SHEETS_URL, {
          method: 'POST',
          body: formData
        });

        if (!response.ok) {
          throw new Error('Network response was not ok: ' + response.status);
        }

        const text = await response.text();
        let result;
        try {
          result = JSON.parse(text);
        } catch (parseErr) {
          console.error('Failed to parse response:', text);
          throw new Error('Invalid response from server');
        }

        if (result && result.success) {
          lastSyncTime = new Date();
          cloudSyncAvailable = true; // Re-enable cloud sync on success
          updateSyncStatus('synced', 'Synced');
          isSyncing = false;
          if (showSpinner) hideLoading();
          return true;
        } else {
          throw new Error(result?.error || 'Save failed - check Google Apps Script configuration');
        }
      } catch (err) {
        console.error('Sync error:', err);
        updateSyncStatus('error', 'Sync failed');
        isSyncing = false;
        if (showSpinner) hideLoading();
        return false;
      }
    }

    async function loadFromCloud(showSpinner = true, forceRetry = false) {
      // Skip if cloud sync already known to be unavailable (unless force retry)
      if (!forceRetry && !cloudSyncAvailable) {
        updateSyncStatus('error', 'Offline');
        return null;
      }

      updateSyncStatus('syncing');
      if (showSpinner) showLoading('Loading from Cloud...', 'Fetching your data');

      try {
        const response = await fetch(SHEETS_URL + '?t=' + Date.now());
        const result = await response.json();

        if (result.success && result.data) {
          cloudSyncAvailable = true; // Re-enable cloud sync on success
          updateSyncStatus('synced', 'Loaded');
          if (showSpinner) hideLoading();
          return result.data;
        } else {
          cloudSyncAvailable = true; // Connection works, just no data
          updateSyncStatus('synced', 'Ready');
          if (showSpinner) hideLoading();
          return null;
        }
      } catch (error) {
        console.warn('Cloud sync unavailable:', error.message);
        // Only disable auto-sync, but allow manual retry
        if (!forceRetry) {
          cloudSyncAvailable = false;
        }
        updateSyncStatus('error', 'Load Fail');
        if (showSpinner) hideLoading();
        return null;
      }
    }
    
    async function syncNow() {
      // Force retry even if cloud sync was previously disabled
      cloudSyncAvailable = true;
      const success = await syncToCloud(data, true, true);
      if (success) {
        showToast('Synced to Google Sheets!');
      } else {
        showToast('Sync failed - check your connection');
      }
    }
    
    function openConfigModal() {
      if (cloudSyncAvailable) {
        document.getElementById('config-sync-status').innerHTML = '‚úÖ Connected to Google Sheets<br><small style="color:#64748B;">Auto-sync is enabled</small>';
      } else {
        document.getElementById('config-sync-status').innerHTML = '‚ö†Ô∏è Cloud sync unavailable<br><small style="color:#FCA5A5;">Click "Test Connection" to retry</small>';
      }
      document.getElementById('modal-config').classList.remove('hidden');
    }
    
    async function testConnection() {
      document.getElementById('config-sync-status').textContent = 'üîÑ Testing connection...';
      showLoading('Testing Connection...', 'Checking Google Sheets');

      try {
        const response = await fetch(SHEETS_URL + '?t=' + Date.now());
        const result = await response.json();

        hideLoading();
        if (result.success) {
          cloudSyncAvailable = true; // Re-enable cloud sync on successful test
          updateSyncStatus('synced', 'Ready');
          document.getElementById('config-sync-status').innerHTML = '‚úÖ Connected! ' + (result.data ? 'Data found in cloud.' : 'Ready to sync.') + '<br><small style="color:#64748B;">Cloud sync re-enabled</small>';
        } else {
          document.getElementById('config-sync-status').textContent = '‚ùå Error: ' + (result.error || 'Unknown error');
        }
      } catch (error) {
        hideLoading();
        cloudSyncAvailable = false;
        updateSyncStatus('error', 'Offline');
        document.getElementById('config-sync-status').textContent = '‚ùå Failed: ' + error.message;
        console.error('Test connection error:', error);
      }
    }
    
    async function forceLoadFromCloud() {
      // Force retry even if cloud sync was previously disabled
      cloudSyncAvailable = true;
      const cloudData = await loadFromCloud(true, true);
      if (cloudData) {
        data = cloudData;
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        showView(currentView);
        showToast('Loaded from cloud!');
      } else {
        showToast('No cloud data found or connection failed');
      }
    }
    
    function downloadBackup() {
      const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19);
      const filename = `project-hub-backup-${timestamp}.json`;
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      showToast('Backup downloaded: ' + filename);
    }

    // ==================== DATA ====================
    const STORAGE_KEY = 'projectHubData';
    
    const defaultData = {
      teams: ['Accounting', 'IT', 'Operations', 'HR', 'Finance'],
      projects: [
        { id: 'p1', name: 'ERP Migration', description: 'Migrate legacy ERP to cloud-based solution', brief: '<p>This project involves migrating our current ERP system to a modern cloud solution.</p><h3>Key Objectives:</h3><ul><li>Reduce operational costs</li><li>Improve system reliability</li><li>Enable remote access</li></ul>', status: 'In Progress', priority: 'High', team: 'IT', savingHours: 120, startDate: '2026-01-06', endDate: '2026-02-28', lockedTimeline: true, tasks: [
          { id: 't1', name: 'Requirements Analysis', start: '2026-01-06', end: '2026-01-17', progress: 100, locked: true },
          { id: 't2', name: 'Data Migration Planning', start: '2026-01-13', end: '2026-01-24', progress: 60, locked: true },
          { id: 't3', name: 'Development Phase 1', start: '2026-01-20', end: '2026-02-14', progress: 20, locked: false },
          { id: 't4', name: 'Testing & QA', start: '2026-02-10', end: '2026-02-21', progress: 0, locked: false },
          { id: 't5', name: 'Go Live', start: '2026-02-24', end: '2026-02-28', progress: 0, locked: false }
        ], updates: [{ date: '2026-01-13', text: 'Completed stakeholder interviews' }] },
        { id: 'p2', name: 'Invoice Automation', description: 'Automate invoice processing with OCR', brief: '<p>Implement automated invoice processing using OCR technology.</p><p>Reference: <a href="https://example.com/ocr-docs">OCR Documentation</a></p>', status: 'Planning', priority: 'Medium', startDate: '2026-01-20', endDate: '2026-03-15', lockedTimeline: false, tasks: [
          { id: 't6', name: 'Vendor Selection', start: '2026-01-20', end: '2026-01-31', progress: 0 },
          { id: 't7', name: 'Integration Design', start: '2026-02-03', end: '2026-02-14', progress: 0 },
          { id: 't8', name: 'Implementation', start: '2026-02-17', end: '2026-03-07', progress: 0 },
          { id: 't9', name: 'Training', start: '2026-03-10', end: '2026-03-15', progress: 0 }
        ], updates: [{ date: '2026-01-10', text: 'Kickoff meeting scheduled' }] },
        { id: 'p3', name: 'Dashboard Redesign', description: 'Modernize analytics dashboard UI/UX', brief: '', status: 'Not Started', priority: 'Low', startDate: '2026-02-01', endDate: '2026-03-01', tasks: [
          { id: 't10', name: 'User Research', start: '2026-02-01', end: '2026-02-07', progress: 0 },
          { id: 't11', name: 'Wireframing', start: '2026-02-10', end: '2026-02-14', progress: 0 },
          { id: 't12', name: 'Visual Design', start: '2026-02-17', end: '2026-02-21', progress: 0 },
          { id: 't13', name: 'Development', start: '2026-02-24', end: '2026-03-01', progress: 0 }
        ], updates: [] }
      ],
      members: [
        { id: 'm1', name: 'Alex Chen', role: 'Senior Developer', avatar: 'üë®‚Äçüíª', color: '#3B82F6' },
        { id: 'm2', name: 'Sarah Kim', role: 'Project Manager', avatar: 'üë©‚Äçüíº', color: '#10B981' },
        { id: 'm3', name: 'Mike Johnson', role: 'Data Analyst', avatar: 'üë®‚Äçüî¨', color: '#F59E0B' },
        { id: 'm4', name: 'Lisa Wang', role: 'UX Designer', avatar: 'üë©‚Äçüé®', color: '#EC4899' },
        { id: 'm5', name: 'Tom Brown', role: 'Backend Dev', avatar: 'üë®‚Äçüîß', color: '#8B5CF6' }
      ],
      projectPool: ['p1', 'p2', 'p3'],
      memberProjects: {},
      timeSlots: {},
      settings: { ganttTimeScale: 'daily', portfolioTimeScale: 'weekly' },
      users: {} // Custom users added by admin (stored separately from DEFAULT_USERS)
    };

    let data = loadData();
    let selectedWeek = new Date('2026-01-13');
    let currentProjectId = null;
    let selectedMember = data.members[0]?.id || null;
    let activeTab = 'brief';
    let ganttDrag = { active: false, taskId: null, mode: null, startX: 0, originalStart: null, originalEnd: null, dayWidth: 36, projectStart: null, projectEnd: null };

    function loadData() {
      try {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) {
          const parsed = JSON.parse(saved);
          return { 
            teams: parsed.teams || ['Accounting', 'IT', 'Operations', 'HR', 'Finance'], 
            projects: parsed.projects || [], 
            members: parsed.members || [], 
            projectPool: parsed.projectPool || [], 
            memberProjects: parsed.memberProjects || {}, 
            timeSlots: parsed.timeSlots || {},
            settings: parsed.settings || { ganttTimeScale: 'daily', portfolioTimeScale: 'weekly' },
            users: parsed.users || {}
          };
        }
      } catch (e) { console.error('Load error:', e); }
      return JSON.parse(JSON.stringify(defaultData));
    }

    function saveData() { 
      try { 
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); 
        // Auto-sync to cloud on every change
        syncToCloud(data);
      } catch (e) { console.error('Save error:', e); } 
    }
    function exportData() { const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `project-hub-${new Date().toISOString().split('T')[0]}.json`; a.click(); URL.revokeObjectURL(url); showToast('Exported!'); }
    function importData(event) { const file = event.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = (e) => { try { data = JSON.parse(e.target.result); saveData(); showView('dashboard'); showToast('Imported!'); } catch (err) { alert('Invalid file'); } }; reader.readAsText(file); event.target.value = ''; }

    // ==================== UTILITIES ====================
    function formatDate(d) { return d ? new Date(d).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) : 'N/A'; }
    function formatDateShort(d) { return d ? new Date(d).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) : ''; }
    function calcDuration(s, e) { return s && e ? Math.ceil((new Date(e) - new Date(s)) / 864e5) + 1 : 0; }
    function calcProgress(tasks) { return tasks?.length ? Math.round(tasks.reduce((sum, t) => sum + (t.progress || 0), 0) / tasks.length) : 0; }
    function getPriorityClass(p) { return 'priority priority-' + (p || 'medium').toLowerCase(); }

    // SUG-7: Risk calculation logic
    // A task/project is at risk if:
    // 1. End date is in the past and progress < 100%
    // 2. Task is overdue based on expected progress vs actual progress
    function calculateRiskStatus(item) {
      if (!item.endDate || !item.startDate) return { isRisk: false, reason: '' };

      const today = new Date();
      today.setHours(0, 0, 0, 0);
      const start = new Date(item.startDate);
      const end = new Date(item.endDate);
      const progress = item.progress || (item.tasks ? calcProgress(item.tasks) : 0);

      // Risk 1: Past end date and not complete
      if (end < today && progress < 100) {
        const daysOverdue = Math.ceil((today - end) / 864e5);
        return { isRisk: true, reason: `Overdue by ${daysOverdue} day${daysOverdue !== 1 ? 's' : ''}` };
      }

      // Risk 2: Expected progress vs actual progress (if within project timeline)
      if (start <= today && today <= end) {
        const totalDuration = calcDuration(item.startDate, item.endDate);
        const elapsedDuration = Math.ceil((today - start) / 864e5);
        const expectedProgress = Math.min(100, Math.round((elapsedDuration / totalDuration) * 100));

        // If actual progress is more than 20% behind expected progress, flag as risk
        if (progress < expectedProgress - 20) {
          return { isRisk: true, reason: `Behind schedule (${progress}% vs ${expectedProgress}% expected)` };
        }
      }

      return { isRisk: false, reason: '' };
    }
    function getProgressColor(p) { return p === 100 ? '#10B981' : p > 0 ? '#3B82F6' : '#6B7280'; }
    // Bright, distinct project colors for easy identification
    const PROJECT_CARD_COLORS = [
      { bg: '#3B82F6', light: '#DBEAFE', text: '#1E40AF' },  // Blue
      { bg: '#10B981', light: '#D1FAE5', text: '#065F46' },  // Green
      { bg: '#F59E0B', light: '#FEF3C7', text: '#92400E' },  // Amber
      { bg: '#EC4899', light: '#FCE7F3', text: '#9D174D' },  // Pink
      { bg: '#8B5CF6', light: '#EDE9FE', text: '#5B21B6' },  // Purple
      { bg: '#EF4444', light: '#FEE2E2', text: '#991B1B' },  // Red
      { bg: '#14B8A6', light: '#CCFBF1', text: '#115E59' },  // Teal
      { bg: '#F97316', light: '#FFEDD5', text: '#9A3412' },  // Orange
      { bg: '#06B6D4', light: '#CFFAFE', text: '#155E75' },  // Cyan
      { bg: '#84CC16', light: '#ECFCCB', text: '#3F6212' },  // Lime
      { bg: '#A855F7', light: '#F3E8FF', text: '#6B21A8' },  // Violet
      { bg: '#FB7185', light: '#FFE4E6', text: '#9F1239' },  // Rose
    ];
    // Get consistent color for a project based on its position in the projects array
    function getProjectCardColor(projectId) {
      const index = data.projects.findIndex(p => p.id === projectId);
      return PROJECT_CARD_COLORS[index % PROJECT_CARD_COLORS.length];
    }
    const projectColors = ['#3B82F6', '#10B981', '#F59E0B', '#EC4899', '#8B5CF6', '#EF4444', '#14B8A6'];
    function getProjectColor(id, list) { return projectColors[list.findIndex(p => p.id === id) % projectColors.length]; }
    function getProjectById(id) { return data.projects.find(p => p.id === id); }
    function getMemberById(id) { return data.members.find(m => m.id === id); }
    function showToast(msg) { const t = document.createElement('div'); t.className = 'toast'; t.textContent = msg; document.getElementById('toast-container').appendChild(t); setTimeout(() => t.remove(), 2500); }
    function generateId() { return 'id_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9); }

    // ==================== VIEWS ====================
    let currentView = 'dashboard';
    
    function showView(view) {
      currentView = view;
      document.getElementById('view-dashboard').classList.add('hidden');
      document.getElementById('view-project').classList.add('hidden');
      document.getElementById('view-portfolio').classList.add('hidden');
      document.getElementById('view-mytasks').classList.add('hidden');
      document.getElementById('view-calendar').classList.add('hidden');
      document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));

      if (view === 'dashboard') { document.getElementById('view-dashboard').classList.remove('hidden'); document.getElementById('nav-dashboard').classList.add('active'); currentProjectId = null; renderDashboard(); }
      else if (view === 'project') { document.getElementById('view-project').classList.remove('hidden'); renderProjectDetail(); }
      else if (view === 'portfolio') { document.getElementById('view-portfolio').classList.remove('hidden'); document.getElementById('nav-portfolio').classList.add('active'); renderPortfolio(); }
      else if (view === 'mytasks') { document.getElementById('view-mytasks').classList.remove('hidden'); document.getElementById('nav-mytasks').classList.add('active'); renderMyTasks(); }
      else if (view === 'calendar') { document.getElementById('view-calendar').classList.remove('hidden'); document.getElementById('nav-calendar').classList.add('active'); renderTimeManagement(); }
    }

    // ==================== DASHBOARD ====================
    function renderDashboard() { renderSummary(); renderProjectPool(); renderTeamBoards(); }

    // ==================== MY TASKS VIEW ====================
    function getBangkokToday() {
      // Get today's date in Bangkok timezone
      const now = new Date();
      const bangkokTime = new Date(now.toLocaleString('en-US', { timeZone: 'Asia/Bangkok' }));
      return bangkokTime.toISOString().split('T')[0];
    }

    // Calculate urgency label for a task
    function getTaskUrgency(task) {
      const today = getBangkokToday();
      const todayDate = new Date(today);
      const taskEnd = new Date(task.end);

      // Calculate days until due (negative means overdue)
      const diffTime = taskEnd.getTime() - todayDate.getTime();
      const daysUntilDue = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

      if (daysUntilDue < 0) {
        return { label: 'Delayed', color: '#DC2626', bg: '#7F1D1D', priority: 1 };
      } else if (daysUntilDue <= 2) {
        return { label: 'Due Soon', color: '#F59E0B', bg: '#78350F', priority: 2 };
      } else if (daysUntilDue <= 4) {
        return { label: 'Coming Up', color: '#3B82F6', bg: '#1E3A8A', priority: 3 };
      } else {
        return { label: 'On Track', color: '#10B981', bg: '#064E3B', priority: 4 };
      }
    }

    function getMyTasks(filterMemberId = null, filterUrgency = null) {
      const today = getBangkokToday();
      const todayDate = new Date(today);
      const myTasks = [];

      data.projects.forEach(project => {
        if (!project.tasks) return;

        project.tasks.forEach(task => {
          const taskStart = new Date(task.start);
          const taskEnd = new Date(task.end);

          // Check if task is not finished
          if (task.status === 'Finished' || task.progress === 100) return;

          // Include tasks that: touch today OR are delayed (end date before today but not finished)
          const touchesToday = todayDate >= taskStart && todayDate <= taskEnd;
          const isDelayed = taskEnd < todayDate;

          if (!touchesToday && !isDelayed) return;

          // Filter by PIC member
          let includeTask = false;

          if (filterMemberId === 'all' || filterMemberId === null) {
            includeTask = true;
          } else {
            if (task.pic === filterMemberId) {
              includeTask = true;
            }
          }

          if (includeTask) {
            const urgency = getTaskUrgency(task);

            // Filter by urgency if specified
            if (filterUrgency && filterUrgency !== 'all' && urgency.label !== filterUrgency) {
              return;
            }

            myTasks.push({
              task,
              project,
              picMember: task.pic ? getMemberById(task.pic) : null,
              picCustom: task.picCustom,
              urgency
            });
          }
        });
      });

      // Sort by urgency priority (Delayed first, then Due Soon, etc.)
      myTasks.sort((a, b) => a.urgency.priority - b.urgency.priority);

      return myTasks;
    }

    // Get all members who are PIC on active tasks (touching today or delayed)
    function getMembersWithTodayTasks() {
      const today = getBangkokToday();
      const todayDate = new Date(today);
      const memberIds = new Set();

      data.projects.forEach(project => {
        if (!project.tasks) return;

        project.tasks.forEach(task => {
          const taskStart = new Date(task.start);
          const taskEnd = new Date(task.end);

          // Check if task is not finished
          if (task.status === 'Finished' || task.progress === 100) return;

          // Include tasks that touch today OR are delayed
          const touchesToday = todayDate >= taskStart && todayDate <= taskEnd;
          const isDelayed = taskEnd < todayDate;

          if (touchesToday || isDelayed) {
            if (task.pic) {
              memberIds.add(task.pic);
            }
          }
        });
      });

      // Return member objects
      return Array.from(memberIds)
        .map(id => getMemberById(id))
        .filter(m => m !== null)
        .sort((a, b) => a.name.localeCompare(b.name));
    }

    let mytasksSelectedMember = 'all';
    let mytasksSelectedUrgency = 'all';

    function selectMyTasksMember(memberId) {
      mytasksSelectedMember = memberId;
      renderMyTasks();
    }

    function selectMyTasksUrgency(urgency) {
      mytasksSelectedUrgency = urgency;
      renderMyTasks();
    }

    function renderMyTasks() {
      const today = getBangkokToday();
      const isAdminUser = isAdmin();
      const userTabsContainer = document.getElementById('mytasks-user-tabs');
      const urgencyTabsContainer = document.getElementById('mytasks-urgency-tabs');

      // Get members who have tasks today (for tabs)
      const membersWithTasks = getMembersWithTodayTasks();

      // Show/hide admin user tabs and populate them
      if (isAdminUser) {
        userTabsContainer.style.display = 'block';

        // Build member tabs based on PICs with tasks today
        let tabsHtml = `
          <div onclick="selectMyTasksMember('all')" style="padding:10px 20px;border-radius:8px;cursor:pointer;font-size:13px;font-weight:500;transition:all 0.2s;
            ${mytasksSelectedMember === 'all' ? 'background:#3B82F6;color:white;' : 'background:#1E293B;color:#94A3B8;border:1px solid #475569;'}">
            All Members
          </div>
        `;

        membersWithTasks.forEach(member => {
          const isActive = mytasksSelectedMember === member.id;
          const taskCount = getMyTasks(member.id, null).length;
          tabsHtml += `
            <div onclick="selectMyTasksMember('${member.id}')" style="padding:10px 20px;border-radius:8px;cursor:pointer;font-size:13px;font-weight:500;transition:all 0.2s;
              ${isActive ? 'background:#3B82F6;color:white;' : 'background:#1E293B;color:#94A3B8;border:1px solid #475569;'}">
              ${member.name} <span style="font-size:11px;opacity:0.7;">(${taskCount})</span>
            </div>
          `;
        });

        userTabsContainer.querySelector('div').innerHTML = tabsHtml;
      } else {
        userTabsContainer.style.display = 'none';
      }

      // Get all tasks for urgency counting (before urgency filter)
      const selectedMember = isAdminUser ? mytasksSelectedMember : 'all';
      const allTasks = getMyTasks(selectedMember, null);

      // Count tasks by urgency
      const urgencyCounts = {
        'all': allTasks.length,
        'Delayed': allTasks.filter(t => t.urgency.label === 'Delayed').length,
        'Due Soon': allTasks.filter(t => t.urgency.label === 'Due Soon').length,
        'Coming Up': allTasks.filter(t => t.urgency.label === 'Coming Up').length,
        'On Track': allTasks.filter(t => t.urgency.label === 'On Track').length
      };

      // Build urgency tabs
      const urgencyOptions = [
        { key: 'all', label: 'All', color: '#64748B', bg: '#334155' },
        { key: 'Delayed', label: 'Delayed', color: '#DC2626', bg: '#7F1D1D' },
        { key: 'Due Soon', label: 'Due Soon', color: '#F59E0B', bg: '#78350F' },
        { key: 'Coming Up', label: 'Coming Up', color: '#3B82F6', bg: '#1E3A8A' },
        { key: 'On Track', label: 'On Track', color: '#10B981', bg: '#064E3B' }
      ];

      let urgencyTabsHtml = '';
      urgencyOptions.forEach(opt => {
        const isActive = mytasksSelectedUrgency === opt.key;
        const count = urgencyCounts[opt.key];
        if (opt.key === 'all' || count > 0) {
          urgencyTabsHtml += `
            <div onclick="selectMyTasksUrgency('${opt.key}')" style="padding:10px 20px;border-radius:8px;cursor:pointer;font-size:13px;font-weight:500;transition:all 0.2s;
              ${isActive ? `background:${opt.bg};color:white;border:2px solid ${opt.color};` : 'background:#1E293B;color:#94A3B8;border:1px solid #475569;'}">
              ${opt.label} <span style="font-size:11px;opacity:0.8;">(${count})</span>
            </div>
          `;
        }
      });
      urgencyTabsContainer.querySelector('div').innerHTML = urgencyTabsHtml;

      // Get filtered tasks
      const myTasks = getMyTasks(selectedMember, mytasksSelectedUrgency === 'all' ? null : mytasksSelectedUrgency);

      // Update subtitle based on selected filter
      let subtitleText = '';
      if (isAdminUser) {
        if (selectedMember === 'all') {
          subtitleText = `All team tasks for today <span style="color:#38BDF8;">(${today})</span> - Bangkok Time`;
        } else {
          const memberName = getMemberById(selectedMember)?.name || selectedMember;
          subtitleText = `Tasks for <span style="color:#38BDF8;">${memberName}</span> today <span style="color:#94A3B8;">(${today})</span> - Bangkok Time`;
        }
      } else {
        subtitleText = `Your tasks for today <span style="color:#38BDF8;">(${today})</span> - Bangkok Time`;
      }
      document.getElementById('mytasks-subtitle').innerHTML = subtitleText;

      // Count by status
      const statusCounts = {
        'Not Started': myTasks.filter(t => t.task.status === 'Not Started' || !t.task.status).length,
        'In-Progress': myTasks.filter(t => t.task.status === 'In-Progress').length,
        'Stuck': myTasks.filter(t => t.task.status === 'Stuck').length
      };

      // Summary cards
      document.getElementById('mytasks-summary').innerHTML = `
        <div style="background:linear-gradient(135deg,#64748B,#475569);padding:16px 24px;border-radius:12px;min-width:120px;text-align:center;">
          <div style="font-size:28px;font-weight:700;">${myTasks.length}</div>
          <div style="font-size:12px;color:#E2E8F0;">Total Tasks</div>
        </div>
        <div style="background:linear-gradient(135deg,#6B7280,#4B5563);padding:16px 24px;border-radius:12px;min-width:120px;text-align:center;">
          <div style="font-size:28px;font-weight:700;">${statusCounts['Not Started']}</div>
          <div style="font-size:12px;color:#E2E8F0;">Not Started</div>
        </div>
        <div style="background:linear-gradient(135deg,#3B82F6,#1D4ED8);padding:16px 24px;border-radius:12px;min-width:120px;text-align:center;">
          <div style="font-size:28px;font-weight:700;">${statusCounts['In-Progress']}</div>
          <div style="font-size:12px;color:#E2E8F0;">In Progress</div>
        </div>
        <div style="background:linear-gradient(135deg,#EF4444,#B91C1C);padding:16px 24px;border-radius:12px;min-width:120px;text-align:center;">
          <div style="font-size:28px;font-weight:700;">${statusCounts['Stuck']}</div>
          <div style="font-size:12px;color:#E2E8F0;">Stuck</div>
        </div>
      `;

      // Tasks list
      if (myTasks.length === 0) {
        document.getElementById('mytasks-list').innerHTML = `
          <div style="background:#334155;padding:40px;border-radius:12px;text-align:center;">
            <div style="font-size:48px;margin-bottom:16px;">üéâ</div>
            <div style="font-size:18px;font-weight:600;color:#10B981;">No tasks for today!</div>
            <div style="font-size:13px;color:#64748B;margin-top:8px;">You're all caught up. Enjoy your day!</div>
          </div>
        `;
        return;
      }

      // Group tasks by project
      const tasksByProject = {};
      myTasks.forEach(item => {
        if (!tasksByProject[item.project.id]) {
          tasksByProject[item.project.id] = { project: item.project, tasks: [] };
        }
        tasksByProject[item.project.id].tasks.push(item);
      });

      let html = '';
      Object.values(tasksByProject).forEach(group => {
        const pColor = getProjectCardColor(group.project.id);
        html += `
          <div style="background:#334155;border-radius:12px;margin-bottom:16px;overflow:hidden;border-left:4px solid ${pColor.bg};">
            <div style="padding:16px;background:#1E293B;cursor:pointer;" onclick="openProject('${group.project.id}')">
              <div style="display:flex;align-items:center;gap:12px;">
                <span style="font-size:18px;font-weight:600;">${group.project.name}</span>
                <span style="background:#475569;padding:4px 10px;border-radius:12px;font-size:11px;">${group.tasks.length} task${group.tasks.length > 1 ? 's' : ''}</span>
                <span style="background:${group.project.status === 'In Progress' ? '#F59E0B' : '#64748B'};padding:4px 10px;border-radius:12px;font-size:11px;">${group.project.status}</span>
              </div>
            </div>
            <div style="padding:12px;">
        `;

        group.tasks.forEach(item => {
          const statusColor = {
            'Not Started': '#6B7280',
            'In-Progress': '#3B82F6',
            'Stuck': '#EF4444',
            'Finished': '#10B981'
          }[item.task.status || 'Not Started'] || '#6B7280';

          const picName = item.picMember ? item.picMember.name : (item.picCustom || 'Unassigned');
          const urgency = item.urgency;

          html += `
            <div style="background:#1E293B;padding:12px;border-radius:8px;margin-bottom:8px;display:flex;align-items:center;gap:12px;border-left:3px solid ${urgency.color};">
              <div style="width:8px;height:8px;border-radius:50%;background:${statusColor};flex-shrink:0;"></div>
              <div style="flex:1;min-width:0;">
                <div style="display:flex;align-items:center;gap:8px;">
                  <span style="font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${item.task.name}</span>
                  <span style="background:${urgency.bg};color:${urgency.color};padding:2px 8px;border-radius:4px;font-size:10px;font-weight:600;flex-shrink:0;">${urgency.label}</span>
                </div>
                <div style="font-size:11px;color:#64748B;margin-top:4px;">
                  ${formatDate(item.task.start)} - ${formatDate(item.task.end)}${isAdminUser ? ` ‚Ä¢ <span style="color:#38BDF8;">PIC: ${picName}</span>` : ''}
                </div>
              </div>
              <div style="display:flex;align-items:center;gap:8px;flex-shrink:0;">
                <span style="background:${statusColor};padding:4px 10px;border-radius:6px;font-size:11px;color:white;">${item.task.status || 'Not Started'}</span>
                <span style="background:#0F172A;padding:4px 10px;border-radius:6px;font-size:11px;">${item.task.progress || 0}%</span>
                <button class="btn btn-secondary btn-sm" onclick="openProject('${item.project.id}');setTimeout(()=>switchTab('timeline'),100);" title="View in Timeline">üìä</button>
              </div>
            </div>
          `;
        });

        html += `</div></div>`;
      });

      document.getElementById('mytasks-list').innerHTML = html;
    }

    // ==================== PORTFOLIO VIEW (All Projects Gantt) ====================
    let portfolioMemberFilter = 'all';
    
    function getProjectRoleAssignments(projectId) {
      // Get all members assigned to this project with their roles
      const assignments = [];
      Object.keys(data.memberProjects).forEach(mid => {
        const memberAssignments = data.memberProjects[mid] || [];
        memberAssignments.forEach(a => {
          const aId = typeof a === 'string' ? a : a.id;
          const aRole = typeof a === 'string' ? null : a.role;
          if (aId === projectId) {
            const member = getMemberById(mid);
            if (member) {
              assignments.push({ member, role: aRole, memberId: mid });
            }
          }
        });
      });
      return assignments;
    }
    
    // Portfolio helper: Clear all filters
    function clearPortfolioFilters() {
      document.getElementById('portfolio-member-filter').selectedIndex = -1;
      document.getElementById('portfolio-status-filter').value = 'all';
      document.getElementById('portfolio-name-filter').value = '';
      // Reset all role checkboxes to checked
      document.querySelectorAll('#portfolio-role-filter input[type="checkbox"]').forEach(cb => cb.checked = true);
      renderPortfolio();
    }

    let activePortfolioTab = 'timeline';

    function switchPortfolioTab(tab) {
      activePortfolioTab = tab;
      document.getElementById('portfolio-tab-timeline').classList.remove('active');
      document.getElementById('portfolio-tab-saving').classList.remove('active');
      document.getElementById('portfolio-tab-' + tab).classList.add('active');

      document.getElementById('portfolio-timeline-tab').style.display = tab === 'timeline' ? 'block' : 'none';
      document.getElementById('portfolio-saving-tab').style.display = tab === 'saving' ? 'block' : 'none';

      if (tab === 'saving') renderPortfolioSaving();
      if (tab === 'timeline') renderPortfolio();
    }

    function renderPortfolioSaving() {
      const container = document.getElementById('portfolio-saving-content');
      const allProjects = [...data.projects];

      // Sort by target saving hours descending, then by name
      const ranked = allProjects.sort((a, b) => (b.savingHours || 0) - (a.savingHours || 0) || a.name.localeCompare(b.name));

      // Totals
      const totalTarget = data.projects.reduce((sum, p) => sum + (p.savingHours || 0), 0);
      const totalActual = data.projects.filter(p => p.status === 'Completed').reduce((sum, p) => sum + (p.actualSavingHours || 0), 0);
      const maxTarget = ranked.length > 0 ? (ranked[0].savingHours || 0) : 1;

      let html = '';

      // Summary cards
      html += `<div style="display:flex;gap:12px;margin-bottom:24px;flex-wrap:wrap;">
        <div style="flex:1;min-width:180px;background:linear-gradient(135deg,#10B981,#059669);padding:24px;border-radius:12px;text-align:center;">
          <div style="font-size:36px;font-weight:700;color:white;">${totalTarget}</div>
          <div style="font-size:13px;color:rgba(255,255,255,0.9);margin-top:4px;">Target Hours/Month</div>
        </div>
        <div style="flex:1;min-width:180px;background:linear-gradient(135deg,#3B82F6,#1D4ED8);padding:24px;border-radius:12px;text-align:center;">
          <div style="font-size:36px;font-weight:700;color:white;">${totalActual}</div>
          <div style="font-size:13px;color:rgba(255,255,255,0.9);margin-top:4px;">Actual Hours/Month</div>
        </div>
        <div style="flex:1;min-width:180px;background:linear-gradient(135deg,${totalActual >= totalTarget ? '#10B981,#059669' : '#F59E0B,#D97706'});padding:24px;border-radius:12px;text-align:center;">
          <div style="font-size:36px;font-weight:700;color:white;">${totalTarget > 0 ? Math.round(totalActual / totalTarget * 100) : 0}%</div>
          <div style="font-size:13px;color:rgba(255,255,255,0.9);margin-top:4px;">Achievement</div>
        </div>
        <div style="flex:1;min-width:180px;background:#1E293B;padding:24px;border-radius:12px;text-align:center;border:2px solid #8B5CF6;">
          <div style="font-size:36px;font-weight:700;color:#8B5CF6;">${ranked.length}</div>
          <div style="font-size:13px;color:#94A3B8;margin-top:4px;">Projects with Saving</div>
        </div>
      </div>`;

      // Ranking list
      if (ranked.length === 0) {
        html += `<div style="background:#334155;padding:40px;border-radius:12px;text-align:center;">
          <div style="font-size:48px;margin-bottom:16px;">üìä</div>
          <div style="font-size:18px;font-weight:600;color:#94A3B8;">No projects with saving hours</div>
          <div style="font-size:13px;color:#64748B;margin-top:8px;">Set Target Saving Hours in project details to see rankings here.</div>
        </div>`;
      } else {
        html += `<div style="background:#334155;border-radius:12px;overflow:hidden;">
          <div style="display:flex;padding:14px 20px;background:#1E293B;font-size:12px;font-weight:600;color:#94A3B8;border-bottom:1px solid #475569;">
            <div style="width:50px;text-align:center;">#</div>
            <div style="flex:1;">Project</div>
            <div style="width:100px;text-align:center;">Status</div>
            <div style="width:120px;text-align:right;">Target (h/mo)</div>
            <div style="width:120px;text-align:right;">Actual (h/mo)</div>
            <div style="width:100px;text-align:right;">Achievement</div>
            <div style="flex:1.5;padding-left:20px;">Progress</div>
          </div>`;

        ranked.forEach((p, idx) => {
          const rank = idx + 1;
          const target = p.savingHours || 0;
          const actual = p.actualSavingHours || 0;
          const achievement = target > 0 ? Math.round(actual / target * 100) : 0;
          const barWidth = maxTarget > 0 ? Math.round((target / maxTarget) * 100) : 0;
          const actualBarWidth = maxTarget > 0 ? Math.round((actual / maxTarget) * 100) : 0;
          const isCompleted = p.status === 'Completed';

          const statusColors = {
            'Not Started': '#64748B', 'Planning': '#8B5CF6', 'In Progress': '#F59E0B',
            'On Hold': '#6B7280', 'Completed': '#10B981'
          };
          const statusColor = statusColors[p.status] || '#64748B';

          let medalIcon = '';
          if (rank === 1) medalIcon = 'ü•á';
          else if (rank === 2) medalIcon = 'ü•à';
          else if (rank === 3) medalIcon = 'ü•â';

          html += `<div style="display:flex;align-items:center;padding:14px 20px;border-bottom:1px solid #2D3748;${rank <= 3 ? 'background:rgba(59,130,246,0.05);' : ''}" onclick="openProject('${p.id}')" class="portfolio-saving-row">
            <div style="width:50px;text-align:center;font-weight:700;font-size:16px;color:${rank <= 3 ? '#E2E8F0' : '#64748B'};">${medalIcon || rank}</div>
            <div style="flex:1;min-width:0;">
              <div style="font-weight:600;font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;cursor:pointer;color:#E2E8F0;">${p.name}</div>
            </div>
            <div style="width:100px;text-align:center;">
              <span style="background:${statusColor};color:white;padding:3px 10px;border-radius:6px;font-size:11px;">${p.status}</span>
            </div>
            <div style="width:120px;text-align:right;font-weight:600;color:#10B981;font-size:15px;">${target}h</div>
            <div style="width:120px;text-align:right;font-weight:600;color:${isCompleted ? '#3B82F6' : '#64748B'};font-size:15px;">${isCompleted ? actual + 'h' : '-'}</div>
            <div style="width:100px;text-align:right;font-weight:600;color:${isCompleted ? (achievement >= 100 ? '#10B981' : '#F59E0B') : '#64748B'};">${isCompleted ? achievement + '%' : '-'}</div>
            <div style="flex:1.5;padding-left:20px;">
              <div style="position:relative;height:20px;background:#0F172A;border-radius:10px;overflow:hidden;">
                <div style="position:absolute;top:0;left:0;height:100%;width:${barWidth}%;background:rgba(16,185,129,0.3);border-radius:10px;"></div>
                ${isCompleted ? `<div style="position:absolute;top:0;left:0;height:100%;width:${actualBarWidth}%;background:linear-gradient(90deg,#3B82F6,#2563EB);border-radius:10px;"></div>` : ''}
                <div style="position:absolute;top:0;left:0;width:100%;height:100%;display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:600;color:white;">
                  ${target}h${isCompleted ? ' / ' + actual + 'h actual' : ''}
                </div>
              </div>
            </div>
          </div>`;
        });

        html += '</div>';
      }

      container.innerHTML = html;
    }

    // Get selected roles from checkboxes
    function getSelectedPortfolioRoles() {
      const checkboxes = document.querySelectorAll('#portfolio-role-filter input[type="checkbox"]:checked');
      return Array.from(checkboxes).map(cb => cb.value);
    }

    function renderPortfolio() {
      const container = document.getElementById('portfolio-gantt');
      const filterSelect = document.getElementById('portfolio-member-filter');
      const statusFilter = document.getElementById('portfolio-status-filter');
      const nameFilter = document.getElementById('portfolio-name-filter');
      const selectedRoles = getSelectedPortfolioRoles();

      // Portfolio SUG-1: Populate multi-select member filter
      const selectedMembers = Array.from(filterSelect.selectedOptions).map(opt => opt.value);
      filterSelect.innerHTML = data.members.map(m =>
        `<option value="${m.id}" ${selectedMembers.includes(m.id) ? 'selected' : ''}>${m.avatar} ${m.name}</option>`
      ).join('');

      // Start with all projects that have dates
      let allProjects = data.projects.filter(p => p.startDate && p.endDate);

      // Portfolio BUG-2: Calculate status summary BEFORE filtering
      // Count stuck tasks across all projects
      let stuckTasksCount = 0;
      allProjects.forEach(p => {
        if (p.tasks) {
          stuckTasksCount += p.tasks.filter(t => t.status === 'Stuck').length;
        }
      });

      const statusSummary = {
        total: allProjects.length,
        'Not Started': allProjects.filter(p => p.status === 'Not Started').length,
        'Planning': allProjects.filter(p => p.status === 'Planning').length,
        'In Progress': allProjects.filter(p => p.status === 'In Progress').length,
        'On Hold': allProjects.filter(p => p.status === 'On Hold').length,
        'Completed': allProjects.filter(p => p.status === 'Completed').length,
        atRisk: allProjects.filter(p => calculateRiskStatus(p).isRisk).length,
        stuckTasks: stuckTasksCount
      };

      // Render Portfolio BUG-2: Status Summary Cards
      document.getElementById('portfolio-status-cards').innerHTML = `
        <div style="flex:1;min-width:140px;background:linear-gradient(135deg,#3B82F6,#2563EB);padding:20px;border-radius:12px;text-align:center;">
          <div style="font-size:36px;font-weight:700;color:white;">${statusSummary.total}</div>
          <div style="font-size:12px;color:rgba(255,255,255,0.9);margin-top:4px;">Total Projects</div>
        </div>
        <div style="flex:1;min-width:120px;background:#1E293B;padding:16px;border-radius:12px;text-align:center;border:2px solid #10B981;">
          <div style="font-size:28px;font-weight:700;color:#10B981;">${statusSummary.Completed}</div>
          <div style="font-size:11px;color:#94A3B8;margin-top:2px;">Completed</div>
        </div>
        <div style="flex:1;min-width:120px;background:#1E293B;padding:16px;border-radius:12px;text-align:center;border:2px solid #F59E0B;">
          <div style="font-size:28px;font-weight:700;color:#F59E0B;">${statusSummary['In Progress']}</div>
          <div style="font-size:11px;color:#94A3B8;margin-top:2px;">In Progress</div>
        </div>
        <div style="flex:1;min-width:120px;background:#1E293B;padding:16px;border-radius:12px;text-align:center;border:2px solid #64748B;">
          <div style="font-size:28px;font-weight:700;color:#64748B;">${statusSummary['Not Started']}</div>
          <div style="font-size:11px;color:#94A3B8;margin-top:2px;">Not Started</div>
        </div>
        <div style="flex:1;min-width:120px;background:#1E293B;padding:16px;border-radius:12px;text-align:center;border:2px solid #EF4444;">
          <div style="font-size:28px;font-weight:700;color:#EF4444;">${statusSummary.atRisk}</div>
          <div style="font-size:11px;color:#94A3B8;margin-top:2px;">‚ö†Ô∏è At Risk</div>
        </div>
        <div style="flex:1;min-width:120px;background:linear-gradient(135deg,#DC2626,#991B1B);padding:16px;border-radius:12px;text-align:center;">
          <div style="font-size:28px;font-weight:700;color:white;">${statusSummary.stuckTasks}</div>
          <div style="font-size:11px;color:rgba(255,255,255,0.9);margin-top:2px;">üö´ Stuck Tasks</div>
        </div>
      `;

      // Portfolio SUG-1 & BUG-1 FIX: Apply multi-select member filter
      const selectedMemberIds = Array.from(filterSelect.selectedOptions).map(opt => opt.value);
      if (selectedMemberIds.length > 0) {
        allProjects = allProjects.filter(p => {
          const assignments = getProjectRoleAssignments(p.id);
          // Check if ANY of the selected members is assigned to this project
          return assignments.some(a => selectedMemberIds.includes(a.memberId));
        });
      }

      // Portfolio SUG-2: Apply status filter
      const selectedStatus = statusFilter.value;
      if (selectedStatus && selectedStatus !== 'all') {
        allProjects = allProjects.filter(p => p.status === selectedStatus);
      }

      // Portfolio SUG-2: Apply project name filter
      const searchName = nameFilter.value.trim().toLowerCase();
      if (searchName) {
        allProjects = allProjects.filter(p => p.name.toLowerCase().includes(searchName));
      }
      
      if (!allProjects.length) {
        container.innerHTML = '<div class="gantt-empty">No projects match the current filters.</div>';
        return;
      }
      
      // Get timescale from settings
      if (!data.settings) data.settings = {};
      const portfolioTimeScale = data.settings.portfolioTimeScale || 'weekly';
      
      // Fixed date range: Jan 1, 2026 to Dec 31, 2026 (or later if projects extend)
      const fixedStart = new Date('2026-01-01');
      const allEnds = allProjects.map(p => new Date(p.endDate));
      const maxProjectEnd = new Date(Math.max(...allEnds));
      const fixedEnd = new Date(Math.max(new Date('2026-12-31').getTime(), maxProjectEnd.getTime() + 30 * 864e5));
      
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      
      // Color palette for projects
      const colors = ['#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6', '#EC4899', '#06B6D4', '#84CC16', '#F97316', '#6366F1'];
      
      // Sort projects by start date
      const sortedProjects = [...allProjects].sort((a, b) => new Date(a.startDate) - new Date(b.startDate));

      // All available roles with their colors
      const PORTFOLIO_ROLES = [
        { role: 'PM', color: '#8B5CF6' },
        { role: 'Dev', color: '#EF4444' },
        { role: 'QA', color: '#F59E0B' },
        { role: 'Support', color: '#EF4444' },
        { role: 'Lead', color: '#3B82F6' }
      ];

      // Build project data with role assignments - filter by selected members and roles
      const hasMemberFilter = selectedMemberIds.length > 0;
      const projectsWithRoles = sortedProjects.map((p, idx) => {
        let assignments = getProjectRoleAssignments(p.id);

        // Only show member rows when member filter is active
        if (hasMemberFilter) {
          assignments = assignments.filter(a => selectedMemberIds.includes(a.memberId));
        }

        // Filter assignments to only show selected roles
        if (selectedRoles.length > 0) {
          assignments = assignments.filter(a => selectedRoles.includes(a.role));
        }

        // Group assignments by role - only when member filter is active
        const roleGroups = {};
        if (hasMemberFilter) {
          PORTFOLIO_ROLES.forEach(r => {
            if (selectedRoles.includes(r.role)) {
              roleGroups[r.role] = assignments.filter(a => a.role === r.role);
            }
          });
        }

        return {
          ...p,
          color: colors[idx % colors.length],
          roleGroups: roleGroups,
          allAssignments: assignments,
          selectedRoles: selectedRoles
        };
      });
      
      let html = `<div class="portfolio-gantt">
        <div class="gantt-controls">
          <span style="color:#64748B;font-size:12px;margin-right:8px;">üìÖ Scale:</span>
          <button class="gantt-scale-btn ${portfolioTimeScale==='daily'?'active':''}" onclick="setPortfolioScale('daily')">Daily</button>
          <button class="gantt-scale-btn ${portfolioTimeScale==='weekly'?'active':''}" onclick="setPortfolioScale('weekly')">Weekly</button>
          <button class="gantt-scale-btn ${portfolioTimeScale==='monthly'?'active':''}" onclick="setPortfolioScale('monthly')">Monthly</button>
          <span style="flex:1;"></span>
          <span style="font-size:11px;color:#64748B;">üìä ${allProjects.length} projects</span>
        </div>
        <div class="gantt-scroll-container" id="portfolio-scroll">`;
      
      if (portfolioTimeScale === 'daily') {
        html += renderPortfolioDaily(fixedStart, fixedEnd, projectsWithRoles, today, colors);
      } else if (portfolioTimeScale === 'weekly') {
        html += renderPortfolioWeekly(fixedStart, fixedEnd, projectsWithRoles, today, colors);
      } else {
        html += renderPortfolioMonthly(fixedStart, fixedEnd, projectsWithRoles, today, colors);
      }
      
      html += `</div>
        <div style="padding:12px;border-top:1px solid #475569;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px;">
          <div style="font-size:11px;color:#64748B;">
            ‚úÖ ${allProjects.filter(p => p.status === 'Done' || p.status === 'Completed').length} completed ‚Ä¢ 
            üîÑ ${allProjects.filter(p => p.status === 'In Progress').length} in progress ‚Ä¢
            üìã ${allProjects.filter(p => p.status === 'Not Started').length} not started
          </div>
          <div style="display:flex;gap:12px;font-size:11px;">
            <span style="color:#EF4444;">‚ñåToday</span>
            <span style="color:#64748B;">Click project to view details</span>
          </div>
        </div>
      </div>`;
      
      container.innerHTML = html;
      
      // Auto-scroll to today
      const scrollContainer = document.getElementById('portfolio-scroll');
      if (scrollContainer) {
        setTimeout(() => {
          const todayDays = Math.ceil((today - fixedStart) / 864e5);
          const cellWidth = portfolioTimeScale === 'daily' ? 28 : (portfolioTimeScale === 'weekly' ? 60 : 100);
          const scrollTo = Math.max(0, (portfolioTimeScale === 'daily' ? todayDays * cellWidth : (portfolioTimeScale === 'weekly' ? todayDays / 7 * cellWidth : todayDays / 30 * cellWidth)) - 300);
          scrollContainer.scrollLeft = scrollTo;
        }, 100);
      }
    }
    
    function renderPortfolioDaily(start, end, projects, today, colors) {
      const totalDays = Math.ceil((end - start) / 864e5) + 1;
      const dayWidth = 28;
      
      let dates = [];
      for (let i = 0; i < totalDays; i++) {
        const d = new Date(start);
        d.setDate(d.getDate() + i);
        dates.push(d);
      }
      
      // Group by month
      let months = [];
      let currentMonth = '';
      let monthDays = 0;
      dates.forEach((d, i) => {
        const monthKey = d.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
        if (monthKey !== currentMonth) {
          if (currentMonth) months.push({ name: currentMonth, days: monthDays });
          currentMonth = monthKey;
          monthDays = 1;
        } else {
          monthDays++;
        }
      });
      months.push({ name: currentMonth, days: monthDays });

      // Role colors for portfolio
      const ROLE_COLORS = { PM: '#8B5CF6', Dev: '#EF4444', QA: '#F59E0B', Support: '#06B6D4', Lead: '#3B82F6' };
      const ROLE_ORDER = ['PM', 'Dev', 'QA', 'Support', 'Lead'];
      // Get selected roles from first project (they all have the same selection)
      const selectedRoles = projects.length > 0 ? (projects[0].selectedRoles || ROLE_ORDER) : ROLE_ORDER;

      let html = `<div class="gantt-wrapper">
        <div class="portfolio-project-column">
          <div class="portfolio-header-cell">Project / Role</div>`;

      // Project names with role sub-rows
      projects.forEach((p, idx) => {
        html += `<div class="portfolio-project-group">
          <div class="portfolio-project-name" onclick="openProject('${p.id}')" title="${p.name}" style="font-weight:600;">
            <span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:${p.color};margin-right:8px;flex-shrink:0;"></span>
            <span style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${p.name}</span>
          </div>`;

        // Render only selected roles that have members assigned
        selectedRoles.forEach(role => {
          const roleMembers = p.roleGroups[role] || [];
          if (roleMembers.length > 0) {
            const memberNames = roleMembers.map(a => a.member.name).join(', ');
            html += `<div class="portfolio-role-name" title="${memberNames}">
              <span style="background:${ROLE_COLORS[role]};color:white;padding:1px 6px;border-radius:3px;font-size:9px;margin-right:6px;">${role}</span>
              <span style="color:#94A3B8;font-size:10px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${memberNames}</span>
            </div>`;
          }
        });

        html += '</div>';
      });
      html += '</div>';

      // FIX: Add Start Date column - 32px rows to match Gantt bars
      html += `<div style="min-width:70px;max-width:70px;flex-shrink:0;background:#1E293B;">
        <div class="portfolio-header-cell" style="min-width:70px;max-width:70px;font-size:9px;padding:6px;text-align:center;height:72px;">Start</div>`;

      projects.forEach((p, idx) => {
        // Main project row - 32px height to match Gantt
        html += `<div class="portfolio-row" style="height:36px;display:flex;align-items:center;justify-content:center;border-right:1px solid #334155;background:#1E293B;font-size:9px;color:#94A3B8;">
          ${formatDateShort(p.startDate)}
        </div>`;

        // Role rows - empty, 32px height to match Gantt
        selectedRoles.forEach(role => {
          if (p.roleGroups[role] && p.roleGroups[role].length > 0) {
            html += `<div class="portfolio-row portfolio-role-row" style="height:36px;border-right:1px solid #334155;background:#1a2235;"></div>`;
          }
        });
      });
      html += '</div>';

      // FIX: Add End Date column - 32px rows to match Gantt bars
      html += `<div style="min-width:70px;max-width:70px;flex-shrink:0;background:#1E293B;">
        <div class="portfolio-header-cell" style="min-width:70px;max-width:70px;font-size:9px;padding:6px;text-align:center;height:72px;">End</div>`;

      projects.forEach((p, idx) => {
        // Main project row - 32px height to match Gantt
        html += `<div class="portfolio-row" style="height:36px;display:flex;align-items:center;justify-content:center;border-right:1px solid #334155;background:#1E293B;font-size:9px;color:#94A3B8;">
          ${formatDateShort(p.endDate)}
        </div>`;

        // Role rows - empty, 32px height to match Gantt
        selectedRoles.forEach(role => {
          if (p.roleGroups[role] && p.roleGroups[role].length > 0) {
            html += `<div class="portfolio-row portfolio-role-row" style="height:36px;border-right:1px solid #334155;background:#1a2235;"></div>`;
          }
        });
      });
      html += '</div>';

      html += '<div class="portfolio-timeline-column">';
      
      // Month headers
      html += '<div class="gantt-header-months">';
      months.forEach(m => {
        html += `<div class="gantt-month-label" style="min-width:${m.days * dayWidth}px;">${m.name}</div>`;
      });
      html += '</div>';
      
      // Day headers
      html += '<div class="gantt-timeline">';
      dates.forEach(d => {
        const isToday = d.toDateString() === today.toDateString();
        const isWeekend = d.getDay() === 0 || d.getDay() === 6;
        html += `<div class="gantt-date ${isWeekend ? 'weekend' : ''} ${isToday ? 'today' : ''}" style="min-width:${dayWidth}px;">
          <div class="gantt-date-day" style="font-size:10px;">${d.getDate()}</div>
        </div>`;
      });
      html += '</div>';
      
      // Project bars with role sub-bars
      html += '<div class="portfolio-body-rows">';
      projects.forEach((p, idx) => {
        const pStart = new Date(p.startDate);
        const pEnd = new Date(p.endDate);
        const leftDays = Math.max(0, Math.ceil((pStart - start) / 864e5));
        const widthDays = Math.max(1, Math.ceil((pEnd - pStart) / 864e5) + 1);

        let progress = 0;
        if (p.tasks && p.tasks.length > 0) {
          progress = Math.round(p.tasks.reduce((sum, t) => sum + (t.progress || 0), 0) / p.tasks.length);
        }

        // Today line position
        const todayDays = Math.ceil((today - start) / 864e5);
        const todayLineHtml = (todayDays >= 0 && todayDays <= totalDays) ?
          `<div class="gantt-today-line" style="left:${todayDays * dayWidth}px;"></div>` : '';

        // Main project bar row
        html += `<div class="portfolio-row"><div class="portfolio-bar-container" style="min-width:${totalDays * dayWidth}px;">
          ${todayLineHtml}
          <div class="portfolio-bar" onclick="openProject('${p.id}')"
               style="left:${leftDays * dayWidth}px;width:${widthDays * dayWidth}px;background:linear-gradient(135deg,#4B5563,#374151);"
               title="${p.name}: ${formatDateShort(p.startDate)} - ${formatDateShort(p.endDate)} (${progress}%)">
            ${widthDays * dayWidth > 50 ? `${progress}%` : ''}
          </div>
        </div></div>`;

        // Role bars for selected roles
        selectedRoles.forEach(role => {
          const roleMembers = p.roleGroups[role] || [];
          if (roleMembers.length > 0) {
            const memberNames = roleMembers.map(a => a.member.name).join(', ');
            html += `<div class="portfolio-row portfolio-role-row"><div class="portfolio-bar-container" style="min-width:${totalDays * dayWidth}px;">
              ${todayLineHtml}
              <div class="portfolio-bar portfolio-role-bar" onclick="openProject('${p.id}')"
                   style="left:${leftDays * dayWidth}px;width:${widthDays * dayWidth}px;background:linear-gradient(135deg,${ROLE_COLORS[role]},${ROLE_COLORS[role]}aa);height:18px;top:50%;transform:translateY(-50%);"
                   title="${role}: ${memberNames}">
                ${widthDays * dayWidth > 60 ? role : ''}
              </div>
            </div></div>`;
          }
        });
      });
      html += '</div></div></div>';

      return html;
    }
    
    function renderPortfolioWeekly(start, end, projects, today, colors) {
      const totalDays = Math.ceil((end - start) / 864e5) + 1;
      const totalWeeks = Math.ceil(totalDays / 7);
      const weekWidth = 60;
      
      let weeks = [];
      for (let i = 0; i < totalWeeks; i++) {
        const weekStart = new Date(start);
        weekStart.setDate(weekStart.getDate() + i * 7);
        weeks.push(weekStart);
      }
      
      // Group by month
      let months = [];
      let currentMonth = '';
      let monthWeeks = 0;
      weeks.forEach(w => {
        const monthKey = w.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
        if (monthKey !== currentMonth) {
          if (currentMonth) months.push({ name: currentMonth, weeks: monthWeeks });
          currentMonth = monthKey;
          monthWeeks = 1;
        } else {
          monthWeeks++;
        }
      });
      months.push({ name: currentMonth, weeks: monthWeeks });
      
      // Role colors for portfolio
      const ROLE_COLORS = { PM: '#8B5CF6', Dev: '#EF4444', QA: '#F59E0B', Support: '#06B6D4', Lead: '#3B82F6' };
      const ROLE_ORDER = ['PM', 'Dev', 'QA', 'Support', 'Lead'];
      // Get selected roles from first project (they all have the same selection)
      const selectedRoles = projects.length > 0 ? (projects[0].selectedRoles || ROLE_ORDER) : ROLE_ORDER;

      let html = `<div class="gantt-wrapper">
        <div class="portfolio-project-column">
          <div class="portfolio-header-cell">Project / Role</div>`;

      // Project names with role sub-rows
      projects.forEach((p, idx) => {
        html += `<div class="portfolio-project-group">
          <div class="portfolio-project-name" onclick="openProject('${p.id}')" title="${p.name}" style="font-weight:600;">
            <span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:${p.color};margin-right:8px;flex-shrink:0;"></span>
            <span style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${p.name}</span>
          </div>`;

        // Render only selected roles that have members assigned
        selectedRoles.forEach(role => {
          const roleMembers = p.roleGroups[role] || [];
          if (roleMembers.length > 0) {
            const memberNames = roleMembers.map(a => a.member.name).join(', ');
            html += `<div class="portfolio-role-name" title="${memberNames}">
              <span style="background:${ROLE_COLORS[role]};color:white;padding:1px 6px;border-radius:3px;font-size:9px;margin-right:6px;">${role}</span>
              <span style="color:#94A3B8;font-size:10px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${memberNames}</span>
            </div>`;
          }
        });

        html += '</div>';
      });
      html += '</div>';

      // FIX: Add Start Date column - 32px rows to match Gantt bars
      html += `<div style="min-width:70px;max-width:70px;flex-shrink:0;background:#1E293B;">
        <div class="portfolio-header-cell" style="min-width:70px;max-width:70px;font-size:9px;padding:6px;text-align:center;height:72px;">Start</div>`;

      projects.forEach((p, idx) => {
        // Main project row - 32px height to match Gantt
        html += `<div class="portfolio-row" style="height:36px;display:flex;align-items:center;justify-content:center;border-right:1px solid #334155;background:#1E293B;font-size:9px;color:#94A3B8;">
          ${formatDateShort(p.startDate)}
        </div>`;

        // Role rows - empty, 32px height to match Gantt
        selectedRoles.forEach(role => {
          if (p.roleGroups[role] && p.roleGroups[role].length > 0) {
            html += `<div class="portfolio-row portfolio-role-row" style="height:36px;border-right:1px solid #334155;background:#1a2235;"></div>`;
          }
        });
      });
      html += '</div>';

      // FIX: Add End Date column - 32px rows to match Gantt bars
      html += `<div style="min-width:70px;max-width:70px;flex-shrink:0;background:#1E293B;">
        <div class="portfolio-header-cell" style="min-width:70px;max-width:70px;font-size:9px;padding:6px;text-align:center;height:72px;">End</div>`;

      projects.forEach((p, idx) => {
        // Main project row - 32px height to match Gantt
        html += `<div class="portfolio-row" style="height:36px;display:flex;align-items:center;justify-content:center;border-right:1px solid #334155;background:#1E293B;font-size:9px;color:#94A3B8;">
          ${formatDateShort(p.endDate)}
        </div>`;

        // Role rows - empty, 32px height to match Gantt
        selectedRoles.forEach(role => {
          if (p.roleGroups[role] && p.roleGroups[role].length > 0) {
            html += `<div class="portfolio-row portfolio-role-row" style="height:36px;border-right:1px solid #334155;background:#1a2235;"></div>`;
          }
        });
      });
      html += '</div>';

      html += '<div class="portfolio-timeline-column">';

      // Month headers
      html += '<div class="gantt-header-months">';
      months.forEach(m => {
        html += `<div class="gantt-month-label" style="min-width:${m.weeks * weekWidth}px;">${m.name}</div>`;
      });
      html += '</div>';

      // Week headers
      html += '<div class="gantt-timeline">';
      weeks.forEach((w, i) => {
        const weekEnd = new Date(w);
        weekEnd.setDate(weekEnd.getDate() + 6);
        const isThisWeek = today >= w && today <= weekEnd;
        html += `<div class="gantt-date ${isThisWeek ? 'today' : ''}" style="min-width:${weekWidth}px;">
          <div class="gantt-date-day" style="font-size:10px;">${w.getDate()}-${weekEnd.getDate()}</div>
          <div class="gantt-date-week">W${i + 1}</div>
        </div>`;
      });
      html += '</div>';

      // Project bars with role sub-bars
      html += '<div class="portfolio-body-rows">';
      projects.forEach((p, idx) => {
        const pStart = new Date(p.startDate);
        const pEnd = new Date(p.endDate);
        const leftWeeks = Math.max(0, Math.floor((pStart - start) / 864e5 / 7));
        const widthWeeks = Math.max(1, Math.ceil((pEnd - pStart) / 864e5 / 7) + 1);

        let progress = 0;
        if (p.tasks && p.tasks.length > 0) {
          progress = Math.round(p.tasks.reduce((sum, t) => sum + (t.progress || 0), 0) / p.tasks.length);
        }

        // Today line
        const todayWeek = Math.floor((today - start) / 864e5 / 7);
        const dayInWeek = ((today - start) / 864e5) % 7;
        const todayLineHtml = (todayWeek >= 0 && todayWeek < totalWeeks) ?
          `<div class="gantt-today-line" style="left:${todayWeek * weekWidth + (dayInWeek / 7) * weekWidth}px;"></div>` : '';

        // Main project bar row
        html += `<div class="portfolio-row"><div class="portfolio-bar-container" style="min-width:${totalWeeks * weekWidth}px;">
          ${todayLineHtml}
          <div class="portfolio-bar" onclick="openProject('${p.id}')"
               style="left:${leftWeeks * weekWidth}px;width:${widthWeeks * weekWidth}px;background:linear-gradient(135deg,#4B5563,#374151);"
               title="${p.name}: ${formatDateShort(p.startDate)} - ${formatDateShort(p.endDate)}">
            ${progress}% ‚Ä¢ ${p.status}
          </div>
        </div></div>`;

        // Role bars for selected roles
        selectedRoles.forEach(role => {
          const roleMembers = p.roleGroups[role] || [];
          if (roleMembers.length > 0) {
            const memberNames = roleMembers.map(a => a.member.name).join(', ');
            const shortNames = roleMembers.map(a => a.member.name.split(' ')[0]).join(', ');
            html += `<div class="portfolio-row portfolio-role-row"><div class="portfolio-bar-container" style="min-width:${totalWeeks * weekWidth}px;">
              ${todayLineHtml}
              <div class="portfolio-bar portfolio-role-bar" onclick="openProject('${p.id}')"
                   style="left:${leftWeeks * weekWidth}px;width:${widthWeeks * weekWidth}px;background:linear-gradient(135deg,${ROLE_COLORS[role]},${ROLE_COLORS[role]}aa);height:18px;top:50%;transform:translateY(-50%);"
                   title="${role}: ${memberNames}">
                ${role}: ${shortNames}
              </div>
            </div></div>`;
          }
        });
      });
      html += '</div></div></div>';

      return html;
    }
    
    function renderPortfolioMonthly(start, end, projects, today, colors) {
      const monthWidth = 100;
      let months = [];
      let d = new Date(start);
      while (d <= end) {
        months.push(new Date(d));
        d.setMonth(d.getMonth() + 1);
      }
      
      // Role colors for portfolio
      const ROLE_COLORS = { PM: '#8B5CF6', Dev: '#EF4444', QA: '#F59E0B', Support: '#06B6D4', Lead: '#3B82F6' };
      const ROLE_ORDER = ['PM', 'Dev', 'QA', 'Support', 'Lead'];
      // Get selected roles from first project (they all have the same selection)
      const selectedRoles = projects.length > 0 ? (projects[0].selectedRoles || ROLE_ORDER) : ROLE_ORDER;

      let html = `<div class="gantt-wrapper">
        <div class="portfolio-project-column">
          <div class="portfolio-header-cell" style="height:44px;">Project / Role</div>`;

      // Project names with role sub-rows
      projects.forEach((p, idx) => {
        html += `<div class="portfolio-project-group">
          <div class="portfolio-project-name" onclick="openProject('${p.id}')" title="${p.name}" style="font-weight:600;">
            <span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:${p.color};margin-right:8px;flex-shrink:0;"></span>
            <span style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${p.name}</span>
          </div>`;

        // Render only selected roles that have members assigned
        selectedRoles.forEach(role => {
          const roleMembers = p.roleGroups[role] || [];
          if (roleMembers.length > 0) {
            const memberNames = roleMembers.map(a => a.member.name).join(', ');
            html += `<div class="portfolio-role-name" title="${memberNames}">
              <span style="background:${ROLE_COLORS[role]};color:white;padding:1px 6px;border-radius:3px;font-size:9px;margin-right:6px;">${role}</span>
              <span style="color:#94A3B8;font-size:10px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${memberNames}</span>
            </div>`;
          }
        });

        html += '</div>';
      });
      html += '</div>';

      // FIX: Add Start Date column - 32px rows to match Gantt bars
      html += `<div style="min-width:70px;max-width:70px;flex-shrink:0;background:#1E293B;">
        <div class="portfolio-header-cell" style="min-width:70px;max-width:70px;height:44px;font-size:9px;padding:6px;text-align:center;display:flex;align-items:center;justify-content:center;">Start</div>`;

      projects.forEach((p, idx) => {
        // Main project row - 32px height to match Gantt
        html += `<div class="portfolio-row" style="height:36px;display:flex;align-items:center;justify-content:center;border-right:1px solid #334155;background:#1E293B;font-size:9px;color:#94A3B8;">
          ${formatDateShort(p.startDate)}
        </div>`;

        // Role rows - empty, 32px height to match Gantt
        selectedRoles.forEach(role => {
          if (p.roleGroups[role] && p.roleGroups[role].length > 0) {
            html += `<div class="portfolio-row portfolio-role-row" style="height:36px;border-right:1px solid #334155;background:#1a2235;"></div>`;
          }
        });
      });
      html += '</div>';

      // FIX: Add End Date column - 32px rows to match Gantt bars
      html += `<div style="min-width:70px;max-width:70px;flex-shrink:0;background:#1E293B;">
        <div class="portfolio-header-cell" style="min-width:70px;max-width:70px;height:44px;font-size:9px;padding:6px;text-align:center;display:flex;align-items:center;justify-content:center;">End</div>`;

      projects.forEach((p, idx) => {
        // Main project row - 32px height to match Gantt
        html += `<div class="portfolio-row" style="height:36px;display:flex;align-items:center;justify-content:center;border-right:1px solid #334155;background:#1E293B;font-size:9px;color:#94A3B8;">
          ${formatDateShort(p.endDate)}
        </div>`;

        // Role rows - empty, 32px height to match Gantt
        selectedRoles.forEach(role => {
          if (p.roleGroups[role] && p.roleGroups[role].length > 0) {
            html += `<div class="portfolio-row portfolio-role-row" style="height:36px;border-right:1px solid #334155;background:#1a2235;"></div>`;
          }
        });
      });
      html += '</div>';

      html += '<div class="portfolio-timeline-column">';

      // Month headers
      html += '<div class="gantt-timeline">';
      months.forEach(m => {
        const isThisMonth = today.getMonth() === m.getMonth() && today.getFullYear() === m.getFullYear();
        html += `<div class="gantt-date ${isThisMonth ? 'today' : ''}" style="min-width:${monthWidth}px;">
          <div class="gantt-date-day">${m.toLocaleDateString('en-US', { month: 'short' })}</div>
          <div class="gantt-date-month">${m.getFullYear()}</div>
        </div>`;
      });
      html += '</div>';

      // Project bars with role sub-bars
      html += '<div class="portfolio-body-rows">';
      projects.forEach((p, idx) => {
        const pStart = new Date(p.startDate);
        const pEnd = new Date(p.endDate);
        const startMonthIdx = (pStart.getFullYear() - start.getFullYear()) * 12 + pStart.getMonth() - start.getMonth();
        const endMonthIdx = (pEnd.getFullYear() - start.getFullYear()) * 12 + pEnd.getMonth() - start.getMonth();
        const leftPos = Math.max(0, startMonthIdx + pStart.getDate() / 30) * monthWidth;
        const widthMonths = Math.max(0.5, endMonthIdx - startMonthIdx + 1);

        let progress = 0;
        if (p.tasks && p.tasks.length > 0) {
          progress = Math.round(p.tasks.reduce((sum, t) => sum + (t.progress || 0), 0) / p.tasks.length);
        }

        // Today line
        const todayMonthIdx = (today.getFullYear() - start.getFullYear()) * 12 + today.getMonth() - start.getMonth();
        const todayPos = todayMonthIdx * monthWidth + (today.getDate() / 30) * monthWidth;
        const todayLineHtml = (todayMonthIdx >= 0 && todayMonthIdx < months.length) ?
          `<div class="gantt-today-line" style="left:${todayPos}px;"></div>` : '';

        // Main project bar row
        html += `<div class="portfolio-row"><div class="portfolio-bar-container" style="min-width:${months.length * monthWidth}px;">
          ${todayLineHtml}
          <div class="portfolio-bar" onclick="openProject('${p.id}')"
               style="left:${leftPos}px;width:${widthMonths * monthWidth}px;background:linear-gradient(135deg,#4B5563,#374151);"
               title="${p.name}: ${formatDateShort(p.startDate)} - ${formatDateShort(p.endDate)}">
            ${progress}% ‚Ä¢ ${p.status}
          </div>
        </div></div>`;

        // Role bars for selected roles
        selectedRoles.forEach(role => {
          const roleMembers = p.roleGroups[role] || [];
          if (roleMembers.length > 0) {
            const memberNames = roleMembers.map(a => a.member.name).join(', ');
            const shortNames = roleMembers.map(a => a.member.name.split(' ')[0]).join(', ');
            html += `<div class="portfolio-row portfolio-role-row"><div class="portfolio-bar-container" style="min-width:${months.length * monthWidth}px;">
              ${todayLineHtml}
              <div class="portfolio-bar portfolio-role-bar" onclick="openProject('${p.id}')"
                   style="left:${leftPos}px;width:${widthMonths * monthWidth}px;background:linear-gradient(135deg,${ROLE_COLORS[role]},${ROLE_COLORS[role]}aa);height:18px;top:50%;transform:translateY(-50%);"
                   title="${role}: ${memberNames}">
                ${role}: ${shortNames}
              </div>
            </div></div>`;
          }
        });
      });
      html += '</div></div></div>';

      return html;
    }
    
    // BUG-1 FIX: Calculate hours from assigned projects across all members (matching Portfolio data)
    // This ensures consistency between Weekly Hours and Portfolio view
    function getWeeklyHoursSummary() {
      const s = {};
      Object.values(data.timeSlots).forEach(ms =>
        Object.values(ms).forEach(ds =>
          Object.values(ds).forEach(pid => {
            if(pid) s[pid] = (s[pid]||0)+1;
          })
        )
      );
      return s;
    }

    // SUG-1 FIX: Move "Total" to far left for better visibility
    let projectHoursExpanded = false;

    function toggleProjectHours() {
      projectHoursExpanded = !projectHoursExpanded;
      renderSummary();
    }

    function renderSummary() {
      const s = getWeeklyHoursSummary();
      let total = 0;

      // Calculate total first
      data.projects.forEach(p => {
        const h = s[p.id]||0;
        total += h;
      });

      // Calculate Target Hours (sum of all savingHours)
      const targetHours = data.projects.reduce((sum, p) => sum + (p.savingHours || 0), 0);

      // Calculate Actual Hours (sum of actualSavingHours for Completed projects only)
      const actualHours = data.projects
        .filter(p => p.status === 'Completed' || p.status === 'Done')
        .reduce((sum, p) => sum + (p.actualSavingHours || 0), 0);

      // Build project saving hours list (for expandable section)
      const projectsWithSavingHours = data.projects.filter(p => p.savingHours || p.actualSavingHours);
      const projectCount = projectsWithSavingHours.length;

      let projectListHtml = '';
      if (projectHoursExpanded && projectCount > 0) {
        projectListHtml = `
          <div style="display:flex;flex-wrap:wrap;gap:8px;margin-top:12px;padding-top:12px;border-top:1px solid #475569;">
            ${projectsWithSavingHours.map(p => {
              const isCompleted = p.status === 'Completed' || p.status === 'Done';
              return `
                <div onclick="openProject('${p.id}')" style="background:#0F172A;padding:8px 12px;border-radius:8px;cursor:pointer;min-width:140px;border-left:3px solid ${isCompleted ? '#3B82F6' : '#10B981'};" title="Click to view project">
                  <div style="font-size:11px;color:#94A3B8;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:120px;">${p.name}</div>
                  <div style="display:flex;gap:8px;margin-top:4px;">
                    ${p.savingHours ? `<span style="font-size:12px;color:#10B981;font-weight:600;">üéØ ${p.savingHours}h</span>` : ''}
                    ${p.actualSavingHours ? `<span style="font-size:12px;color:#3B82F6;font-weight:600;">‚úÖ ${p.actualSavingHours}h</span>` : ''}
                  </div>
                  ${isCompleted ? '<span style="font-size:9px;color:#64748B;">Completed</span>' : ''}
                </div>
              `;
            }).join('')}
          </div>
        `;
      }

      // SUG-1: Place Total card first, then Target and Actual hours cards with expandable toggle
      const html = `
        <div class="summary-card total"><div class="summary-hours">${total}h</div><div class="summary-name">Total</div></div>
        <div class="summary-card" style="background:linear-gradient(135deg,#10B981,#059669);cursor:pointer;" onclick="toggleProjectHours()" title="Click to ${projectHoursExpanded ? 'collapse' : 'expand'} project details">
          <div class="summary-hours">${targetHours}h</div>
          <div class="summary-name">Target Saving ${projectCount > 0 ? `<span style="font-size:10px;">(${projectCount})</span>` : ''}</div>
          <div style="font-size:10px;margin-top:2px;">${projectHoursExpanded ? '‚ñ≤ Collapse' : '‚ñº Expand'}</div>
        </div>
        <div class="summary-card" style="background:linear-gradient(135deg,#3B82F6,#1D4ED8);cursor:pointer;" onclick="toggleProjectHours()" title="Click to ${projectHoursExpanded ? 'collapse' : 'expand'} project details">
          <div class="summary-hours">${actualHours}h</div>
          <div class="summary-name">Actual Saving</div>
          <div style="font-size:10px;margin-top:2px;">${projectHoursExpanded ? '‚ñ≤ Collapse' : '‚ñº Expand'}</div>
        </div>
      `;

      document.getElementById('summary-cards').innerHTML = html + projectListHtml;
    }

    function renderProjectPool() {
      const c = document.getElementById('project-pool');
      const projects = data.projectPool.map(id => getProjectById(id)).filter(Boolean);
      if (!projects.length) { c.innerHTML = '<div class="pool-empty">No projects in pool. Click + to create one.</div>'; return; }
      c.innerHTML = projects.map(p => {
        // SUG-3: Add background color for "In Progress" status (yellow/orange)
        const statusStyle = p.status === 'In Progress' ? 'background:#F59E0B;color:#0F172A;font-weight:600;' : '';
        // SUG-7: Calculate risk status for project
        const riskStatus = calculateRiskStatus(p);
        // Get distinct project color
        const pColor = getProjectCardColor(p.id);
        return `
        <div class="pool-project" draggable="true" data-project-id="${p.id}"
             ondragstart="handleDragStart(event, '${p.id}')"
             ondragend="handleDragEnd(event)" style="border-left:4px solid ${pColor.bg};background:linear-gradient(135deg, ${pColor.bg}20 0%, #334155 100%);${riskStatus.isRisk ? 'box-shadow:0 0 0 2px #EF4444;' : ''}">
          <div class="pool-project-header">
            <span class="pool-project-name" onclick="openProject('${p.id}')" style="color:${pColor.bg};">${p.name}</span>
            <span class="${getPriorityClass(p.priority)}">${p.priority}</span>
          </div>
          <p class="pool-project-desc" onclick="openProject('${p.id}')">${p.description || 'No description'}</p>
          ${riskStatus.isRisk ? `<div style="background:#FEE2E2;color:#DC2626;padding:6px 8px;border-radius:6px;font-size:10px;margin-bottom:8px;font-weight:600;">‚ö†Ô∏è RISK: ${riskStatus.reason}</div>` : ''}
          <div class="pool-project-meta" style="display:flex;align-items:center;flex-wrap:wrap;">
            <span class="pool-project-date">üìÖ ${formatDateShort(p.startDate)} - ${formatDateShort(p.endDate)}</span>
            <span class="pool-project-date" style="${statusStyle}">${p.status}</span>
            ${p.team ? `<span class="pool-project-date">üë• ${p.team}</span>` : ''}
            ${p.savingHours ? `<span class="pool-project-date" style="background:#10B981;color:white;">‚è±Ô∏è ${p.savingHours}h/mo</span>` : ''}
            <button class="btn btn-primary btn-sm" onclick="openQuickAssign('${p.id}', event)" style="margin-left:auto;padding:4px 8px;font-size:10px;">üë• Assign</button>
          </div>
        </div>
      `;
      }).join('');
    }

    function renderTeamBoards() {
      // Define available roles
      const PROJECT_ROLES = ['PM', 'Dev', 'QA', 'Support', 'Lead'];

      // Get selected roles from filter checkboxes
      const filterContainer = document.getElementById('team-role-filter');
      const selectedRoles = filterContainer
        ? Array.from(filterContainer.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.value)
        : PROJECT_ROLES;

      // Get search text
      const searchInput = document.getElementById('team-project-search');
      const searchText = searchInput ? searchInput.value.toLowerCase().trim() : '';

      // Sort members: current user's member first (for mobile), then others
      const currentMemberId = getCurrentUserMemberId();
      const sortedMembers = [...data.members].sort((a, b) => {
        if (a.id === currentMemberId) return -1;
        if (b.id === currentMemberId) return 1;
        return 0;
      });

      document.getElementById('team-boards').innerHTML = sortedMembers.map(m => {
        const assignments = data.memberProjects[m.id] || [];
        const isCurrentUser = m.id === currentMemberId;
        // Handle both old format (array of IDs) and new format (array of objects with id and role)
        const projectsWithRoles = assignments.map(a => {
          if (typeof a === 'string') {
            // Old format - just project ID
            return { project: getProjectById(a), role: null };
          } else {
            // New format - object with id and role
            return { project: getProjectById(a.id), role: a.role };
          }
        }).filter(pr => pr.project)
          // Filter by selected roles
          .filter(pr => {
            if (!pr.role) return selectedRoles.length === PROJECT_ROLES.length; // Show unassigned roles only if all filters are selected
            return selectedRoles.includes(pr.role);
          })
          // Filter by search text
          .filter(pr => {
            if (!searchText) return true;
            const p = pr.project;
            return p.name.toLowerCase().includes(searchText) ||
                   (p.description && p.description.toLowerCase().includes(searchText)) ||
                   (p.status && p.status.toLowerCase().includes(searchText)) ||
                   (p.team && p.team.toLowerCase().includes(searchText));
          });
        
        return `<div class="board ${isCurrentUser ? 'current-user-board' : ''}" style="border-color:${m.color}${isCurrentUser ? ';box-shadow:0 0 20px '+m.color+'40;' : ''}" data-member-id="${m.id}"
                     ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" ondrop="handleDropWithRole(event, '${m.id}')">
          <div class="board-header">
            <div class="board-member">
              <span class="board-avatar" style="background:${m.color}">${m.avatar}</span>
              <div>
                <div class="board-name">${m.name} ${isCurrentUser ? '<span style="font-size:10px;background:#10B981;color:white;padding:2px 6px;border-radius:10px;margin-left:6px;">You</span>' : ''}</div>
                <div class="board-role">${m.role}</div>
              </div>
            </div>
            ${isAdmin() ? `<div class="board-actions">
              <button class="btn btn-secondary btn-icon btn-sm" onclick="editMember('${m.id}')">‚úèÔ∏è</button>
              <button class="btn btn-danger btn-icon btn-sm" onclick="deleteMember('${m.id}')">üóëÔ∏è</button>
            </div>` : ''}
          </div>
          <div class="board-count">${projectsWithRoles.length} project${projectsWithRoles.length!==1?'s':''}</div>
          ${projectsWithRoles.length ? `<div class="board-projects">${projectsWithRoles.map(pr => {
            const p = pr.project;
            const role = pr.role;
            // SUG-7: Calculate risk status
            const riskStatus = calculateRiskStatus(p);
            // Get distinct project color
            const pColor = getProjectCardColor(p.id);
            return `
            <div class="board-project-item" draggable="true" data-project-id="${p.id}"
                 style="border-left: 4px solid ${pColor.bg};background:linear-gradient(135deg, ${pColor.bg}25 0%, ${pColor.bg}10 100%);${riskStatus.isRisk ? 'box-shadow:0 0 0 2px #EF4444;' : ''}cursor:pointer;"
                 ondragstart="handleDragStart(event, '${p.id}')" ondragend="handleDragEnd(event)"
                 onclick="handleProjectCardClick(event, '${p.id}')">
              <div class="board-project-header">
                <span class="board-project-name" style="color:${pColor.bg};font-weight:600;">${p.name}${riskStatus.isRisk ? ' ‚ö†Ô∏è' : ''}</span>
                <span class="${getPriorityClass(p.priority)}" style="font-size:10px;padding:2px 6px;">${p.priority}</span>
              </div>
              ${riskStatus.isRisk ? `<div style="background:#FEE2E2;color:#DC2626;padding:4px 6px;border-radius:4px;font-size:9px;margin-bottom:4px;font-weight:600;">${riskStatus.reason}</div>` : ''}
              <div class="board-project-meta">
                ${role ? `<span class="board-project-role role-${role.toLowerCase()}">${role}</span>` : ''}
                <span class="board-project-status" style="${p.status === 'In Progress' ? 'background:#F59E0B;color:#0F172A;font-weight:600;' : ''}">${p.status}</span>
                ${p.savingHours ? `<span class="board-project-status" style="background:#10B981;color:white;">‚è±Ô∏è ${p.savingHours}h/mo</span>` : ''}
                <button class="btn btn-secondary btn-sm" onclick="openQuickAssign('${p.id}', event)" style="margin-left:auto;padding:2px 6px;font-size:9px;">‚ÜîÔ∏è</button>
              </div>
            </div>`;
          }).join('')}</div>` : ''}
          <div class="board-dropzone" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" ondrop="handleDropWithRole(event, '${m.id}')">
            üì• Drop project here
          </div>
        </div>`;
      }).join('');
    }
    
    // Drag and Drop Handlers
    let draggedProjectId = null;
    
    function handleDragStart(e, projectId) {
      draggedProjectId = projectId;
      e.target.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'move';
      e.dataTransfer.setData('text/plain', projectId);
    }
    
    function handleDragEnd(e) {
      e.target.classList.remove('dragging');
      draggedProjectId = null;
      document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
    }
    
    function handleDragOver(e) {
      e.preventDefault();
      e.dataTransfer.dropEffect = 'move';
      const board = e.target.closest('.board') || e.target.closest('.board-dropzone');
      if (board) board.classList.add('drag-over');
    }
    
    function handleDragLeave(e) {
      const board = e.target.closest('.board') || e.target.closest('.board-dropzone');
      if (board && !board.contains(e.relatedTarget)) {
        board.classList.remove('drag-over');
      }
    }

    // FIX: Handle clicking on member project cards to open project detail
    function handleProjectCardClick(e, projectId) {
      // Don't open project if clicking on the assign button or other interactive elements
      if (e.target.tagName === 'BUTTON' || e.target.closest('button')) {
        return; // Let the button handle its own click
      }
      // Open the project detail page
      openProject(projectId);
    }

    function handleDrop(e, memberId) {
      e.preventDefault();
      const board = e.target.closest('.board');
      if (board) board.classList.remove('drag-over');
      
      const projectId = e.dataTransfer.getData('text/plain') || draggedProjectId;
      if (!projectId || !memberId) return;
      
      // For backward compatibility, assign without role
      assignProjectToMember(projectId, memberId, null);
    }
    
    // New drop handler that shows role selection
    function handleDropWithRole(e, memberId) {
      e.preventDefault();
      const board = e.target.closest('.board');
      if (board) board.classList.remove('drag-over');
      
      const projectId = e.dataTransfer.getData('text/plain') || draggedProjectId;
      if (!projectId || !memberId) return;
      
      // Show role selection modal
      openRoleSelectModal(projectId, memberId);
    }
    
    // Role selection modal
    let pendingAssignment = { projectId: null, memberId: null };
    
    function openRoleSelectModal(projectId, memberId) {
      pendingAssignment = { projectId, memberId };
      const p = getProjectById(projectId);
      const m = data.members.find(x => x.id === memberId);
      if (!p || !m) return;
      
      const roles = ['PM', 'Dev', 'QA', 'Support', 'Lead'];
      const roleButtons = roles.map(role => 
        `<button class="btn btn-secondary" style="flex:1;min-width:60px;" onclick="confirmRoleAssignment('${role}')">${role}</button>`
      ).join('');
      
      document.getElementById('roleselect-content').innerHTML = `
        <p style="margin-bottom:12px;color:#94A3B8;">Assign "<b>${p.name}</b>" to <b>${m.name}</b> as:</p>
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:16px;">
          ${roleButtons}
        </div>
        <button class="btn btn-primary" style="width:100%;" onclick="confirmRoleAssignment(null)">
          Assign without role
        </button>
      `;
      document.getElementById('modal-roleselect').classList.remove('hidden');
    }
    
    function confirmRoleAssignment(role) {
      const { projectId, memberId } = pendingAssignment;
      if (projectId && memberId) {
        assignProjectToMember(projectId, memberId, role);
      }
      closeModal('roleselect');
      pendingAssignment = { projectId: null, memberId: null };
    }
    
    // SUG-2 FIX: Allow assigning ONE project to MULTIPLE people
    // Projects stay in pool until explicitly removed
    function assignProjectToMember(projectId, memberId, role) {
      // Initialize member's project array if needed
      if (!data.memberProjects[memberId]) data.memberProjects[memberId] = [];

      // Check if already assigned to this member
      const existingIdx = data.memberProjects[memberId].findIndex(a => {
        if (typeof a === 'string') return a === projectId;
        return a.id === projectId;
      });

      if (existingIdx >= 0) {
        // Update role if already assigned
        data.memberProjects[memberId][existingIdx] = { id: projectId, role: role };
        showToast('Role updated!');
      } else {
        // Add new assignment
        data.memberProjects[memberId].push({ id: projectId, role: role });
        showToast('Project assigned!');

        // FIX: Remove from pool when first assigned (drag from pool to member)
        // This ensures the card disappears from pool after drop
        if (data.projectPool.includes(projectId)) {
          data.projectPool = data.projectPool.filter(pid => pid !== projectId);
        }
      }

      saveData();
      // BUG-3 FIX: Refresh dashboard immediately to show updated assignee names
      renderDashboard();
      // Re-open modal to show updated assignments
      openQuickAssign(projectId);
    }
    
    // Mobile-friendly quick assign modal
    // Store pending role changes for quickassign modal
    let pendingRoleChanges = {};

    function openQuickAssign(projectId, e) {
      if (e) e.stopPropagation();
      const p = getProjectById(projectId);
      if (!p) return;

      // Find current assignments for this project
      const currentAssignments = {};
      Object.keys(data.memberProjects).forEach(mid => {
        const assignments = data.memberProjects[mid] || [];
        assignments.forEach(a => {
          const aId = typeof a === 'string' ? a : a.id;
          const aRole = typeof a === 'string' ? null : a.role;
          if (aId === projectId) {
            currentAssignments[mid] = aRole;
          }
        });
      });

      // Initialize pending changes with current state
      pendingRoleChanges = { ...currentAssignments };

      renderQuickAssignContent(projectId, p);
      document.getElementById('modal-quickassign').classList.remove('hidden');
    }

    function renderQuickAssignContent(projectId, p) {
      const roles = ['PM', 'Dev', 'QA', 'Support', 'Lead'];
      const roleColors = { PM: '#8B5CF6', Dev: '#EF4444', QA: '#F59E0B', Support: '#06B6D4', Lead: '#3B82F6' };

      const memberOptions = data.members.map(m => {
        const currentRole = pendingRoleChanges[m.id];
        const isAssigned = currentRole !== undefined;

        return `
          <div style="margin-bottom:10px;padding:10px;background:#1E293B;border-radius:8px;border-left:4px solid ${m.color};">
            <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
              <span style="background:${m.color};width:28px;height:28px;border-radius:50%;display:inline-flex;align-items:center;justify-content:center;font-size:12px;">${m.avatar}</span>
              <span style="flex:1;font-weight:600;font-size:14px;">${m.name}</span>
              ${isAssigned ? `<span style="font-size:10px;color:#10B981;background:#10B98133;padding:2px 8px;border-radius:4px;">‚úì Assigned${currentRole ? ` as ${currentRole}` : ''}</span>` : '<span style="font-size:10px;color:#64748B;">Not assigned</span>'}
            </div>
            <div style="display:flex;gap:6px;flex-wrap:wrap;">
              ${roles.map(role => {
                const isSelected = currentRole === role;
                const btnStyle = isSelected
                  ? `background:${roleColors[role]};color:white;border:2px solid ${roleColors[role]};`
                  : `background:transparent;color:${roleColors[role]};border:2px solid ${roleColors[role]};`;
                return `<button class="btn btn-sm" style="padding:4px 10px;font-size:11px;font-weight:600;${btnStyle}"
                        onclick="toggleRoleSelection('${projectId}','${m.id}','${role}')">${role}</button>`;
              }).join('')}
              <button class="btn btn-sm" style="padding:4px 10px;font-size:11px;${currentRole === null && isAssigned ? 'background:#3B82F6;color:white;border:2px solid #3B82F6;' : 'background:transparent;color:#3B82F6;border:2px solid #3B82F6;'}"
                      onclick="toggleRoleSelection('${projectId}','${m.id}','none')">No Role</button>
              ${isAssigned ? `<button class="btn btn-sm" style="padding:4px 10px;font-size:11px;background:transparent;color:#EF4444;border:2px solid #EF4444;"
                      onclick="toggleRoleSelection('${projectId}','${m.id}','remove')">‚úï Remove</button>` : ''}
            </div>
          </div>
        `;
      }).join('');

      // Count changes
      const assignedCount = Object.keys(pendingRoleChanges).length;

      document.getElementById('quickassign-content').innerHTML = `
        <p style="margin-bottom:12px;color:#94A3B8;font-size:13px;">Assign roles for "<b>${p.name}</b>"</p>
        <p style="margin-bottom:12px;font-size:11px;color:#64748B;">Click on a role to assign/change. Changes are saved when you click Save.</p>
        <div style="max-height:350px;overflow-y:auto;margin-bottom:12px;">
          ${memberOptions}
        </div>
        <div style="display:flex;gap:8px;">
          <button class="btn btn-primary" style="flex:1;" onclick="saveQuickAssignChanges('${projectId}')">
            üíæ Save Changes ${assignedCount > 0 ? `(${assignedCount} assigned)` : ''}
          </button>
          <button class="btn btn-secondary" onclick="closeModal('quickassign')">Cancel</button>
        </div>
        <button class="btn btn-secondary" style="width:100%;margin-top:8px;color:#EF4444;border-color:#EF4444;"
                onclick="if(confirm('Remove all assignments?')){returnToPool('${projectId}');closeModal('quickassign');}">
          üì¶ Return to Pool (Remove All)
        </button>
      `;
    }

    function toggleRoleSelection(projectId, memberId, role) {
      const p = getProjectById(projectId);
      if (!p) return;

      if (role === 'remove') {
        // Remove assignment
        delete pendingRoleChanges[memberId];
      } else if (role === 'none') {
        // Assign with no specific role
        pendingRoleChanges[memberId] = null;
      } else {
        // Check if clicking same role (toggle off to unassigned)
        if (pendingRoleChanges[memberId] === role) {
          delete pendingRoleChanges[memberId];
        } else {
          // Assign with specific role
          pendingRoleChanges[memberId] = role;
        }
      }

      // Re-render the content
      renderQuickAssignContent(projectId, p);
    }

    function saveQuickAssignChanges(projectId) {
      // First, remove all existing assignments for this project
      Object.keys(data.memberProjects).forEach(mid => {
        if (!data.memberProjects[mid]) data.memberProjects[mid] = [];
        data.memberProjects[mid] = data.memberProjects[mid].filter(a => {
          const aId = typeof a === 'string' ? a : a.id;
          return aId !== projectId;
        });
      });

      // Add new assignments based on pendingRoleChanges
      Object.keys(pendingRoleChanges).forEach(memberId => {
        if (!data.memberProjects[memberId]) data.memberProjects[memberId] = [];
        const role = pendingRoleChanges[memberId];
        data.memberProjects[memberId].push({ id: projectId, role: role });
      });

      // Handle pool status
      const hasAssignments = Object.keys(pendingRoleChanges).length > 0;
      if (hasAssignments) {
        // Remove from pool if assigned
        data.projectPool = data.projectPool.filter(pid => pid !== projectId);
      } else {
        // Add to pool if not assigned to anyone
        if (!data.projectPool.includes(projectId)) {
          data.projectPool.push(projectId);
        }
      }

      // Save and refresh
      saveData();
      closeModal('quickassign');
      renderDashboard();
      if (currentProjectId === projectId) {
        renderProjectDetail();
      }
      showToast('Assignments saved!');
    }
    
    function removeAssignment(projectId, memberId) {
      if (!data.memberProjects[memberId]) return;
      
      data.memberProjects[memberId] = data.memberProjects[memberId].filter(a => {
        const aId = typeof a === 'string' ? a : a.id;
        return aId !== projectId;
      });
      
      // If no more assignments, add back to pool
      let hasAssignments = false;
      Object.keys(data.memberProjects).forEach(mid => {
        const assignments = data.memberProjects[mid] || [];
        if (assignments.some(a => (typeof a === 'string' ? a : a.id) === projectId)) {
          hasAssignments = true;
        }
      });
      
      if (!hasAssignments && !data.projectPool.includes(projectId)) {
        data.projectPool.push(projectId);
      }
      
      saveData();
      renderDashboard();
      // Refresh the modal
      openQuickAssign(projectId);
      showToast('Assignment removed!');
    }
    
    function returnToPool(projectId) {
      // Remove from all members
      Object.keys(data.memberProjects).forEach(mid => {
        data.memberProjects[mid] = data.memberProjects[mid].filter(a => {
          const aId = typeof a === 'string' ? a : a.id;
          return aId !== projectId;
        });
      });
      
      // Add to pool if not there
      if (!data.projectPool.includes(projectId)) {
        data.projectPool.push(projectId);
      }
      
      saveData();
      renderDashboard();
      showToast('Project returned to pool!');
    }
    
    // Pool drag handlers - to return projects to pool
    function handlePoolDragOver(e) {
      e.preventDefault();
      e.dataTransfer.dropEffect = 'move';
      e.currentTarget.classList.add('drag-over');
    }
    
    function handlePoolDragLeave(e) {
      if (!e.currentTarget.contains(e.relatedTarget)) {
        e.currentTarget.classList.remove('drag-over');
      }
    }
    
    function handlePoolDrop(e) {
      e.preventDefault();
      e.currentTarget.classList.remove('drag-over');
      
      const projectId = e.dataTransfer.getData('text/plain') || draggedProjectId;
      if (!projectId) return;
      
      returnToPool(projectId);
    }

    // ==================== PROJECT DETAIL ====================
    function openProject(pid) { currentProjectId = pid; activeTab = 'brief'; showView('project'); }

    function renderProjectDetail() {
      const p = getProjectById(currentProjectId);
      if (!p) { showView('dashboard'); return; }
      
      document.getElementById('project-title').innerHTML = `
        <h1 class="detail-name">${p.name}</h1>
        <span class="${getPriorityClass(p.priority)}">${p.priority}</span>
        <span class="status-badge" onclick="cycleStatus()" title="Click to change status">${p.status}</span>
        ${p.team ? `<span style="background:#1E293B;padding:6px 12px;border-radius:16px;font-size:11px;color:#38BDF8;">üë• ${p.team}</span>` : ''}
        ${p.savingHours ? `<span style="background:#10B981;padding:6px 12px;border-radius:16px;font-size:11px;color:white;">‚è±Ô∏è ${p.savingHours}h/mo saved</span>` : ''}
        ${p.lockedTimeline ? `<span style="background:#F59E0B;padding:6px 12px;border-radius:16px;font-size:11px;color:white;">üîí Timeline Locked</span>` : ''}
      `;
      document.getElementById('project-desc').textContent = p.description || '';
      
      // Get all assignments for this project
      const projectAssignments = [];
      for (const [mid, assignments] of Object.entries(data.memberProjects)) {
        const memberAssignments = assignments || [];
        memberAssignments.forEach(a => {
          const aId = typeof a === 'string' ? a : a.id;
          const aRole = typeof a === 'string' ? null : a.role;
          if (aId === p.id) {
            const member = getMemberById(mid);
            if (member) projectAssignments.push({ member, role: aRole });
          }
        });
      }
      
      // Build assignments display
      let assignmentsHtml = '';
      if (projectAssignments.length > 0) {
        assignmentsHtml = `<div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;">
          ${projectAssignments.map(pa => `
            <span style="display:inline-flex;align-items:center;gap:4px;background:#334155;padding:4px 8px;border-radius:16px;font-size:11px;">
              <span style="background:${pa.member.color};width:18px;height:18px;border-radius:50%;display:inline-flex;align-items:center;justify-content:center;font-size:9px;">${pa.member.avatar}</span>
              ${pa.member.name}
              ${pa.role ? `<span class="board-project-role role-${pa.role.toLowerCase()}" style="margin-left:2px;">${pa.role}</span>` : ''}
            </span>
          `).join('')}
          <button class="btn btn-secondary btn-sm" onclick="openQuickAssign('${p.id}')" style="padding:4px 8px;font-size:10px;">‚úèÔ∏è Edit</button>
        </div>`;
      } else {
        assignmentsHtml = `<button class="btn btn-secondary btn-sm" onclick="openQuickAssign('${p.id}')">üë§ Assign Team</button>`;
      }
      
      let actionsHtml = '';
      if (isAdmin()) {
        actionsHtml = `
          <button class="btn btn-primary btn-sm" onclick="openEditProjectModal()">‚úèÔ∏è Edit</button>
          ${assignmentsHtml}
          <button class="btn ${p.lockedTimeline ? 'btn-secondary' : 'lock-btn'} btn-sm" onclick="toggleProjectLock()">
            ${p.lockedTimeline ? 'üîì Unlock Timeline' : 'üîí Lock Timeline'}
          </button>
          <button class="btn btn-danger btn-sm" onclick="deleteCurrentProject()">üóëÔ∏è Delete</button>
        `;
      } else {
        actionsHtml = `
          ${assignmentsHtml}
          <span style="color:#64748B;font-size:11px;font-style:italic;">Contact admin to edit project details</span>
        `;
      }
      document.getElementById('project-actions').innerHTML = actionsHtml;
      
      document.getElementById('project-tabs').innerHTML = ['brief', 'timeline', 'details', 'updates'].map(t => 
        `<button class="tab ${activeTab===t?'active':''}" onclick="switchTab('${t}')">${t === 'brief' ? 'üìã Brief' : t === 'timeline' ? 'üìä Timeline' : t === 'details' ? 'üìÅ Details' : 'üí¨ Updates'}</button>`
      ).join('');
      renderTabContent();
    }
    
    function toggleProjectLock() {
      if (!isAdmin()) return;
      const p = getProjectById(currentProjectId);
      p.lockedTimeline = !p.lockedTimeline;
      saveData();
      renderProjectDetail();
      showToast(p.lockedTimeline ? 'Timeline locked' : 'Timeline unlocked');
    }

    function cycleStatus() {
      const p = getProjectById(currentProjectId);
      const statuses = ['Not Started', 'Planning', 'In Progress', 'On Hold', 'Completed'];
      const currentIdx = statuses.indexOf(p.status);
      
      // Show simple menu for status selection
      const choice = prompt(`Select status (1-5):
1. Not Started
2. Planning  
3. In Progress
4. On Hold
5. Completed

Current: ${p.status}`, currentIdx + 1);
      
      if (choice !== null) {
        const idx = parseInt(choice) - 1;
        if (idx >= 0 && idx < statuses.length) {
          p.status = statuses[idx];
          saveData(); 
          renderProjectDetail(); 
          showToast('Status updated to: ' + p.status);
        }
      }
    }

    function switchTab(t) { activeTab = t; renderProjectDetail(); }

    function renderTabContent() {
      const c = document.getElementById('tab-content');
      if (activeTab === 'brief') renderBrief(c);
      else if (activeTab === 'timeline') renderGantt(c);
      else if (activeTab === 'details') renderDetails(c);
      else renderUpdates(c);
    }

    // ==================== BRIEF TAB ====================
    function renderBrief(c) {
      const p = getProjectById(currentProjectId);
      c.innerHTML = `
        <div style="margin-bottom:16px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px;">
          <h3 style="font-size:16px;font-weight:600;">üìù Project Brief</h3>
          <button class="btn btn-primary btn-sm" onclick="openEditProjectModal()">‚úèÔ∏è Edit Brief</button>
        </div>
        <div class="brief-view">${p.brief || ''}</div>
        <div style="margin-top:20px;padding-top:20px;border-top:1px solid #334155;">
          <h4 style="font-size:14px;font-weight:600;margin-bottom:12px;">üìã Project Info</h4>
          <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:12px;margin-bottom:16px;">
            ${p.team ? `<div style="background:#0F172A;padding:12px;border-radius:8px;"><span style="color:#64748B;font-size:11px;display:block;">User Team</span><strong style="color:#38BDF8;">üë• ${p.team}</strong></div>` : ''}
            ${p.savingHours ? `<div style="background:#0F172A;padding:12px;border-radius:8px;"><span style="color:#64748B;font-size:11px;display:block;">Target Saving Hours/Month</span><strong style="color:#10B981;">üéØ ${p.savingHours} hours</strong></div>` : ''}
            ${p.actualSavingHours ? `<div style="background:#0F172A;padding:12px;border-radius:8px;"><span style="color:#64748B;font-size:11px;display:block;">Actual Saving Hours/Month</span><strong style="color:#3B82F6;">‚úÖ ${p.actualSavingHours} hours</strong></div>` : ''}
          </div>
          <h4 style="font-size:14px;font-weight:600;margin-bottom:12px;">üìÖ Expected Timeline</h4>
          <div style="display:flex;gap:20px;flex-wrap:wrap;">
            <div><span style="color:#64748B;font-size:13px;">Start:</span> <strong>${formatDate(p.startDate)}</strong></div>
            <div><span style="color:#64748B;font-size:13px;">End:</span> <strong>${formatDate(p.endDate)}</strong></div>
            <div><span style="color:#64748B;font-size:13px;">Duration:</span> <strong>${calcDuration(p.startDate, p.endDate)} days</strong></div>
          </div>
        </div>
      `;
    }

    // ==================== GANTT ====================
    function setGanttScale(scale) {
      if (!data.settings) data.settings = {};
      data.settings.ganttTimeScale = scale;
      saveData();
      renderGantt(document.getElementById('tab-content'));
    }
    
    function setPortfolioScale(scale) {
      if (!data.settings) data.settings = {};
      data.settings.portfolioTimeScale = scale;
      saveData();
      renderPortfolio();
    }
    
    function renderGantt(c) {
      const p = getProjectById(currentProjectId);
      const tasks = p.tasks || [];
      
      // Get timescale from settings
      if (!data.settings) data.settings = {};
      const ganttTimeScale = data.settings.ganttTimeScale || 'daily';
      
      // Fixed start date: Jan 1, 2026
      const fixedStart = new Date('2026-01-01');
      // End date: Dec 31, 2026 or project end + 30 days, whichever is later
      const projectEnd = p.endDate ? new Date(p.endDate) : new Date('2026-12-31');
      const fixedEnd = new Date(Math.max(new Date('2026-12-31').getTime(), projectEnd.getTime() + 30 * 864e5));
      
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      
      // Check if user can add tasks - when timeline is locked, NO ONE can add (not even admin)
      const canAddTask = !p.lockedTimeline;
      
      const containerDayWidth = ganttTimeScale === 'daily' ? 36 : (ganttTimeScale === 'weekly' ? 80 : 100);
      let html = `<div class="gantt" id="gantt-container" data-timeline-start="${fixedStart.toISOString().split('T')[0]}" data-project-start="${p.startDate}" data-project-end="${p.endDate}" data-day-width="${containerDayWidth}">
        <div class="gantt-controls">
          <span style="color:#64748B;font-size:12px;margin-right:8px;">üìÖ Scale:</span>
          <button class="gantt-scale-btn ${ganttTimeScale==='daily'?'active':''}" onclick="setGanttScale('daily')">Daily</button>
          <button class="gantt-scale-btn ${ganttTimeScale==='weekly'?'active':''}" onclick="setGanttScale('weekly')">Weekly</button>
          <button class="gantt-scale-btn ${ganttTimeScale==='monthly'?'active':''}" onclick="setGanttScale('monthly')">Monthly</button>
          <span style="flex:1;"></span>
          ${canAddTask ? `<button class="btn btn-primary btn-sm" onclick="openTaskModal()">+ Add Task</button>` : ''}
        </div>
        <div class="gantt-scroll-container" id="gantt-scroll">`;
      
      if (ganttTimeScale === 'daily') {
        html += renderGanttDaily(fixedStart, fixedEnd, tasks, p, today, canAddTask);
      } else if (ganttTimeScale === 'weekly') {
        html += renderGanttWeekly(fixedStart, fixedEnd, tasks, p, today, canAddTask);
      } else {
        html += renderGanttMonthly(fixedStart, fixedEnd, tasks, p, today, canAddTask);
      }
      
      html += '</div>'; // end gantt-scroll-container
      
      const hintText = isAdmin() ? 'Drag bars to move ‚Ä¢ Drag edges to resize ‚Ä¢ Double-tap to edit ‚Ä¢ üîí = Lock task' : 'Double-tap to update progress ‚Ä¢ üîí = Locked by admin';
      html += `<div class="gantt-hint">${hintText}</div></div>`;
      c.innerHTML = html;
      
      // Sync scroll between header and body
      const scrollContainer = document.getElementById('gantt-scroll');
      if (scrollContainer) {
        // Auto-scroll to today or project start
        const todayOffset = Math.ceil((today - fixedStart) / 864e5);
        setTimeout(() => {
          const cellWidth = ganttTimeScale === 'daily' ? 36 : (ganttTimeScale === 'weekly' ? 80 : 120);
          const scrollTo = Math.max(0, (ganttTimeScale === 'daily' ? todayOffset * cellWidth : todayOffset / 7 * cellWidth) - 200);
          scrollContainer.scrollLeft = scrollTo;
        }, 100);
      }
    }
    
    function renderGanttDaily(start, end, tasks, p, today, canAddTask) {
      const totalDays = Math.ceil((end - start) / 864e5) + 1;
      const dayWidth = 36;

      let dates = [];
      for (let i = 0; i < totalDays; i++) {
        const d = new Date(start);
        d.setDate(d.getDate() + i);
        dates.push(d);
      }

      // Group dates by month for header
      let months = [];
      let currentMonth = '';
      let monthDays = 0;
      dates.forEach((d, i) => {
        const monthKey = d.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
        if (monthKey !== currentMonth) {
          if (currentMonth) months.push({ name: currentMonth, days: monthDays });
          currentMonth = monthKey;
          monthDays = 1;
        } else {
          monthDays++;
        }
      });
      months.push({ name: currentMonth, days: monthDays });

      let html = `<div class="gantt-wrapper">
        <div class="gantt-task-column">
          <div class="gantt-task-col-spacer"></div>
          <div class="gantt-task-col">Tasks</div>`;

      // Task names - render all tasks in order (drag to reorder)
      if (!tasks.length) {
        html += '<div class="gantt-task-name" style="min-height:60px;color:#64748B;">No tasks yet</div>';
      } else {
        tasks.forEach((t, index) => {
          const isLocked = t.locked || false;
          // When timeline is locked, NO ONE can edit dates (not even admin) - admin can only unlock
          const canEditThisTask = !p.lockedTimeline && (isAdmin() || !isLocked);
          const canDrag = !p.lockedTimeline;
          const opacity = t.progress === 0 ? 'opacity:0.7;' : '';
          const hasSubtasks = t.subtasks && t.subtasks.length > 0;
          const subtaskCount = hasSubtasks ? t.subtasks.length : 0;
          const completedCount = hasSubtasks ? t.subtasks.filter(st => st.done).length : 0;
          html += `<div class="gantt-task-row-wrapper" data-task-id="${t.id}">
            <div class="gantt-task-name" data-task-id="${t.id}" data-task-index="${index}" style="${opacity}"
                draggable="${canDrag}"
                ondragstart="handleTaskDragStart(event, '${t.id}')"
                ondragend="handleTaskDragEnd(event)"
                ondragover="handleTaskDragOver(event)"
                ondragleave="handleTaskDragLeave(event)"
                ondrop="handleTaskDrop(event, '${t.id}')">
            <span class="gantt-task-drag-handle" title="Drag to reorder">‚ãÆ‚ãÆ</span>
            ${hasSubtasks ? `<span class="subtask-expand" onclick="toggleSubtaskExpand('${t.id}')" title="Show subtasks">‚ñ∂</span>` : ''}
            <span class="gantt-task-text" data-full-text="${t.name}">${t.name}${hasSubtasks ? ` <span style="color:#64748B;font-size:10px;">(${completedCount}/${subtaskCount})</span>` : ''}</span>
            <div class="gantt-task-actions">
              ${canEditThisTask ? `<button class="btn btn-secondary btn-icon btn-sm" onclick="editTask('${t.id}')" style="width:20px;height:20px;font-size:9px;">‚úèÔ∏è</button>` : ''}
              <button class="btn btn-danger btn-icon btn-sm" onclick="deleteTask('${t.id}')" style="width:20px;height:20px;font-size:9px;">üóëÔ∏è</button>
            </div>
          </div>
          ${hasSubtasks ? `<div class="subtask-inline-list" id="subtask-list-${t.id}" style="display:none;">
            ${t.subtasks.map((st, stIdx) => `
              <div class="subtask-inline-item">
                <input type="checkbox" ${st.done ? 'checked' : ''} onchange="toggleSubtaskDone('${t.id}', ${stIdx})">
                <span class="${st.done ? 'completed' : ''}">${st.name}</span>
              </div>
            `).join('')}
          </div>` : ''}
          </div>`;
        });
      }
      html += '</div>';

      // PIC column
      html += `<div class="gantt-pic-column">
        <div class="gantt-task-col-spacer"></div>
        <div class="gantt-task-col" style="min-width:80px;">PIC</div>`;
      if (!tasks.length) {
        html += '<div class="gantt-pic-cell" style="min-height:60px;"></div>';
      } else {
        tasks.forEach(t => {
          const picMember = t.pic ? getMemberById(t.pic) : null;
          const hasSubtasks = t.subtasks && t.subtasks.length > 0;
          const customOptionText = t.picCustom && !t.pic ? `‚úèÔ∏è ${t.picCustom}` : '‚úèÔ∏è Custom...';
          html += `<div class="gantt-task-row-wrapper">
            <div class="gantt-pic-cell">
              <select class="gantt-pic-select" onchange="updateTaskPic('${t.id}', this.value)" title="${picMember ? picMember.name : (t.picCustom || 'Select PIC')}">
                <option value="">-- Select --</option>
                ${data.members.map(m => `<option value="${m.id}" ${t.pic === m.id ? 'selected' : ''}>${m.name}</option>`).join('')}
                <option value="__custom__" ${t.picCustom && !t.pic ? 'selected' : ''}>${customOptionText}</option>
              </select>
            </div>
            ${hasSubtasks ? `<div class="subtask-pic-spacer" id="subtask-pic-${t.id}" style="display:none;"></div>` : ''}
          </div>`;
        });
      }
      html += '</div>'; // end pic-column

      // Status column
      html += `<div class="gantt-status-column">
        <div class="gantt-task-col-spacer"></div>
        <div class="gantt-task-col" style="min-width:100px;">Status</div>`;
      if (!tasks.length) {
        html += '<div class="gantt-status-cell" style="min-height:60px;"></div>';
      } else {
        tasks.forEach(t => {
          const statusColors = {
            'Not Started': '#6B7280',
            'In-Progress': '#3B82F6',
            'Stuck': '#EF4444',
            'Finished': '#10B981'
          };
          const currentStatus = t.status || 'Not Started';
          const statusColor = statusColors[currentStatus] || '#6B7280';
          const hasSubtasks = t.subtasks && t.subtasks.length > 0;
          html += `<div class="gantt-task-row-wrapper">
            <div class="gantt-status-cell">
              <select class="gantt-status-select" onchange="updateTaskStatus('${t.id}', this.value)" style="background:${statusColor};color:white;font-weight:500;">
                <option value="Not Started" ${currentStatus === 'Not Started' ? 'selected' : ''}>Not Started</option>
                <option value="In-Progress" ${currentStatus === 'In-Progress' ? 'selected' : ''}>In-Progress</option>
                <option value="Stuck" ${currentStatus === 'Stuck' ? 'selected' : ''}>Stuck</option>
                <option value="Finished" ${currentStatus === 'Finished' ? 'selected' : ''}>Finished</option>
              </select>
            </div>
            ${hasSubtasks ? `<div class="subtask-status-spacer" id="subtask-status-${t.id}" style="display:none;"></div>` : ''}
          </div>`;
        });
      }
      html += '</div>'; // end status-column

      // Timeline column
      html += '<div class="gantt-timeline-column">';

      // Month headers
      html += '<div class="gantt-header-months">';
      months.forEach(m => {
        html += `<div class="gantt-month-label" style="min-width:${m.days * dayWidth}px;">${m.name}</div>`;
      });
      html += '</div>';

      // Day headers
      html += '<div class="gantt-timeline">';
      dates.forEach(d => {
        const isToday = d.toDateString() === today.toDateString();
        const isWeekend = d.getDay() === 0 || d.getDay() === 6;
        html += `<div class="gantt-date ${isWeekend ? 'weekend' : ''} ${isToday ? 'today' : ''}" style="min-width:${dayWidth}px;">
          <div class="gantt-date-day">${d.getDate()}</div>
          <div class="gantt-date-month">${['Su','Mo','Tu','We','Th','Fr','Sa'][d.getDay()]}</div>
        </div>`;
      });
      html += '</div>';
      
      // Task bars - SUG-6: Render in same order as task names (started first, then not started)
      html += '<div class="gantt-body-rows">';
      if (!tasks.length) {
        html += `<div class="gantt-row"><div class="gantt-bar-container" style="min-width:${totalDays * dayWidth}px;">`;
        dates.forEach(d => {
          const isWeekend = d.getDay() === 0 || d.getDay() === 6;
          html += `<div class="gantt-bar-cell ${isWeekend ? 'weekend' : ''}" style="min-width:${dayWidth}px;"></div>`;
        });
        html += '</div></div>';
      } else {
        // Render bars for all tasks in their current order
        tasks.forEach(t => {
          const ts = new Date(t.start), te = new Date(t.end);
          const leftDays = Math.max(0, Math.ceil((ts - start) / 864e5));
          const widthDays = Math.max(1, Math.ceil((te - ts) / 864e5) + 1);

          const isLocked = t.locked || false;
          // When timeline is locked, NO ONE can drag bars (not even admin)
          const canEditThisTask = !p.lockedTimeline && (isAdmin() || !isLocked);
          const canDragThisTask = canEditThisTask;
          
          html += `<div class="gantt-row"><div class="gantt-bar-container" style="min-width:${totalDays * dayWidth}px;" data-day-width="${dayWidth}" data-start-date="${start.toISOString()}">`;
          dates.forEach(d => {
            const isWeekend = d.getDay() === 0 || d.getDay() === 6;
            html += `<div class="gantt-bar-cell ${isWeekend ? 'weekend' : ''}" style="min-width:${dayWidth}px;"></div>`;
          });
          
          // Today line
          const todayDays = Math.ceil((today - start) / 864e5);
          if (todayDays >= 0 && todayDays <= totalDays) {
            html += `<div class="gantt-today-line" style="left:${todayDays * dayWidth + dayWidth/2}px;"></div>`;
          }
          
          if (canDragThisTask) {
            html += `<div class="gantt-bar" id="bar-${t.id}" data-task-id="${t.id}" data-start="${t.start}" data-end="${t.end}" data-locked="${isLocked}"
                  style="left:${leftDays*dayWidth}px;width:${widthDays*dayWidth}px;background:${getProgressColor(t.progress)};cursor:move"
                  onmousedown="startGanttDrag(event,'${t.id}','move')" ontouchstart="startGanttDrag(event,'${t.id}','move')" ondblclick="editTask('${t.id}')">
                <div class="gantt-bar-handle gantt-bar-handle-left" onmousedown="event.stopPropagation();startGanttDrag(event,'${t.id}','resize-left')" ontouchstart="event.stopPropagation();startGanttDrag(event,'${t.id}','resize-left')"></div>
                <span class="gantt-bar-label">${t.progress}%</span>
                <div class="gantt-bar-handle gantt-bar-handle-right" onmousedown="event.stopPropagation();startGanttDrag(event,'${t.id}','resize-right')" ontouchstart="event.stopPropagation();startGanttDrag(event,'${t.id}','resize-right')"></div>
              </div>`;
          } else {
            html += `<div class="gantt-bar" id="bar-${t.id}" style="left:${leftDays*dayWidth}px;width:${widthDays*dayWidth}px;background:${getProgressColor(t.progress)};cursor:not-allowed;opacity:0.8" ondblclick="updateTaskProgress('${t.id}')">
                <span class="gantt-bar-label">${t.progress}%</span>
              </div>`;
          }
          html += '</div></div>';
        });
      }
      html += '</div>'; // end gantt-body-rows
      html += '</div>'; // end timeline-column
      html += '</div>'; // end wrapper
      
      return html;
    }
    
    function renderGanttWeekly(start, end, tasks, p, today, canAddTask) {
      const totalDays = Math.ceil((end - start) / 864e5) + 1;
      const totalWeeks = Math.ceil(totalDays / 7);
      const weekWidth = 80;
      
      let weeks = [];
      for (let i = 0; i < totalWeeks; i++) {
        const weekStart = new Date(start);
        weekStart.setDate(weekStart.getDate() + i * 7);
        weeks.push(weekStart);
      }
      
      // Group weeks by month
      let months = [];
      let currentMonth = '';
      let monthWeeks = 0;
      weeks.forEach(w => {
        const monthKey = w.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
        if (monthKey !== currentMonth) {
          if (currentMonth) months.push({ name: currentMonth, weeks: monthWeeks });
          currentMonth = monthKey;
          monthWeeks = 1;
        } else {
          monthWeeks++;
        }
      });
      months.push({ name: currentMonth, weeks: monthWeeks });
      
      let html = `<div class="gantt-wrapper">
        <div class="gantt-task-column">
          <div class="gantt-task-col-spacer"></div>
          <div class="gantt-task-col">Tasks</div>`;

      if (!tasks.length) {
        html += '<div class="gantt-task-name" style="min-height:60px;color:#64748B;">No tasks yet</div>';
      } else {
        tasks.forEach(t => {
          const isLocked = t.locked || false;
          // When timeline is locked, NO ONE can edit dates (not even admin)
          const canEditThisTask = !p.lockedTimeline && (isAdmin() || !isLocked);
          const canDeleteThisTask = isAdmin() || (t.createdBy && currentUser && t.createdBy === currentUser.username);
          const hasSubtasks = t.subtasks && t.subtasks.length > 0;
          const subtaskCount = hasSubtasks ? t.subtasks.length : 0;
          const completedCount = hasSubtasks ? t.subtasks.filter(st => st.done).length : 0;
          html += `<div class="gantt-task-name">
            ${hasSubtasks ? `<span class="subtask-expand" onclick="toggleSubtaskExpand('${t.id}')" title="Show subtasks">‚ñ∂</span>` : ''}
            <span class="gantt-task-text" data-full-text="${t.name}">${t.name}${hasSubtasks ? ` <span style="color:#64748B;font-size:10px;">(${completedCount}/${subtaskCount})</span>` : ''}</span>
            <div class="gantt-task-actions">
              ${canEditThisTask ? `<button class="btn btn-secondary btn-icon btn-sm" onclick="editTask('${t.id}')" style="width:22px;height:22px;font-size:10px;">‚úèÔ∏è</button>` : ''}
              <button class="btn btn-danger btn-icon btn-sm" onclick="deleteTask('${t.id}')" style="width:22px;height:22px;font-size:10px;">üóëÔ∏è</button>
            </div>
          </div>`;
          if (hasSubtasks) {
            html += `<div class="subtask-inline-list" id="subtask-list-${t.id}" style="display:none;">
              ${t.subtasks.map((st, stIdx) => `
                <div class="subtask-inline-item">
                  <input type="checkbox" ${st.done ? 'checked' : ''} onchange="toggleSubtaskDone('${t.id}', ${stIdx})">
                  <span class="${st.done ? 'completed' : ''}">${st.name}</span>
                </div>
              `).join('')}
            </div>`;
          }
        });
      }
      html += '</div>';

      // PIC column for Weekly view
      html += `<div class="gantt-pic-column">
        <div class="gantt-task-col-spacer"></div>
        <div class="gantt-task-col" style="min-width:80px;">PIC</div>`;
      if (!tasks.length) {
        html += '<div class="gantt-pic-cell" style="min-height:60px;"></div>';
      } else {
        tasks.forEach(t => {
          const picMember = t.pic ? getMemberById(t.pic) : null;
          const hasSubtasks = t.subtasks && t.subtasks.length > 0;
          const customOptionText = t.picCustom && !t.pic ? `‚úèÔ∏è ${t.picCustom}` : '‚úèÔ∏è Custom...';
          html += `<div class="gantt-task-row-wrapper">
            <div class="gantt-pic-cell">
              <select class="gantt-pic-select" onchange="updateTaskPic('${t.id}', this.value)" title="${picMember ? picMember.name : (t.picCustom || 'Select PIC')}">
                <option value="">-- Select --</option>
                ${data.members.map(m => `<option value="${m.id}" ${t.pic === m.id ? 'selected' : ''}>${m.name}</option>`).join('')}
                <option value="__custom__" ${t.picCustom && !t.pic ? 'selected' : ''}>${customOptionText}</option>
              </select>
            </div>
            ${hasSubtasks ? `<div class="subtask-pic-spacer" id="subtask-pic-${t.id}" style="display:none;"></div>` : ''}
          </div>`;
        });
      }
      html += '</div>';

      // Status column for Weekly view
      html += `<div class="gantt-status-column">
        <div class="gantt-task-col-spacer"></div>
        <div class="gantt-task-col" style="min-width:100px;">Status</div>`;
      if (!tasks.length) {
        html += '<div class="gantt-status-cell" style="min-height:60px;"></div>';
      } else {
        tasks.forEach(t => {
          const statusColors = {
            'Not Started': '#6B7280',
            'In-Progress': '#3B82F6',
            'Stuck': '#EF4444',
            'Finished': '#10B981'
          };
          const currentStatus = t.status || 'Not Started';
          const statusColor = statusColors[currentStatus] || '#6B7280';
          const hasSubtasks = t.subtasks && t.subtasks.length > 0;
          html += `<div class="gantt-task-row-wrapper">
            <div class="gantt-status-cell">
              <select class="gantt-status-select" onchange="updateTaskStatus('${t.id}', this.value)" style="background:${statusColor};color:white;font-weight:500;">
                <option value="Not Started" ${currentStatus === 'Not Started' ? 'selected' : ''}>Not Started</option>
                <option value="In-Progress" ${currentStatus === 'In-Progress' ? 'selected' : ''}>In-Progress</option>
                <option value="Stuck" ${currentStatus === 'Stuck' ? 'selected' : ''}>Stuck</option>
                <option value="Finished" ${currentStatus === 'Finished' ? 'selected' : ''}>Finished</option>
              </select>
            </div>
            ${hasSubtasks ? `<div class="subtask-status-spacer" id="subtask-status-${t.id}" style="display:none;"></div>` : ''}
          </div>`;
        });
      }
      html += '</div>';

      html += '<div class="gantt-timeline-column">';
      html += '<div class="gantt-header-months">';
      months.forEach(m => {
        html += `<div class="gantt-month-label" style="min-width:${m.weeks * weekWidth}px;">${m.name}</div>`;
      });
      html += '</div>';

      html += '<div class="gantt-timeline">';
      weeks.forEach(w => {
        const weekEnd = new Date(w);
        weekEnd.setDate(weekEnd.getDate() + 6);
        const isThisWeek = today >= w && today <= weekEnd;
        html += `<div class="gantt-date ${isThisWeek ? 'today' : ''}" style="min-width:${weekWidth}px;">
          <div class="gantt-date-day">${w.getDate()}-${weekEnd.getDate()}</div>
          <div class="gantt-date-week">W${Math.ceil((w - new Date(w.getFullYear(), 0, 1)) / 864e5 / 7) + 1}</div>
        </div>`;
      });
      html += '</div>';

      html += '<div class="gantt-body-rows">';
      if (!tasks.length) {
        html += `<div class="gantt-row"><div class="gantt-bar-container" style="min-width:${totalWeeks * weekWidth}px;">`;
        weeks.forEach(() => html += `<div class="gantt-bar-cell" style="min-width:${weekWidth}px;"></div>`);
        html += '</div></div>';
      } else {
        tasks.forEach(t => {
          const ts = new Date(t.start), te = new Date(t.end);
          const leftWeeks = Math.max(0, Math.floor((ts - start) / 864e5 / 7));
          const widthWeeks = Math.max(1, Math.ceil((te - ts) / 864e5 / 7) + 1);
          const isLocked = t.locked || false;
          const canEditThisTask = isAdmin() || (!isLocked && !p.lockedTimeline);
          
          html += `<div class="gantt-row"><div class="gantt-bar-container" style="min-width:${totalWeeks * weekWidth}px;">`;
          weeks.forEach(() => html += `<div class="gantt-bar-cell" style="min-width:${weekWidth}px;"></div>`);
          
          // Today line
          const todayWeek = Math.floor((today - start) / 864e5 / 7);
          if (todayWeek >= 0 && todayWeek < totalWeeks) {
            html += `<div class="gantt-today-line" style="left:${todayWeek * weekWidth + weekWidth/2}px;"></div>`;
          }
          
          html += `<div class="gantt-bar" style="left:${leftWeeks*weekWidth}px;width:${widthWeeks*weekWidth}px;background:${getProgressColor(t.progress)};${canEditThisTask?'':'opacity:0.8;'}" ondblclick="${canEditThisTask?`editTask('${t.id}')`:`updateTaskProgress('${t.id}')`}">
              <span class="gantt-bar-label">${t.progress}%</span>
            </div>`;
          html += '</div></div>';
        });
      }
      html += '</div></div></div>';

      return html;
    }

    function renderGanttMonthly(start, end, tasks, p, today, canAddTask) {
      const monthWidth = 120;
      let months = [];
      let d = new Date(start);
      while (d <= end) {
        months.push(new Date(d));
        d.setMonth(d.getMonth() + 1);
      }
      
      let html = `<div class="gantt-wrapper">
        <div class="gantt-task-column">
          <div class="gantt-task-col" style="height:52px;">Tasks</div>`;

      if (!tasks.length) {
        html += '<div class="gantt-task-name" style="min-height:60px;color:#64748B;">No tasks yet</div>';
      } else {
        tasks.forEach(t => {
          const isLocked = t.locked || false;
          // When timeline is locked, NO ONE can edit dates (not even admin)
          const canEditThisTask = !p.lockedTimeline && (isAdmin() || !isLocked);
          const canDeleteThisTask = isAdmin() || (t.createdBy && currentUser && t.createdBy === currentUser.username);
          const hasSubtasks = t.subtasks && t.subtasks.length > 0;
          const subtaskCount = hasSubtasks ? t.subtasks.length : 0;
          const completedCount = hasSubtasks ? t.subtasks.filter(st => st.done).length : 0;
          html += `<div class="gantt-task-name">
            ${hasSubtasks ? `<span class="subtask-expand" onclick="toggleSubtaskExpand('${t.id}')" title="Show subtasks">‚ñ∂</span>` : ''}
            <span class="gantt-task-text" data-full-text="${t.name}">${t.name}${hasSubtasks ? ` <span style="color:#64748B;font-size:10px;">(${completedCount}/${subtaskCount})</span>` : ''}</span>
            <div class="gantt-task-actions">
              ${canEditThisTask ? `<button class="btn btn-secondary btn-icon btn-sm" onclick="editTask('${t.id}')" style="width:22px;height:22px;font-size:10px;">‚úèÔ∏è</button>` : ''}
              <button class="btn btn-danger btn-icon btn-sm" onclick="deleteTask('${t.id}')" style="width:22px;height:22px;font-size:10px;">üóëÔ∏è</button>
            </div>
          </div>`;
          if (hasSubtasks) {
            html += `<div class="subtask-inline-list" id="subtask-list-${t.id}" style="display:none;">
              ${t.subtasks.map((st, stIdx) => `
                <div class="subtask-inline-item">
                  <input type="checkbox" ${st.done ? 'checked' : ''} onchange="toggleSubtaskDone('${t.id}', ${stIdx})">
                  <span class="${st.done ? 'completed' : ''}">${st.name}</span>
                </div>
              `).join('')}
            </div>`;
          }
        });
      }
      html += '</div>';

      // PIC column for Monthly view
      html += `<div class="gantt-pic-column">
        <div class="gantt-task-col" style="height:52px;min-width:80px;">PIC</div>`;
      if (!tasks.length) {
        html += '<div class="gantt-pic-cell" style="min-height:60px;"></div>';
      } else {
        tasks.forEach(t => {
          const picMember = t.pic ? getMemberById(t.pic) : null;
          const hasSubtasks = t.subtasks && t.subtasks.length > 0;
          const customOptionText = t.picCustom && !t.pic ? `‚úèÔ∏è ${t.picCustom}` : '‚úèÔ∏è Custom...';
          html += `<div class="gantt-task-row-wrapper">
            <div class="gantt-pic-cell">
              <select class="gantt-pic-select" onchange="updateTaskPic('${t.id}', this.value)" title="${picMember ? picMember.name : (t.picCustom || 'Select PIC')}">
                <option value="">-- Select --</option>
                ${data.members.map(m => `<option value="${m.id}" ${t.pic === m.id ? 'selected' : ''}>${m.name}</option>`).join('')}
                <option value="__custom__" ${t.picCustom && !t.pic ? 'selected' : ''}>${customOptionText}</option>
              </select>
            </div>
            ${hasSubtasks ? `<div class="subtask-pic-spacer" id="subtask-pic-${t.id}" style="display:none;"></div>` : ''}
          </div>`;
        });
      }
      html += '</div>';

      // Status column for Monthly view
      html += `<div class="gantt-status-column">
        <div class="gantt-task-col" style="min-width:100px;height:44px;">Status</div>`;
      if (!tasks.length) {
        html += '<div class="gantt-status-cell" style="min-height:60px;"></div>';
      } else {
        tasks.forEach(t => {
          const statusColors = {
            'Not Started': '#6B7280',
            'In-Progress': '#3B82F6',
            'Stuck': '#EF4444',
            'Finished': '#10B981'
          };
          const currentStatus = t.status || 'Not Started';
          const statusColor = statusColors[currentStatus] || '#6B7280';
          const hasSubtasks = t.subtasks && t.subtasks.length > 0;
          html += `<div class="gantt-task-row-wrapper">
            <div class="gantt-status-cell">
              <select class="gantt-status-select" onchange="updateTaskStatus('${t.id}', this.value)" style="background:${statusColor};color:white;font-weight:500;">
                <option value="Not Started" ${currentStatus === 'Not Started' ? 'selected' : ''}>Not Started</option>
                <option value="In-Progress" ${currentStatus === 'In-Progress' ? 'selected' : ''}>In-Progress</option>
                <option value="Stuck" ${currentStatus === 'Stuck' ? 'selected' : ''}>Stuck</option>
                <option value="Finished" ${currentStatus === 'Finished' ? 'selected' : ''}>Finished</option>
              </select>
            </div>
            ${hasSubtasks ? `<div class="subtask-status-spacer" id="subtask-status-${t.id}" style="display:none;"></div>` : ''}
          </div>`;
        });
      }
      html += '</div>';

      html += '<div class="gantt-timeline-column">';
      html += '<div class="gantt-timeline">';
      months.forEach(m => {
        const isThisMonth = today.getMonth() === m.getMonth() && today.getFullYear() === m.getFullYear();
        html += `<div class="gantt-date ${isThisMonth ? 'today' : ''}" style="min-width:${monthWidth}px;">
          <div class="gantt-date-day">${m.toLocaleDateString('en-US', { month: 'short' })}</div>
          <div class="gantt-date-month">${m.getFullYear()}</div>
        </div>`;
      });
      html += '</div>';

      html += '<div class="gantt-body-rows">';
      if (!tasks.length) {
        html += `<div class="gantt-row"><div class="gantt-bar-container" style="min-width:${months.length * monthWidth}px;">`;
        months.forEach(() => html += `<div class="gantt-bar-cell" style="min-width:${monthWidth}px;"></div>`);
        html += '</div></div>';
      } else {
        tasks.forEach(t => {
          const ts = new Date(t.start), te = new Date(t.end);
          // Calculate position in months
          const startMonthIdx = (ts.getFullYear() - start.getFullYear()) * 12 + ts.getMonth() - start.getMonth();
          const endMonthIdx = (te.getFullYear() - start.getFullYear()) * 12 + te.getMonth() - start.getMonth();
          const leftMonths = Math.max(0, startMonthIdx + ts.getDate() / 30);
          const widthMonths = Math.max(0.5, endMonthIdx - startMonthIdx + 1);
          const isLocked = t.locked || false;
          // When timeline is locked, NO ONE can edit dates (not even admin)
          const canEditThisTask = !p.lockedTimeline && (isAdmin() || !isLocked);

          html += `<div class="gantt-row"><div class="gantt-bar-container" style="min-width:${months.length * monthWidth}px;">`;
          months.forEach(() => html += `<div class="gantt-bar-cell" style="min-width:${monthWidth}px;"></div>`);

          // Today line
          const todayMonthIdx = (today.getFullYear() - start.getFullYear()) * 12 + today.getMonth() - start.getMonth();
          if (todayMonthIdx >= 0 && todayMonthIdx < months.length) {
            const todayPos = todayMonthIdx * monthWidth + (today.getDate() / 30) * monthWidth;
            html += `<div class="gantt-today-line" style="left:${todayPos}px;"></div>`;
          }

          html += `<div class="gantt-bar" style="left:${leftMonths*monthWidth}px;width:${widthMonths*monthWidth}px;background:${getProgressColor(t.progress)};${canEditThisTask?'':'opacity:0.8;'}" ondblclick="${canEditThisTask?`editTask('${t.id}')`:`updateTaskProgress('${t.id}')`}">
              <span class="gantt-bar-label">${t.progress}%</span>
            </div>`;
          html += '</div></div>';
        });
      }
      html += '</div></div></div>';

      return html;
    }
    
    function toggleTaskLock(taskId) {
      if (!isAdmin()) return;
      const p = getProjectById(currentProjectId);
      const t = p.tasks.find(x => x.id === taskId);
      if (t) {
        t.locked = !t.locked;
        saveData();
        renderGantt(document.getElementById('tab-content'));
        showToast(t.locked ? 'Task locked' : 'Task unlocked');
      }
    }
    
    function updateTaskProgress(taskId) {
      const p = getProjectById(currentProjectId);
      const t = p.tasks.find(x => x.id === taskId);
      if (t) {
        const newProgress = prompt(`Update progress for "${t.name}" (0-100):`, t.progress);
        if (newProgress !== null) {
          const val = parseInt(newProgress);
          if (!isNaN(val) && val >= 0 && val <= 100) {
            t.progress = val;
            saveData();
            renderGantt(document.getElementById('tab-content'));
            showToast('Progress updated');
          }
        }
      }
    }

    function startGanttDrag(e, taskId, mode) {
      e.preventDefault();
      const p = getProjectById(currentProjectId);
      const t = p.tasks.find(x => x.id === taskId);
      if (!t) return;

      // When timeline is locked, NO ONE can drag (not even admin) - admin can only unlock
      if (p.lockedTimeline) {
        showToast('Timeline is locked - unlock it first to make changes');
        return;
      }

      // Check if individual task is locked (for non-admin)
      if (!isAdmin() && t.locked) {
        showToast('This task is locked');
        return;
      }
      
      const container = document.getElementById('gantt-container');
      const clientX = e.touches ? e.touches[0].clientX : e.clientX;
      // Use timelineStart (fixed Jan 1) for position calculations, but projectStart/End for date constraints
      ganttDrag = {
        active: true,
        taskId,
        mode,
        startX: clientX,
        originalStart: t.start,
        originalEnd: t.end,
        dayWidth: parseInt(container.dataset.dayWidth),
        timelineStart: container.dataset.timelineStart || '2026-01-01',
        projectStart: container.dataset.projectStart,
        projectEnd: container.dataset.projectEnd
      };
      document.addEventListener('mousemove', onGanttDrag);
      document.addEventListener('mouseup', stopGanttDrag);
      document.addEventListener('touchmove', onGanttDrag, { passive: false });
      document.addEventListener('touchend', stopGanttDrag);
    }

    function onGanttDrag(e) {
      if (!ganttDrag.active) return;
      e.preventDefault();
      const clientX = e.touches ? e.touches[0].clientX : e.clientX;
      const deltaX = clientX - ganttDrag.startX;
      const deltaDays = Math.round(deltaX / ganttDrag.dayWidth);
      const p = getProjectById(currentProjectId);
      const t = p.tasks.find(x => x.id === ganttDrag.taskId);
      if (!t) return;

      // timelineStart is the fixed start of the Gantt (Jan 1, 2026) - used for bar positioning
      // projectStart/End are the project's date range - used for constraining task dates
      const timelineStart = new Date(ganttDrag.timelineStart);
      const projectStart = new Date(ganttDrag.projectStart), projectEnd = new Date(ganttDrag.projectEnd);
      let newStart = new Date(ganttDrag.originalStart), newEnd = new Date(ganttDrag.originalEnd);

      if (ganttDrag.mode === 'move') { newStart.setDate(newStart.getDate() + deltaDays); newEnd.setDate(newEnd.getDate() + deltaDays); }
      else if (ganttDrag.mode === 'resize-left') { newStart.setDate(newStart.getDate() + deltaDays); if (newStart >= newEnd) newStart = new Date(newEnd.getTime() - 864e5); }
      else if (ganttDrag.mode === 'resize-right') { newEnd.setDate(newEnd.getDate() + deltaDays); if (newEnd <= newStart) newEnd = new Date(newStart.getTime() + 864e5); }

      // Constrain to timeline boundaries (fixed timeline, not project boundaries)
      const timelineEnd = new Date(timelineStart);
      timelineEnd.setFullYear(timelineEnd.getFullYear() + 2);
      if (newStart < timelineStart) { const diff = Math.ceil((timelineStart - newStart) / 864e5); newStart = new Date(timelineStart); if (ganttDrag.mode === 'move') newEnd.setDate(newEnd.getDate() + diff); }
      if (newEnd > timelineEnd) { const diff = Math.ceil((newEnd - timelineEnd) / 864e5); newEnd = new Date(timelineEnd); if (ganttDrag.mode === 'move') newStart.setDate(newStart.getDate() - diff); }

      const bar = document.getElementById('bar-' + ganttDrag.taskId);
      // Calculate position relative to timelineStart (not projectStart!)
      const leftDays = Math.ceil((newStart - timelineStart) / 864e5);
      const widthDays = Math.ceil((newEnd - newStart) / 864e5) + 1;
      bar.style.left = (leftDays * ganttDrag.dayWidth) + 'px';
      bar.style.width = (widthDays * ganttDrag.dayWidth) + 'px';
      
      const tooltip = document.getElementById('gantt-tooltip');
      tooltip.innerHTML = `<div class="gantt-tooltip-dates">${formatDateShort(newStart.toISOString().split('T')[0])} ‚Üí ${formatDateShort(newEnd.toISOString().split('T')[0])}</div><div class="gantt-tooltip-duration">${widthDays} day${widthDays>1?'s':''}</div>`;
      tooltip.style.left = (clientX + 10) + 'px';
      tooltip.style.top = ((e.touches ? e.touches[0].clientY : e.clientY) + 10) + 'px';
      tooltip.classList.remove('hidden');
      bar.dataset.tempStart = newStart.toISOString().split('T')[0];
      bar.dataset.tempEnd = newEnd.toISOString().split('T')[0];
    }

    function stopGanttDrag() {
      if (!ganttDrag.active) return;
      const bar = document.getElementById('bar-' + ganttDrag.taskId);
      if (bar?.dataset.tempStart && bar?.dataset.tempEnd) {
        const p = getProjectById(currentProjectId);
        const t = p.tasks.find(x => x.id === ganttDrag.taskId);
        if (t && (t.start !== bar.dataset.tempStart || t.end !== bar.dataset.tempEnd)) {
          t.start = bar.dataset.tempStart;
          t.end = bar.dataset.tempEnd;
          saveData();
          showToast('Timeline updated: ' + formatDateShort(t.start) + ' ‚Üí ' + formatDateShort(t.end));
          // No re-render needed - the bar position is already updated visually
          // This prevents the scroll position from resetting (flashing)
        }
      }
      document.getElementById('gantt-tooltip')?.classList.add('hidden');
      ganttDrag.active = false;
      document.removeEventListener('mousemove', onGanttDrag);
      document.removeEventListener('mouseup', stopGanttDrag);
      document.removeEventListener('touchmove', onGanttDrag);
      document.removeEventListener('touchend', stopGanttDrag);
    }

    // ==================== TASK REORDER DRAG & DROP ====================
    let draggedTaskId = null;

    function handleTaskDragStart(e, taskId) {
      draggedTaskId = taskId;
      e.target.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'move';
      e.dataTransfer.setData('text/plain', taskId);
    }

    function handleTaskDragEnd(e) {
      e.target.classList.remove('dragging');
      draggedTaskId = null;
      // Remove all drag-over classes
      document.querySelectorAll('.gantt-task-name.drag-over').forEach(el => el.classList.remove('drag-over'));
    }

    function handleTaskDragOver(e) {
      e.preventDefault();
      e.dataTransfer.dropEffect = 'move';
      const taskRow = e.target.closest('.gantt-task-name[data-task-id]');
      if (taskRow && taskRow.dataset.taskId !== draggedTaskId) {
        taskRow.classList.add('drag-over');
      }
    }

    function handleTaskDragLeave(e) {
      const taskRow = e.target.closest('.gantt-task-name[data-task-id]');
      if (taskRow && !taskRow.contains(e.relatedTarget)) {
        taskRow.classList.remove('drag-over');
      }
    }

    function handleTaskDrop(e, targetTaskId) {
      e.preventDefault();
      const taskRow = e.target.closest('.gantt-task-name[data-task-id]');
      if (taskRow) taskRow.classList.remove('drag-over');

      const sourceTaskId = e.dataTransfer.getData('text/plain') || draggedTaskId;
      if (!sourceTaskId || sourceTaskId === targetTaskId) return;

      const p = getProjectById(currentProjectId);
      if (!p || !p.tasks) return;

      // Find indices
      const sourceIndex = p.tasks.findIndex(t => t.id === sourceTaskId);
      const targetIndex = p.tasks.findIndex(t => t.id === targetTaskId);

      if (sourceIndex === -1 || targetIndex === -1) return;

      // Remove from source position and insert at target position
      const [movedTask] = p.tasks.splice(sourceIndex, 1);
      p.tasks.splice(targetIndex, 0, movedTask);

      saveData();
      showToast('Task reordered');

      // Save scroll position before re-render
      const scrollContainer = document.getElementById('gantt-scroll');
      const scrollLeft = scrollContainer ? scrollContainer.scrollLeft : 0;

      // Re-render the Gantt chart
      renderGantt(document.getElementById('tab-content'));

      // Restore scroll position after re-render
      const newScrollContainer = document.getElementById('gantt-scroll');
      if (newScrollContainer) newScrollContainer.scrollLeft = scrollLeft;
    }

    // ==================== DETAILS TAB ====================
    function renderDetails(c) {
      const p = getProjectById(currentProjectId);
      const progress = calcProgress(p.tasks);
      c.innerHTML = `<div class="details-grid">
        <div class="detail-card"><h3 class="detail-card-title">üìã Project Info</h3>
          <div class="detail-item"><span class="detail-label">User Team</span><span class="detail-value" style="color:#38BDF8;">${p.team || 'Not assigned'}</span></div>
          <div class="detail-item"><span class="detail-label">Target Saving Hours/Month</span><span class="detail-value" style="color:#10B981;">${p.savingHours ? 'üéØ ' + p.savingHours + ' hours' : 'Not set'}</span></div>
          <div class="detail-item"><span class="detail-label">Actual Saving Hours/Month</span><span class="detail-value" style="color:#3B82F6;">${p.actualSavingHours ? '‚úÖ ' + p.actualSavingHours + ' hours' : 'Not set'}</span></div>
          <div class="detail-item"><span class="detail-label">Priority</span><span class="${getPriorityClass(p.priority)}">${p.priority}</span></div>
          <div class="detail-item"><span class="detail-label">Status</span><span class="detail-value">${p.status}</span></div>
        </div>
        <div class="detail-card"><h3 class="detail-card-title">üìÖ Timeline</h3>
          <div class="detail-item"><span class="detail-label">Start</span><span class="detail-value">${formatDate(p.startDate)}</span></div>
          <div class="detail-item"><span class="detail-label">End</span><span class="detail-value">${formatDate(p.endDate)}</span></div>
          <div class="detail-item"><span class="detail-label">Duration</span><span class="detail-value">${calcDuration(p.startDate, p.endDate)} days</span></div>
        </div>
        <div class="detail-card"><h3 class="detail-card-title">üìä Progress</h3>
          <div class="progress-circle"><svg viewBox="0 0 36 36" class="progress-svg"><path class="progress-bg" d="M18 2.0845a15.9155 15.9155 0 0 1 0 31.831a15.9155 15.9155 0 0 1 0-31.831" fill="none" stroke-width="3"/><path class="progress-fg" stroke-dasharray="${progress},100" d="M18 2.0845a15.9155 15.9155 0 0 1 0 31.831a15.9155 15.9155 0 0 1 0-31.831" fill="none" stroke-width="3"/></svg><span class="progress-text">${progress}%</span></div>
        </div>
        <div class="detail-card"><h3 class="detail-card-title">‚úÖ Tasks</h3>
          <div class="detail-item"><span class="detail-label">Total</span><span class="detail-value">${p.tasks?.length||0}</span></div>
          <div class="detail-item"><span class="detail-label">Completed</span><span class="detail-value">${p.tasks?.filter(t=>t.progress===100).length||0}</span></div>
          <div class="detail-item"><span class="detail-label">In Progress</span><span class="detail-value">${p.tasks?.filter(t=>t.progress>0&&t.progress<100).length||0}</span></div>
        </div>
      </div>`;
    }

    // ==================== UPDATES TAB ====================
    function formatBangkokDateTime(isoString) {
      if (!isoString) return '';
      const date = new Date(isoString);
      // Check if it's just a date (old format) or full ISO string
      if (isoString.length <= 10) {
        return formatDate(isoString);
      }
      // Format as Bangkok time (UTC+7)
      return date.toLocaleString('en-GB', {
        timeZone: 'Asia/Bangkok',
        day: '2-digit',
        month: 'short',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        hour12: false
      });
    }

    function renderUpdates(c) {
      const p = getProjectById(currentProjectId);
      const u = p.updates || [];
      // Convert newlines to <br> for display
      const formatUpdateText = (text) => text.replace(/\n/g, '<br>');
      c.innerHTML = `<div class="updates-section">
        <div class="add-update" style="flex-direction:column;align-items:stretch;">
          <textarea class="form-textarea" id="new-update" placeholder="Add update..." rows="2" style="min-height:60px;resize:vertical;" onkeydown="handleUpdateKeydown(event)"></textarea>
          <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px;">
            <span style="font-size:11px;color:#64748B;">üí° Enter to post | Shift+Enter, Option+Enter, or Cmd+Enter for new line</span>
            <button class="btn btn-primary" onclick="addNewUpdate()">Post</button>
          </div>
        </div>
        <div class="updates-list">${!u.length?'<div class="no-updates">No updates yet.</div>':u.map((x,i)=>`<div class="update-item"><div class="update-actions"><button class="btn btn-secondary btn-icon btn-sm" onclick="editUpdate(${i})">‚úèÔ∏è</button><button class="btn btn-danger btn-icon btn-sm" onclick="deleteUpdate(${i})">üóëÔ∏è</button></div><div class="update-date">${formatBangkokDateTime(x.date)}${x.author ? ` ‚Ä¢ <span style="color:#38BDF8;font-weight:500;">@${x.author}</span>` : ''}${x.updatedAt ? ` <span style="color:#94A3B8;font-size:11px;"> | Updated: ${formatBangkokDateTime(x.updatedAt)}${x.updatedBy ? ` by @${x.updatedBy}` : ''}</span>` : ''}</div><div class="update-text" style="white-space:pre-wrap;">${formatUpdateText(x.text)}</div></div>`).join('')}</div>
      </div>`;
    }

    // Handle keyboard shortcuts for update textarea
    function handleUpdateKeydown(event) {
      if (event.key === 'Enter') {
        if (event.altKey || event.metaKey) {
          // Alt+Enter (Windows) or Option+Enter / Cmd+Enter (Mac) - insert new line
          event.preventDefault();
          const textarea = event.target;
          const start = textarea.selectionStart;
          const end = textarea.selectionEnd;
          const value = textarea.value;
          // Insert newline at cursor position
          textarea.value = value.substring(0, start) + '\n' + value.substring(end);
          // Move cursor after the newline
          textarea.selectionStart = textarea.selectionEnd = start + 1;
          return;
        } else if (!event.shiftKey) {
          // Enter without modifier - post the update
          event.preventDefault();
          addNewUpdate();
        }
        // Shift+Enter also inserts new line (default behavior)
      }
    }

    // Handle keyboard shortcuts for update modal textarea
    function handleUpdateModalKeydown(event) {
      if (event.key === 'Enter' && !event.altKey && !event.metaKey) {
        // Enter without Alt - don't submit, let user press save button
        // Only Alt+Enter adds new line, regular Enter also adds new line in modal
        return;
      }
    }

    function addNewUpdate() {
      const i = document.getElementById('new-update'), t = i.value.trim();
      if (!t) return;
      const p = getProjectById(currentProjectId);
      if (!p.updates) p.updates = [];
      p.updates.unshift({
        date: new Date().toISOString(),
        text: t,
        author: currentUser ? currentUser.username : 'Unknown'
      });
      i.value = '';
      saveData();
      renderUpdates(document.getElementById('tab-content'));
      showToast('Update added');
    }
    function editUpdate(idx) {
      const p = getProjectById(currentProjectId);
      const u = p.updates[idx];
      document.getElementById('edit-update-index').value = idx;
      document.getElementById('update-text').value = u.text;
      let infoHtml = `Posted: ${formatBangkokDateTime(u.date)}${u.author ? ` by @${u.author}` : ''}`;
      if (u.updatedAt) {
        infoHtml += `<br>Last edited: ${formatBangkokDateTime(u.updatedAt)}${u.updatedBy ? ` by @${u.updatedBy}` : ''}`;
      }
      document.getElementById('update-original-info').innerHTML = infoHtml;
      document.getElementById('modal-update').classList.remove('hidden');
    }
    function saveUpdate() {
      const idx = parseInt(document.getElementById('edit-update-index').value);
      const p = getProjectById(currentProjectId);
      const existing = p.updates[idx];
      existing.text = document.getElementById('update-text').value.trim();
      existing.updatedAt = new Date().toISOString();
      existing.updatedBy = currentUser ? currentUser.username : 'Unknown';
      // Preserve original date and author
      if (!existing.author) existing.author = currentUser ? currentUser.username : 'Unknown';
      saveData();
      closeModal('update');
      renderUpdates(document.getElementById('tab-content'));
      showToast('Saved');
    }
    function deleteUpdate(idx) { if (confirm('Delete?')) { getProjectById(currentProjectId).updates.splice(idx, 1); saveData(); renderUpdates(document.getElementById('tab-content')); showToast('Deleted'); } }

    // ==================== TIME MANAGEMENT ====================
    function renderTimeManagement() {
      if (!selectedMember && data.members.length) selectedMember = data.members[0].id;
      renderProjectSummary();  // SCHEDULE IMPROVEMENT: Add project summary with R/O tracking
      renderMemberSelector();
      renderProjectLegend();
      renderWeekLabel();
      renderCalendar();
    }

    // SCHEDULE IMPROVEMENT: Render Project Summary with Status (R=Risk, O=On Track)
    function renderProjectSummary() {
      const allProjects = data.projects.filter(p => p.startDate && p.endDate);

      if (!allProjects.length) {
        document.getElementById('schedule-project-summary').innerHTML = '<p style="color:#64748B;text-align:center;">No projects with scheduled dates.</p>';
        return;
      }

      // Calculate status for each project
      const projectStatus = allProjects.map(p => {
        const riskStatus = calculateRiskStatus(p);
        const progress = calcProgress(p.tasks);
        return { project: p, risk: riskStatus, progress };
      });

      // Count risk vs on-track
      const atRisk = projectStatus.filter(ps => ps.risk.isRisk).length;
      const onTrack = projectStatus.length - atRisk;

      let html = `
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;flex-wrap:wrap;gap:12px;">
          <h3 style="font-size:14px;font-weight:600;color:#F1F5F9;">üìà Project Summary Tracking</h3>
          <div style="display:flex;gap:12px;">
            <div style="display:flex;align-items:center;gap:6px;background:#064E3B;padding:6px 12px;border-radius:8px;">
              <span style="font-weight:700;color:#6EE7B7;font-size:18px;">${onTrack}</span>
              <span style="color:#94A3B8;font-size:11px;">O = On Track</span>
            </div>
            <div style="display:flex;align-items:center;gap:6px;background:#7F1D1D;padding:6px 12px;border-radius:8px;">
              <span style="font-weight:700;color:#FCA5A5;font-size:18px;">${atRisk}</span>
              <span style="color:#94A3B8;font-size:11px;">R = Risk</span>
            </div>
          </div>
        </div>
        <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(250px,1fr));gap:10px;max-height:300px;overflow-y:auto;padding:4px;">
      `;

      projectStatus.forEach(ps => {
        const statusBadge = ps.risk.isRisk ?
          '<span style="background:#EF4444;color:white;padding:2px 8px;border-radius:6px;font-size:10px;font-weight:600;">R</span>' :
          '<span style="background:#10B981;color:white;padding:2px 8px;border-radius:6px;font-size:10px;font-weight:600;">O</span>';

        html += `
          <div onclick="openProject('${ps.project.id}')" style="background:#1E293B;padding:12px;border-radius:8px;cursor:pointer;border:2px solid ${ps.risk.isRisk ? '#EF4444' : '#10B981'};transition:all 0.2s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
              <span style="font-weight:600;font-size:13px;flex:1;">${ps.project.name}</span>
              ${statusBadge}
            </div>
            <div style="font-size:10px;color:#64748B;margin-bottom:6px;">${formatDateShort(ps.project.startDate)} - ${formatDateShort(ps.project.endDate)}</div>
            <div style="display:flex;align-items:center;gap:8px;">
              <div style="flex:1;background:#0F172A;height:6px;border-radius:3px;overflow:hidden;">
                <div style="width:${ps.progress}%;height:100%;background:${ps.progress === 100 ? '#10B981' : '#38BDF8'};"></div>
              </div>
              <span style="font-size:10px;color:#94A3B8;">${ps.progress}%</span>
            </div>
            ${ps.risk.isRisk ? `<div style="margin-top:6px;font-size:9px;color:#EF4444;background:#FEE2E2;padding:4px 6px;border-radius:4px;">‚ö†Ô∏è ${ps.risk.reason}</div>` : ''}
          </div>
        `;
      });

      html += '</div>';
      document.getElementById('schedule-project-summary').innerHTML = html;
    }
    function renderMemberSelector() { document.getElementById('member-selector').innerHTML = data.members.map(m => `<button class="member-tab ${m.id===selectedMember?'active':''}" style="${m.id===selectedMember?'background:'+m.color:''}" onclick="selectMember('${m.id}')">${m.avatar} ${m.name}</button>`).join(''); }
    function selectMember(mid) { selectedMember = mid; renderTimeManagement(); }
    function renderProjectLegend() { 
      const assignments = data.memberProjects[selectedMember] || []; 
      const projects = assignments.map(a => getProjectById(typeof a === 'string' ? a : a.id)).filter(Boolean); 
      const hrs = getMemberProjectHours(); 
      document.getElementById('project-legend').innerHTML = `<span class="legend-label">Projects:</span>${!projects.length?'<span style="color:#64748B;font-size:12px;">None assigned</span>':projects.map(p=>`<div class="legend-item"><span class="legend-color" style="background:${getProjectColor(p.id,projects)}"></span><span>${p.name}</span><span class="legend-hours">${hrs[p.id]||0}h</span></div>`).join('')}`; 
    }
    function getMemberProjectHours() { const hrs = {}, ms = data.timeSlots[selectedMember] || {}; Object.values(ms).forEach(ds => Object.values(ds).forEach(pid => { if(pid) hrs[pid] = (hrs[pid]||0)+1; })); return hrs; }
    function getWeekDays() { const days = [], s = new Date(selectedWeek); s.setDate(s.getDate() - s.getDay() + 1); for (let i = 0; i < 5; i++) { const d = new Date(s); d.setDate(d.getDate() + i); days.push(d); } return days; }
    function renderWeekLabel() { const wd = getWeekDays(); document.getElementById('week-label').textContent = `${wd[0].toLocaleDateString('en-US',{month:'short',day:'numeric'})} - ${wd[4].toLocaleDateString('en-US',{month:'short',day:'numeric'})}`; }
    function changeWeek(delta) { selectedWeek.setDate(selectedWeek.getDate() + delta * 7); renderTimeManagement(); }
    function renderCalendar() {
      const wd = getWeekDays(), hrs = [8,9,10,11,12,13,14,15,16,17];
      const assignments = data.memberProjects[selectedMember] || [];
      const projects = assignments.map(a => getProjectById(typeof a === 'string' ? a : a.id)).filter(Boolean);
      let html = '<div class="calendar-header"><div class="time-col">Time</div>';
      wd.forEach(d => { html += `<div class="day-col"><div class="day-name">${d.toLocaleDateString('en-US',{weekday:'short'})}</div><div class="day-date">${d.getDate()}</div></div>`; });
      html += '</div><div class="calendar-body">';
      hrs.forEach(h => {
        html += `<div class="calendar-row"><div class="hour-label">${h}:00</div>`;
        wd.forEach(d => {
          const dk = d.toISOString().split('T')[0];
          const sp = data.timeSlots[selectedMember]?.[dk]?.[h];
          html += '<div class="slot-container">';
          if (projects.length) {
            if (sp) { const pr = projects.find(p=>p.id===sp); html += `<div class="slot-filled" style="background:${getProjectColor(sp,projects)}" onclick="toggleSlot('${dk}',${h},'${sp}')">${pr?.name.substring(0,8)||''}</div>`; }
            else { html += '<div class="slot-options">' + projects.map(p=>`<button class="slot-btn" style="background:${getProjectColor(p.id,projects)}20;border-color:${getProjectColor(p.id,projects)}" onclick="toggleSlot('${dk}',${h},'${p.id}')">+</button>`).join('') + '</div>'; }
          } else { html += '<div class="slot-empty">-</div>'; }
          html += '</div>';
        });
        html += '</div>';
      });
      html += '</div>';
      document.getElementById('calendar-grid').innerHTML = html;
    }
    function toggleSlot(dk, h, pid) { if (!data.timeSlots[selectedMember]) data.timeSlots[selectedMember] = {}; if (!data.timeSlots[selectedMember][dk]) data.timeSlots[selectedMember][dk] = {}; data.timeSlots[selectedMember][dk][h] = data.timeSlots[selectedMember][dk][h] === pid ? null : pid; saveData(); renderTimeManagement(); }

    // ==================== MODALS ====================
    function closeModal(type) { document.getElementById('modal-' + type).classList.add('hidden'); }

    // Clear custom PIC input when a member is selected
    function handlePicSelectChange() {
      const picSelect = document.getElementById('task-pic');
      const picCustom = document.getElementById('task-pic-custom');
      if (picSelect.value) {
        picCustom.value = '';
      }
    }

    function openProjectModal() {
      if (!isAdmin()) {
        showToast('Only admin can create projects');
        return;
      }
      document.getElementById('edit-project-id').value = '';
      document.getElementById('project-name').value = '';
      document.getElementById('project-desc-input').value = '';
      document.getElementById('project-priority').value = 'Medium';
      document.getElementById('project-status').value = 'Not Started';
      document.getElementById('project-start').value = new Date().toISOString().split('T')[0];
      document.getElementById('project-end').value = new Date(Date.now() + 30*864e5).toISOString().split('T')[0];
      document.getElementById('project-saving-hours').value = '';
      document.getElementById('project-actual-saving-hours').value = '';
      document.getElementById('brief-content').innerHTML = '';
      document.getElementById('project-modal-title').textContent = 'New Project';
      document.getElementById('delete-project-btn').classList.add('hidden');
      populateTeamDropdown('');
      document.getElementById('modal-project').classList.remove('hidden');
    }

    function openEditProjectModal() {
      if (!isAdmin()) {
        showToast('Only admin can edit project details');
        return;
      }
      const p = getProjectById(currentProjectId);
      if (!p) return;
      document.getElementById('edit-project-id').value = p.id;
      document.getElementById('project-name').value = p.name;
      document.getElementById('project-desc-input').value = p.description || '';
      document.getElementById('project-priority').value = p.priority;
      document.getElementById('project-status').value = p.status;
      document.getElementById('project-start').value = p.startDate || '';
      document.getElementById('project-end').value = p.endDate || '';
      document.getElementById('project-saving-hours').value = p.savingHours || '';
      document.getElementById('project-actual-saving-hours').value = p.actualSavingHours || '';
      document.getElementById('brief-content').innerHTML = p.brief || '';
      document.getElementById('project-modal-title').textContent = 'Edit Project';
      document.getElementById('delete-project-btn').classList.remove('hidden');
      populateTeamDropdown(p.team || '');
      document.getElementById('modal-project').classList.remove('hidden');
    }

    function populateTeamDropdown(selectedTeam) {
      const select = document.getElementById('project-team');
      select.innerHTML = '<option value="">-- Select Team --</option>' + 
        (data.teams || []).map(t => `<option value="${t}" ${t === selectedTeam ? 'selected' : ''}>${t}</option>`).join('');
    }

    function saveNewTeam() {
      const input = document.getElementById('new-team-name');
      const teamName = input.value.trim();
      if (!teamName) { 
        alert('Please enter a team name'); 
        return; 
      }
      if (!data.teams) data.teams = [];
      if (!data.teams.includes(teamName)) {
        data.teams.push(teamName);
        data.teams.sort();
        saveData();
        showToast('Team "' + teamName + '" added!');
      } else {
        showToast('Team already exists');
      }
      populateTeamDropdown(teamName);
      document.getElementById('project-team').value = teamName;
      closeModal('team');
    }

    function saveProject() {
      const id = document.getElementById('edit-project-id').value;
      const name = document.getElementById('project-name').value.trim();
      if (!name) { alert('Name required'); return; }
      const savingHoursVal = document.getElementById('project-saving-hours').value;
      const actualSavingHoursVal = document.getElementById('project-actual-saving-hours').value;
      const projectData = {
        name,
        description: document.getElementById('project-desc-input').value.trim(),
        priority: document.getElementById('project-priority').value,
        status: document.getElementById('project-status').value,
        team: document.getElementById('project-team').value,
        savingHours: savingHoursVal ? parseInt(savingHoursVal) : null,
        actualSavingHours: actualSavingHoursVal ? parseInt(actualSavingHoursVal) : null,
        startDate: document.getElementById('project-start').value,
        endDate: document.getElementById('project-end').value,
        brief: document.getElementById('brief-content').innerHTML
      };
      if (id) { Object.assign(getProjectById(id), projectData); showToast('Updated'); }
      else { const np = { id: generateId(), ...projectData, tasks: [], updates: [] }; data.projects.push(np); data.projectPool.push(np.id); showToast('Created'); }
      saveData(); closeModal('project');
      // Use 'id' to determine if editing existing project or creating new one
      if (id && currentProjectId === id) renderProjectDetail(); else renderDashboard();
    }

    function deleteProjectFromModal() {
      const id = document.getElementById('edit-project-id').value;
      if (!id || !confirm('Delete project?')) return;
      data.projectPool = data.projectPool.filter(pid => pid !== id);
      Object.keys(data.memberProjects).forEach(mid => { 
        data.memberProjects[mid] = data.memberProjects[mid].filter(a => (typeof a === 'string' ? a : a.id) !== id); 
      });
      data.projects = data.projects.filter(p => p.id !== id);
      saveData(); closeModal('project'); currentProjectId = null; showView('dashboard'); showToast('Deleted');
    }

    function deleteCurrentProject() {
      if (!isAdmin()) {
        showToast('Only admin can delete projects');
        return;
      }
      if (!confirm('Delete project?')) return;
      data.projectPool = data.projectPool.filter(id => id !== currentProjectId);
      Object.keys(data.memberProjects).forEach(mid => { 
        data.memberProjects[mid] = data.memberProjects[mid].filter(a => (typeof a === 'string' ? a : a.id) !== currentProjectId); 
      });
      data.projects = data.projects.filter(p => p.id !== currentProjectId);
      saveData(); showView('dashboard'); showToast('Deleted');
    }

    function showAssignModal() {
      // Redirect to the new quick assign modal
      if (currentProjectId) {
        openQuickAssign(currentProjectId);
      }
    }

    // Task Modal - Subtasks handling
    let modalSubtasks = [];

    function openTaskModal(taskId = null) {
      const p = getProjectById(currentProjectId);
      const isTimelineLocked = p.lockedTimeline;

      // Populate PIC dropdown with members
      const picSelect = document.getElementById('task-pic');
      const picCustom = document.getElementById('task-pic-custom');
      picSelect.innerHTML = '<option value="">-- Select PIC --</option>' +
        data.members.map(m => `<option value="${m.id}">${m.avatar} ${m.name}</option>`).join('');

      if (taskId) {
        const t = p.tasks.find(x => x.id === taskId);
        document.getElementById('edit-task-id').value = t.id;
        document.getElementById('task-name').value = t.name;
        document.getElementById('task-start').value = t.start;
        document.getElementById('task-end').value = t.end;

        // Check if PIC is a member ID or custom name
        if (t.pic && getMemberById(t.pic)) {
          picSelect.value = t.pic;
          picCustom.value = '';
        } else if (t.picCustom) {
          picSelect.value = '';
          picCustom.value = t.picCustom;
        } else {
          picSelect.value = '';
          picCustom.value = '';
        }

        document.getElementById('task-progress').value = t.progress;
        document.getElementById('progress-display').textContent = t.progress;
        document.getElementById('task-modal-title').textContent = 'Edit Task';
        modalSubtasks = t.subtasks ? JSON.parse(JSON.stringify(t.subtasks)) : [];
      }
      else {
        document.getElementById('edit-task-id').value = '';
        document.getElementById('task-name').value = '';
        document.getElementById('task-start').value = p.startDate || '';
        document.getElementById('task-end').value = p.startDate || '';
        picSelect.value = '';
        picCustom.value = '';
        document.getElementById('task-progress').value = 0;
        document.getElementById('progress-display').textContent = '0';
        document.getElementById('task-modal-title').textContent = 'Add Task';
        modalSubtasks = [];
      }

      // Disable date fields when timeline is locked (even for admin)
      const startInput = document.getElementById('task-start');
      const endInput = document.getElementById('task-end');
      startInput.disabled = isTimelineLocked;
      endInput.disabled = isTimelineLocked;
      if (isTimelineLocked) {
        startInput.title = 'Timeline is locked - unlock to change dates';
        endInput.title = 'Timeline is locked - unlock to change dates';
        startInput.style.opacity = '0.6';
        endInput.style.opacity = '0.6';
      } else {
        startInput.title = '';
        endInput.title = '';
        startInput.style.opacity = '1';
        endInput.style.opacity = '1';
      }

      renderSubtasksInModal();
      document.getElementById('modal-task').classList.remove('hidden');
    }

    let draggedSubtaskIdx = null;
    let editingSubtaskIdx = null;

    function renderSubtasksInModal() {
      const container = document.getElementById('subtasks-container');
      if (!modalSubtasks.length) {
        container.innerHTML = '<div style="color:#64748B;font-size:12px;padding:8px;">No subtasks yet</div>';
      } else {
        container.innerHTML = modalSubtasks.map((st, idx) => {
          const isEditing = editingSubtaskIdx === idx;
          return `
          <div class="subtask-item" data-subtask-idx="${idx}" draggable="true"
               ondragstart="handleSubtaskDragStart(event, ${idx})"
               ondragend="handleSubtaskDragEnd(event)"
               ondragover="handleSubtaskDragOver(event, ${idx})"
               ondragleave="handleSubtaskDragLeave(event)"
               ondrop="handleSubtaskDrop(event, ${idx})">
            <span class="subtask-drag-handle" title="Drag to reorder">‚ãÆ‚ãÆ</span>
            <input type="checkbox" ${st.done ? 'checked' : ''} onchange="toggleModalSubtask(${idx})">
            ${isEditing ? `
              <input type="text" class="subtask-name-input" id="subtask-edit-input" value="${st.name.replace(/"/g, '&quot;')}"
                     onkeydown="handleSubtaskEditKeydown(event, ${idx})" onblur="saveSubtaskEdit(${idx})">
            ` : `
              <span class="subtask-name ${st.done ? 'completed' : ''}" ondblclick="startEditSubtask(${idx})">${st.name}</span>
              <button class="subtask-edit" onclick="startEditSubtask(${idx})" title="Edit">‚úèÔ∏è</button>
            `}
            <button class="subtask-delete" onclick="deleteModalSubtask(${idx})" title="Delete">√ó</button>
          </div>
        `}).join('');

        // Focus the edit input if editing
        if (editingSubtaskIdx !== null) {
          const input = document.getElementById('subtask-edit-input');
          if (input) {
            input.focus();
            input.select();
          }
        }
      }
      updateProgressFromSubtasks();
    }

    function addSubtaskToModal() {
      const input = document.getElementById('new-subtask-name');
      const name = input.value.trim();
      if (!name) return;
      modalSubtasks.push({ id: generateId(), name, done: false });
      input.value = '';
      editingSubtaskIdx = null;
      renderSubtasksInModal();
    }

    function toggleModalSubtask(idx) {
      modalSubtasks[idx].done = !modalSubtasks[idx].done;
      editingSubtaskIdx = null;
      renderSubtasksInModal();
    }

    function deleteModalSubtask(idx) {
      modalSubtasks.splice(idx, 1);
      editingSubtaskIdx = null;
      renderSubtasksInModal();
    }

    // Subtask drag and drop handlers
    function handleSubtaskDragStart(e, idx) {
      draggedSubtaskIdx = idx;
      e.target.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'move';
      e.dataTransfer.setData('text/plain', idx);
    }

    function handleSubtaskDragEnd(e) {
      e.target.classList.remove('dragging');
      draggedSubtaskIdx = null;
      document.querySelectorAll('.subtask-item.drag-over').forEach(el => el.classList.remove('drag-over'));
    }

    function handleSubtaskDragOver(e, idx) {
      e.preventDefault();
      e.dataTransfer.dropEffect = 'move';
      if (draggedSubtaskIdx !== null && draggedSubtaskIdx !== idx) {
        e.currentTarget.classList.add('drag-over');
      }
    }

    function handleSubtaskDragLeave(e) {
      if (!e.currentTarget.contains(e.relatedTarget)) {
        e.currentTarget.classList.remove('drag-over');
      }
    }

    function handleSubtaskDrop(e, targetIdx) {
      e.preventDefault();
      e.currentTarget.classList.remove('drag-over');

      const sourceIdx = draggedSubtaskIdx !== null ? draggedSubtaskIdx : parseInt(e.dataTransfer.getData('text/plain'));
      if (sourceIdx === targetIdx || isNaN(sourceIdx)) return;

      // Reorder the subtasks array
      const [movedSubtask] = modalSubtasks.splice(sourceIdx, 1);
      modalSubtasks.splice(targetIdx, 0, movedSubtask);

      editingSubtaskIdx = null;
      renderSubtasksInModal();
    }

    // Subtask edit handlers
    function startEditSubtask(idx) {
      editingSubtaskIdx = idx;
      renderSubtasksInModal();
    }

    function saveSubtaskEdit(idx) {
      const input = document.getElementById('subtask-edit-input');
      if (input) {
        const newName = input.value.trim();
        if (newName && modalSubtasks[idx]) {
          modalSubtasks[idx].name = newName;
        }
      }
      editingSubtaskIdx = null;
      renderSubtasksInModal();
    }

    function handleSubtaskEditKeydown(e, idx) {
      if (e.key === 'Enter') {
        e.preventDefault();
        saveSubtaskEdit(idx);
      } else if (e.key === 'Escape') {
        e.preventDefault();
        editingSubtaskIdx = null;
        renderSubtasksInModal();
      }
    }

    function updateProgressFromSubtasks() {
      if (modalSubtasks.length === 0) {
        document.getElementById('task-progress').value = 0;
        document.getElementById('progress-display').textContent = '0';
        return;
      }
      const completed = modalSubtasks.filter(st => st.done).length;
      const progress = Math.round((completed / modalSubtasks.length) * 100);
      document.getElementById('task-progress').value = progress;
      document.getElementById('progress-display').textContent = progress;
    }

    // Toggle subtask list expansion in Gantt view
    function toggleSubtaskExpand(taskId) {
      const list = document.getElementById('subtask-list-' + taskId);
      const arrow = document.querySelector(`.gantt-task-row-wrapper[data-task-id="${taskId}"] .subtask-expand`);
      if (list) {
        const isHidden = list.style.display === 'none';
        list.style.display = isHidden ? 'block' : 'none';
        if (arrow) arrow.classList.toggle('expanded', isHidden);
      }
    }

    // Toggle subtask done status directly from Gantt view
    function toggleSubtaskDone(taskId, subtaskIdx) {
      const p = getProjectById(currentProjectId);
      const t = p.tasks.find(x => x.id === taskId);
      if (!t || !t.subtasks || !t.subtasks[subtaskIdx]) return;

      // Toggle subtask done status
      t.subtasks[subtaskIdx].done = !t.subtasks[subtaskIdx].done;

      // Recalculate progress based on subtasks
      const completed = t.subtasks.filter(st => st.done).length;
      t.progress = Math.round((completed / t.subtasks.length) * 100);

      saveData();
      renderGantt(document.getElementById('tab-content'));
      showToast(t.subtasks[subtaskIdx].done ? 'Subtask completed' : 'Subtask unchecked');
    }

    function editTask(tid) {
      const p = getProjectById(currentProjectId);
      const t = p.tasks.find(x => x.id === tid);
      // When timeline is locked, still allow opening modal to edit name/subtasks
      // But for non-admin with locked task (individual), block completely
      if (!isAdmin() && t?.locked) {
        showToast('This task is locked');
        return;
      }
      openTaskModal(tid);
    }

    function saveTask() {
      const id = document.getElementById('edit-task-id').value;
      const name = document.getElementById('task-name').value.trim();
      if (!name) { alert('Name required'); return; }
      const progress = parseInt(document.getElementById('task-progress').value);
      const p = getProjectById(currentProjectId);

      // When timeline is locked, preserve existing dates
      let startDate = document.getElementById('task-start').value;
      let endDate = document.getElementById('task-end').value;
      if (p.lockedTimeline && id) {
        const existingTask = p.tasks.find(x => x.id === id);
        if (existingTask) {
          startDate = existingTask.start;
          endDate = existingTask.end;
        }
      }

      const picMemberId = document.getElementById('task-pic').value || null;
      const picCustomName = document.getElementById('task-pic-custom').value.trim() || null;

      // Use member ID if selected, otherwise use custom name
      const pic = picMemberId || null;
      const picCustom = !picMemberId && picCustomName ? picCustomName : null;

      const taskData = {
        name,
        start: startDate,
        end: endDate,
        progress,
        pic,
        picCustom,
        subtasks: modalSubtasks
      };
      if (id) {
        const existingTask = p.tasks.find(x => x.id === id);
        // Preserve locked status
        taskData.locked = existingTask?.locked || false;
        Object.assign(existingTask, taskData);
        showToast('Updated');
      }
      else {
        // New tasks created by user are not locked by default
        taskData.locked = false;
        taskData.createdBy = currentUser ? currentUser.username : null;
        p.tasks.push({ id: generateId(), ...taskData });
        showToast('Added');
      }
      saveData(); closeModal('task'); renderGantt(document.getElementById('tab-content'));
    }
    function deleteTask(tid) {
      const p = getProjectById(currentProjectId);
      if (confirm('Delete task?')) {
        p.tasks = p.tasks.filter(t => t.id !== tid);
        saveData();
        renderGantt(document.getElementById('tab-content'));
        showToast('Deleted');
      }
    }

    // Update task PIC directly from Gantt dropdown
    function updateTaskPic(taskId, value) {
      const p = getProjectById(currentProjectId);
      const task = p.tasks.find(t => t.id === taskId);
      if (!task) return;

      if (value === '__custom__') {
        // Prompt for custom name
        const customName = prompt('Enter custom PIC name:');
        if (customName && customName.trim()) {
          task.pic = null;
          task.picCustom = customName.trim();
          saveData();
          renderGantt(document.getElementById('tab-content'));
          showToast('PIC updated');
        } else {
          // Revert if cancelled - re-render to reset dropdown
          renderGantt(document.getElementById('tab-content'));
        }
      } else if (value) {
        // Member selected
        task.pic = value;
        task.picCustom = null;
        saveData();
        showToast('PIC updated');
      } else {
        // Cleared
        task.pic = null;
        task.picCustom = null;
        saveData();
        showToast('PIC cleared');
      }
    }

    // Update task status directly from Gantt dropdown
    function updateTaskStatus(taskId, status) {
      const p = getProjectById(currentProjectId);
      const task = p.tasks.find(t => t.id === taskId);
      if (!task) return;

      task.status = status;

      // If finished, set progress to 100%
      if (status === 'Finished') {
        task.progress = 100;
      }

      saveData();
      renderGantt(document.getElementById('tab-content'));
      showToast('Status updated to ' + status);
    }

    // Member Modal
    function openMemberModal() { 
      if (!isAdmin()) { showToast('Only admin can add members'); return; }
      document.getElementById('edit-member-id').value = ''; document.getElementById('member-name').value = ''; document.getElementById('member-role').value = ''; document.getElementById('member-avatar').value = 'üë®‚Äçüíª'; document.getElementById('member-color').value = '#3B82F6'; document.getElementById('member-modal-title').textContent = 'Add Member'; document.getElementById('modal-member').classList.remove('hidden'); 
    }
    function editMember(mid) { 
      if (!isAdmin()) { showToast('Only admin can edit members'); return; }
      const m = getMemberById(mid); if (!m) return; document.getElementById('edit-member-id').value = m.id; document.getElementById('member-name').value = m.name; document.getElementById('member-role').value = m.role; document.getElementById('member-avatar').value = m.avatar; document.getElementById('member-color').value = m.color; document.getElementById('member-modal-title').textContent = 'Edit Member'; document.getElementById('modal-member').classList.remove('hidden'); 
    }
    function saveMember() {
      if (!isAdmin()) { showToast('Only admin can save members'); return; }
      const id = document.getElementById('edit-member-id').value;
      const name = document.getElementById('member-name').value.trim();
      if (!name) { alert('Name required'); return; }
      const memberData = { name, role: document.getElementById('member-role').value.trim() || 'Member', avatar: document.getElementById('member-avatar').value, color: document.getElementById('member-color').value };
      if (id) { Object.assign(getMemberById(id), memberData); showToast('Updated'); }
      else { const nm = { id: generateId(), ...memberData }; data.members.push(nm); data.timeSlots[nm.id] = {}; showToast('Added'); }
      saveData(); closeModal('member'); renderDashboard();
    }
    function deleteMember(mid) { 
      if (!isAdmin()) { showToast('Only admin can delete members'); return; } 
      if (confirm('Delete member?')) { 
        const assigned = data.memberProjects[mid] || []; 
        // Handle both old (string) and new (object) formats
        const projectIds = assigned.map(a => typeof a === 'string' ? a : a.id);
        // Return projects to pool that are not assigned to anyone else
        projectIds.forEach(pid => {
          let stillAssigned = false;
          Object.keys(data.memberProjects).forEach(otherId => {
            if (otherId !== mid) {
              const otherAssignments = data.memberProjects[otherId] || [];
              if (otherAssignments.some(a => (typeof a === 'string' ? a : a.id) === pid)) {
                stillAssigned = true;
              }
            }
          });
          if (!stillAssigned && !data.projectPool.includes(pid)) {
            data.projectPool.push(pid);
          }
        });
        delete data.memberProjects[mid]; 
        delete data.timeSlots[mid]; 
        data.members = data.members.filter(m => m.id !== mid); 
        if (selectedMember === mid) selectedMember = data.members[0]?.id || null; 
        saveData(); 
        renderDashboard(); 
        showToast('Deleted'); 
      } 
    }

    // ==================== USER MANAGEMENT ====================
    function openUsersModal() {
      if (!isAdmin()) { showToast('Only admin can manage users'); return; }
      renderUsersContent();
      document.getElementById('modal-users').classList.remove('hidden');
    }
    
    function renderUsersContent() {
      const allUsers = getAllUsers();
      let html = `
        <div style="margin-bottom:16px;display:flex;justify-content:space-between;align-items:center;">
          <span style="color:#94A3B8;font-size:12px;">${Object.keys(allUsers).length} users total</span>
          <button class="btn btn-primary btn-sm" onclick="openAddUserModal()">+ Add User</button>
        </div>
        <div style="display:flex;flex-direction:column;gap:8px;">
      `;
      
      // Sort: admins first, then by username
      const sortedUsers = Object.entries(allUsers).sort((a, b) => {
        if (a[1].role === 'admin' && b[1].role !== 'admin') return -1;
        if (a[1].role !== 'admin' && b[1].role === 'admin') return 1;
        return a[0].localeCompare(b[0]);
      });
      
      sortedUsers.forEach(([username, user]) => {
        const member = user.memberId ? getMemberById(user.memberId) : null;
        const isDefault = user.isDefault || DEFAULT_USERS[username];
        
        html += `
          <div style="display:flex;align-items:center;gap:12px;padding:12px;background:#334155;border-radius:8px;${user.role==='admin'?'border-left:3px solid #F59E0B;':''}">
            <span style="font-size:24px;">${user.icon || 'üë§'}</span>
            <div style="flex:1;min-width:0;">
              <div style="font-weight:600;display:flex;align-items:center;gap:8px;">
                ${user.name}
                ${user.role === 'admin' ? '<span style="background:#F59E0B;color:#0F172A;font-size:9px;padding:2px 6px;border-radius:4px;">ADMIN</span>' : ''}
                ${isDefault ? '<span style="background:#64748B;color:white;font-size:9px;padding:2px 6px;border-radius:4px;">DEFAULT</span>' : ''}
              </div>
              <div style="font-size:11px;color:#94A3B8;display:flex;gap:12px;margin-top:2px;">
                <span>@${username}</span>
                <span>üîë ${user.password}</span>
                ${member ? `<span style="color:#38BDF8;">üë§ ${member.name}</span>` : ''}
              </div>
            </div>
            <div style="display:flex;gap:4px;">
              ${!isDefault ? `
                <button class="btn btn-secondary btn-icon btn-sm" onclick="openEditUserModal('${username}')" title="Edit">‚úèÔ∏è</button>
                <button class="btn btn-danger btn-icon btn-sm" onclick="deleteUser('${username}')" title="Delete">üóëÔ∏è</button>
              ` : `
                <span style="font-size:10px;color:#64748B;">Protected</span>
              `}
            </div>
          </div>
        `;
      });
      
      html += `</div>
        <div style="margin-top:16px;padding:12px;background:#1E293B;border-radius:8px;font-size:11px;color:#64748B;">
          <div style="font-weight:600;color:#94A3B8;margin-bottom:8px;">üí° Tips:</div>
          <ul style="margin:0;padding-left:20px;">
            <li>Default users (admin, user) cannot be edited or deleted</li>
            <li>Link a user to a team member to show their card first on mobile</li>
            <li>Users can change project status and task progress</li>
            <li>Only admins can edit project details and manage users</li>
          </ul>
        </div>
      `;
      
      document.getElementById('users-content').innerHTML = html;
    }
    
    function openAddUserModal() {
      document.getElementById('edit-user-original-username').value = '';
      document.getElementById('user-username').value = '';
      document.getElementById('user-password').value = '';
      document.getElementById('user-displayname').value = '';
      document.getElementById('user-role').value = 'user';
      document.getElementById('user-icon').value = 'üë§';
      
      // Populate member dropdown
      const memberSelect = document.getElementById('user-member-link');
      memberSelect.innerHTML = '<option value="">-- Not Linked --</option>' + 
        data.members.map(m => `<option value="${m.id}">${m.avatar} ${m.name}</option>`).join('');
      memberSelect.value = '';
      
      document.getElementById('user-edit-title').textContent = 'Add User';
      document.getElementById('modal-user-edit').classList.remove('hidden');
    }
    
    function openEditUserModal(username) {
      const allUsers = getAllUsers();
      const user = allUsers[username];
      if (!user) return;
      
      document.getElementById('edit-user-original-username').value = username;
      document.getElementById('user-username').value = username;
      document.getElementById('user-password').value = user.password;
      document.getElementById('user-displayname').value = user.name;
      document.getElementById('user-role').value = user.role;
      document.getElementById('user-icon').value = user.icon || 'üë§';
      
      // Populate member dropdown
      const memberSelect = document.getElementById('user-member-link');
      memberSelect.innerHTML = '<option value="">-- Not Linked --</option>' + 
        data.members.map(m => `<option value="${m.id}">${m.avatar} ${m.name}</option>`).join('');
      memberSelect.value = user.memberId || '';
      
      document.getElementById('user-edit-title').textContent = 'Edit User';
      document.getElementById('modal-user-edit').classList.remove('hidden');
    }
    
    function saveUser() {
      const originalUsername = document.getElementById('edit-user-original-username').value;
      const username = document.getElementById('user-username').value.trim().toLowerCase().replace(/[^a-z0-9]/g, '');
      const password = document.getElementById('user-password').value;
      const displayName = document.getElementById('user-displayname').value.trim();
      const role = document.getElementById('user-role').value;
      const icon = document.getElementById('user-icon').value;
      const memberId = document.getElementById('user-member-link').value || null;
      
      // Validation
      if (!username) { alert('Username is required'); return; }
      if (username.length < 3) { alert('Username must be at least 3 characters'); return; }
      if (!password) { alert('Password is required'); return; }
      if (password.length < 4) { alert('Password must be at least 4 characters'); return; }
      if (!displayName) { alert('Display name is required'); return; }
      
      // Check if username already exists (for new users or username change)
      const allUsers = getAllUsers();
      if (username !== originalUsername && allUsers[username]) {
        alert('Username already exists');
        return;
      }
      
      // Cannot override default users
      if (!originalUsername && DEFAULT_USERS[username]) {
        alert('Cannot use this username (reserved)');
        return;
      }
      
      // Initialize users object if needed
      if (!data.users) data.users = {};
      
      // If editing and username changed, delete old entry
      if (originalUsername && originalUsername !== username) {
        delete data.users[originalUsername];
      }
      
      // Save user
      data.users[username] = {
        password,
        name: displayName,
        role,
        icon,
        memberId
      };
      
      saveData();
      closeModal('user-edit');
      renderUsersContent();
      showToast(originalUsername ? 'User updated!' : 'User created!');
    }
    
    function deleteUser(username) {
      if (DEFAULT_USERS[username]) {
        showToast('Cannot delete default users');
        return;
      }
      
      if (!confirm(`Delete user "${username}"?`)) return;
      
      if (data.users && data.users[username]) {
        delete data.users[username];
        saveData();
        renderUsersContent();
        showToast('User deleted!');
      }
    }

    // ==================== BRIEF EDITOR ====================
    function execBriefCmd(cmd) { document.execCommand(cmd, false, null); document.getElementById('brief-content').focus(); }
    function insertLink() { const url = prompt('Enter URL:'); if (url) { document.execCommand('createLink', false, url); } }
    function handleBriefImage(e) { const file = e.target.files[0]; if (file) insertImage(file); e.target.value = ''; }
    function insertImage(file) {
      const reader = new FileReader();
      reader.onload = (e) => {
        const img = document.createElement('img');
        img.src = e.target.result;
        img.style.maxWidth = '100%';
        document.getElementById('brief-content').appendChild(img);
      };
      reader.readAsDataURL(file);
    }

    // Paste handler for images
    document.addEventListener('paste', (e) => {
      const modal = document.getElementById('modal-project');
      if (modal.classList.contains('hidden')) return;
      const items = e.clipboardData?.items;
      if (!items) return;
      for (const item of items) {
        if (item.type.indexOf('image') !== -1) {
          e.preventDefault();
          insertImage(item.getAsFile());
          break;
        }
      }
    });

    // Drag & drop for images
    const dropArea = document.getElementById('image-drop-area');
    dropArea?.addEventListener('dragover', (e) => { e.preventDefault(); dropArea.classList.add('dragover'); });
    dropArea?.addEventListener('dragleave', () => dropArea.classList.remove('dragover'));
    dropArea?.addEventListener('drop', (e) => {
      e.preventDefault();
      dropArea.classList.remove('dragover');
      const files = e.dataTransfer?.files;
      if (files?.length) {
        for (const file of files) {
          if (file.type.startsWith('image/')) insertImage(file);
        }
      }
    });

    // ==================== INIT ====================
    async function initApp() {
      document.getElementById('current-date').textContent = new Date().toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
      
      // Auto-load from cloud on startup
      showLoading('Loading...', 'Connecting to cloud');
      updateSyncStatus('syncing');
      const cloudData = await loadFromCloud(false); // Don't show second spinner
      hideLoading();
      
      if (cloudData) {
        data = cloudData;
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        showToast('Loaded from cloud');
      } else {
        // No cloud data or cloud unavailable, try to sync local data
        const syncSuccess = await syncToCloud(data, false);
        if (!syncSuccess) {
          // Cloud sync failed, fall back to local-only mode
          updateSyncStatus('synced', 'Local');
        }
      }
      
      showView('dashboard');
    }
    
    // Add team button event listener
    document.getElementById('add-team-btn').addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      document.getElementById('new-team-name').value = '';
      document.getElementById('modal-team').classList.remove('hidden');
      setTimeout(() => document.getElementById('new-team-name').focus(), 100);
    });
    
    // Enter key for team input
    document.getElementById('new-team-name').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        saveNewTeam();
      }
    });
    
    // Load cloud data first, then check session
    async function startApp() {
      // Show loading while fetching cloud data for login
      document.getElementById('login-page').classList.add('hidden');
      showLoading('Starting...', 'Loading user data from cloud');

      try {
        // Try to load from cloud first to get latest users
        const cloudData = await loadFromCloud(false, true);
        if (cloudData) {
          data = cloudData;
          localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        }
      } catch (e) {
        console.log('Cloud load failed, using local data:', e);
      }

      hideLoading();
      // Now check session with updated data
      checkSession();
    }

    startApp();
  </script>
</body>
</html>
